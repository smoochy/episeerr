<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Episeerr{% endblock %}</title>
    
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<link href="{{ url_for('static', filename='styles.css') }}" rel="stylesheet">
<link href="{{ url_for('static', filename='sidebar.css') }}" rel="stylesheet">

<!-- Google Fonts for the brand -->
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;800;900&display=swap" rel="stylesheet">

<style>
    /* Sonarr-Style Layout System */
    body {
        margin: 0;
        padding: 0;
        overflow-x: hidden;
    }

    /* Main Layout Container */
    .episeerr-layout {
        display: flex;
        min-height: 100vh;
        width: 100%;
    }

    /* Persistent Sidebar */
    .episeerr-sidebar {
        width: 220px;
        background: var(--sidebar-bg, #1a1d29);
        border-right: 1px solid var(--border-color, #2d3142);
        position: fixed;
        left: 0;
        top: 0;
        bottom: 0;
        overflow-y: auto;
        overflow-x: hidden;
        z-index: 1040;
        transition: transform 0.3s ease-in-out;
    }

    /* Sidebar Logo Header */
    .sidebar-logo {
        padding: 16px 20px;
        border-bottom: 1px solid var(--border-color, #2d3142);
        display: flex;
        align-items: center;
        gap: 12px;
        background: var(--sidebar-header-bg, #151823);
    }

    .sidebar-logo img {
        height: 32px;
        width: auto;
    }

    .sidebar-logo .brand-text {
        font-family: 'Orbitron', sans-serif;
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--brand-color, #6366f1);
        letter-spacing: 1px;
    }

    /* Sidebar Navigation */
    .sidebar-nav {
        padding: 8px 0;
    }

    .sidebar-nav-item {
        padding: 10px 20px;
        color: var(--nav-text, #9ca3af);
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: 10px;
        transition: all 0.2s ease;
        border-left: 3px solid transparent;
    }

    .sidebar-nav-item:hover {
        background: var(--nav-hover-bg, #232736);
        color: var(--nav-hover-text, #fff);
    }

    .sidebar-nav-item.active {
        background: var(--nav-active-bg, #2d3142);
        color: var(--nav-active-text, #6366f1);
        border-left-color: var(--brand-color, #6366f1);
    }

    .sidebar-nav-item i {
        width: 20px;
        text-align: center;
        font-size: 16px;
    }

    /* Sidebar icon images (for dashboard icons) */
    .sidebar-icon-img {
        width: 20px;
        height: 20px;
        object-fit: contain;
        display: inline-block;
        vertical-align: middle;
    }

    /* Expandable Rules Section */
    .sidebar-section {
        margin-top: 8px;
    }

    .sidebar-section-header {
        padding: 10px 20px;
        color: var(--nav-text, #9ca3af);
        text-decoration: none;
        display: flex;
        align-items: center;
        justify-content: space-between;
        cursor: pointer;
        transition: all 0.2s ease;
        border-left: 3px solid transparent;
    }

    .sidebar-section-header:hover {
        background: var(--nav-hover-bg, #232736);
        color: var(--nav-hover-text, #fff);
    }

    .sidebar-section-header.active {
        background: var(--nav-active-bg, #2d3142);
        color: var(--nav-active-text, #6366f1);
    }

    .sidebar-section-header i.fa-chevron-down {
        transition: transform 0.3s ease;
        font-size: 12px;
    }

    .sidebar-section-header.collapsed i.fa-chevron-down {
        transform: rotate(-90deg);
    }

    /* Rules Submenu */
    .sidebar-submenu {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease-in-out;
        background: var(--submenu-bg, #151823);
    }

    .sidebar-submenu.show {
        max-height: 800px; /* Large enough for most rule lists */
    }

    .sidebar-rule-item {
        padding: 8px 20px 8px 45px;
        color: var(--nav-text, #9ca3af);
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
        transition: all 0.2s ease;
        border-left: 3px solid transparent;
    }

    .sidebar-rule-item:hover {
        background: var(--nav-hover-bg, #232736);
        color: var(--nav-hover-text, #fff);
    }

    .sidebar-rule-name {
        flex: 1;
        font-size: 0.9rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .sidebar-rule-badge {
        font-size: 0.65rem;
        padding: 2px 6px;
        border-radius: 10px;
        background: var(--badge-bg, #374151);
        color: var(--badge-text, #d1d5db);
        white-space: nowrap;
    }

    .sidebar-rule-badge.default {
        background: var(--warning-bg, #f59e0b);
        color: var(--warning-text, #000);
    }

    /* Rule Action Buttons */
    .sidebar-rule-actions {
        display: none;
        gap: 4px;
    }

    .sidebar-rule-item:hover .sidebar-rule-actions {
        display: flex;
    }

    .sidebar-rule-btn {
        padding: 2px 6px;
        font-size: 0.7rem;
        background: var(--btn-bg, #374151);
        border: none;
        color: var(--btn-text, #d1d5db);
        border-radius: 3px;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .sidebar-rule-btn:hover {
        background: var(--btn-hover-bg, #4b5563);
        color: var(--btn-hover-text, #fff);
    }

    .sidebar-rule-btn.edit:hover {
        background: var(--primary-color, #6366f1);
    }

    .sidebar-rule-btn.delete:hover {
        background: var(--danger-color, #ef4444);
    }

    /* Divider */
    .sidebar-divider {
        height: 1px;
        background: var(--border-color, #2d3142);
        margin: 8px 0;
    }

    /* Main Content Area */
    .episeerr-main {
        flex: 1;
        margin-left: 220px;
        min-height: 100vh;
        background: var(--main-bg, #0f1419);
        transition: margin-left 0.3s ease-in-out;
    }

    /* Top Action Bar (replaces navbar on desktop) */
    .top-action-bar {
        background: var(--topbar-bg, #1a1d29);
        border-bottom: 1px solid var(--border-color, #2d3142);
        padding: 12px 24px;
        display: flex;
        align-items: center;
        gap: 16px;
        position: sticky;
        top: 0;
        z-index: 1030;
    }

    .top-action-bar .nav-link {
        color: var(--nav-text, #9ca3af);
        text-decoration: none;
        padding: 6px 12px;
        border-radius: 6px;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .top-action-bar .nav-link:hover {
        background: var(--nav-hover-bg, #232736);
        color: var(--nav-hover-text, #fff);
    }

    /* Mobile Styles */
    @media (max-width: 991px) {
        .episeerr-sidebar {
            transform: translateX(-100%);
        }

        .episeerr-sidebar.show {
            transform: translateX(0);
        }

        .episeerr-main {
            margin-left: 0 !important;
            padding-left: 0 !important;
            max-width: 100vw !important;
            overflow-x: hidden !important;
        }
        
        .content-container {
            max-width: 100vw;
            padding: 16px;
        }

        .mobile-navbar {
            display: flex !important;
        }

        .top-action-bar {
            display: none;
        }
    }

    @media (min-width: 992px) {
        .mobile-navbar {
            display: none !important;
        }
    }

    /* Sidebar Backdrop for Mobile */
    .sidebar-backdrop {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1039;
    }

    .sidebar-backdrop.show {
        display: block;
    }

    /* Content Container */
    .content-container {
        padding: 24px;
        max-width: 1920px;
        width: 100%;
        margin: 0 auto;
    }

    /* Desktop: Account for sidebar width to prevent content hiding */
    @media (min-width: 768px) {
        .content-container {
            max-width: calc(100vw - 220px - 48px);
        }
    }

    /* Mobile Hamburger */
    .mobile-navbar {
        background: var(--topbar-bg, #1a1d29);
        border-bottom: 1px solid var(--border-color, #2d3142);
        padding: 12px 16px;
        display: flex;
        align-items: center;
        justify-content: flex-start;
    }

    .hamburger-btn {
        background: none;
        border: none;
        color: var(--nav-text, #9ca3af);
        font-size: 1.5rem;
        cursor: pointer;
        padding: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 8px;
    }

    .hamburger-btn:hover {
        opacity: 0.8;
    }

    .hamburger-btn img {
        display: block;
    }

    /* Theme Section (inline in sidebar) */
    .theme-option {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 8px 20px 8px 45px;     /* matches rule-item indentation */
        cursor: pointer;
        transition: all 0.2s ease;
        color: var(--nav-text, #9ca3af);
    }

    .theme-option:hover {
        background: var(--nav-hover-bg, #232736);
        color: var(--nav-hover-text, #fff);
    }

    .theme-option.active {
        background: var(--nav-active-bg, #2d3142);
        color: var(--nav-active-text, #6366f1);
        font-weight: 500;
        border-left: 3px solid var(--brand-color, #6366f1);
    }

    .theme-preview {
        width: 24px;
        height: 24px;
        border-radius: 4px;
        border: 1px solid var(--border-color, #2d3142);
        flex-shrink: 0;
    }
</style></head>
<body>
    <!-- Mobile Navbar (Hidden on Desktop) -->
    <div class="mobile-navbar">
        <div class="d-flex align-items-center gap-2">
            <button class="hamburger-btn logo-hamburger" id="sidebarToggle">
                <img src="{{ url_for('static', filename='logo.png') }}" alt="Menu" height="40">
            </button>
            <span class="brand-text" style="font-family: 'Orbitron', sans-serif; font-size: 1.25rem; font-weight: 700; color: var(--brand-color, #6366f1);">Episeerr</span>
        </div>
    </div>

<!-- Sidebar Backdrop (Mobile Only) -->
<div class="sidebar-backdrop" id="sidebarBackdrop"></div>

<!-- Main Layout Container -->
<div class="episeerr-layout">
    <!-- Persistent Sidebar -->
    <aside class="episeerr-sidebar" id="episeerrSidebar">
        <!-- Logo Header -->
        <div class="sidebar-logo">
            <img src="{{ url_for('static', filename='logo.png') }}" alt="Episeerr Logo">
            <span class="brand-text">Episeerr</span>
        </div>

        <!-- Navigation -->
        <nav class="sidebar-nav">
            <!-- Dashboard -->
            <a href="{{ url_for('dashboard.dashboard') }}" class="sidebar-nav-item {% if request.endpoint == 'dashboard.dashboard' %}active{% endif %}">
                <i class="fas fa-chart-line"></i>
                <span>Dashboard</span>
            </a>
            <!-- Series (Main Page) -->
            <a href="{{ url_for('series_management') }}" class="sidebar-nav-item {% if request.endpoint == 'series_management' %}active{% endif %}">
                <i class="fas fa-tv"></i>
                <span>Series</span>
            </a>
            
            

            <!-- Rules Section (Expandable) -->
            <div class="sidebar-section">
                <a href="{{ url_for('rules_page') }}" class="sidebar-section-header" id="rulesSectionHeader" style="text-decoration: none;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-list"></i>
                        <span>Rules</span>
                    </div>
                    <i class="fas fa-chevron-down" onclick="event.preventDefault(); event.stopPropagation(); toggleRulesSection();"></i>
                </a>
                
                <div class="sidebar-submenu" id="rulesSubmenu">
                    <!-- Create New Rule -->
                    <a href="{{ url_for('create_rule') }}" class="sidebar-rule-item" style="color: var(--primary-color, #6366f1);">
                        <i class="fas fa-plus-circle me-2"></i>
                        <span class="sidebar-rule-name">Create New Rule</span>
                    </a>
                    
                    <!-- Clean Config -->
                    <a href="{{ url_for('cleanup') }}" class="sidebar-rule-item" style="color: var(--warning-color, #f59e0b);">
                        <i class="fas fa-broom me-2"></i>
                        <span class="sidebar-rule-name">Clean Config</span>
                    </a>
                </div>
            </div>

            <div class="sidebar-divider"></div>

            <!-- Setup -->
            <a href="{{ url_for('setup') }}" class="sidebar-nav-item {% if request.endpoint == 'setup' %}active{% endif %}">
                <i class="fas fa-plug"></i>
                <span>Setup</span>
            </a>

            <!-- Admin -->
            <a href="{{ url_for('scheduler_admin') }}" class="sidebar-nav-item {% if request.endpoint == 'scheduler_admin' %}active{% endif %}">
                <i class="fas fa-sliders-h"></i>
                <span>Admin</span>
            </a>

            <!-- Documentation -->
            <a href="{{ url_for('documentation') }}" class="sidebar-nav-item {% if request.endpoint == 'documentation' %}active{% endif %}">
                <i class="fas fa-book"></i>
                <span>Documentation</span>
            </a>

            <!-- Pending Items -->
            <a href="{{ url_for('episeerr_index') }}" class="sidebar-nav-item {% if request.endpoint == 'episeerr_index' %}active{% endif %} position-relative">
                <i class="fas fa-bell"></i>
                <span>Pending Items</span>
                <i class="fas fa-exclamation-circle text-warning ms-1" id="notification-bell-sidebar" style="display: none; font-size: 0.8em;"></i>
                <span id="request-count-badge-sidebar" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" style="display: none; font-size: 0.65em; margin-left: -10px;">0</span>
            </a>

            <div class="sidebar-divider"></div>

            <!-- Quick Links Section -->
            <div class="sidebar-section">
                <div class="sidebar-section-header" id="systemSectionHeader">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-link"></i>
                        <span>Quick Links</span>
                    </div>
                    <i class="fas fa-chevron-down"></i>
                </div>
                
                <div class="sidebar-submenu" id="systemSubmenu">
                    <div id="systemLinksContainer"></div>
                </div>
            </div>

            <div class="sidebar-divider"></div>

            <!-- Theme Section (Expandable + Auto-close on select) -->
            <div class="sidebar-section">
                <div class="sidebar-section-header" id="themeSectionHeader">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-palette"></i>
                        <span>Theme</span>
                    </div>
                    <i class="fas fa-chevron-down"></i>
                </div>
                
                <div class="sidebar-submenu" id="themeSubmenu">
                    <div class="theme-option active" data-theme="default">
                        <div class="theme-preview" style="background: linear-gradient(45deg, #0f1419, #6366f1);"></div>
                        <span>Default Dark</span>
                    </div>
                    <div class="theme-option" data-theme="night-owl">
                        <div class="theme-preview" style="background: linear-gradient(45deg, #011627, #82aaff);"></div>
                        <span>Night Owl</span>
                    </div>
                    <div class="theme-option" data-theme="nord">
                        <div class="theme-preview" style="background: linear-gradient(45deg, #2e3440, #88c0d0);"></div>
                        <span>Nord</span>
                    </div>
                    <div class="theme-option" data-theme="light-breeze">
                        <div class="theme-preview" style="background: linear-gradient(45deg, #f8fafc, #3b82f6);"></div>
                        <span>Light Breeze</span>
                    </div>
                </div>
            </div>
        </nav>
    </aside>

    <!-- Main Content Area -->
    <main class="episeerr-main">
        <!-- Top Action Bar (Desktop Only) -->
        <!-- Top Action Bar - Removed theme button, now only in sidebar -->
        <div class="top-action-bar">
            <!-- Theme switcher moved to sidebar only -->
        </div>

        <!-- Page Content -->
        <div class="content-container">
            {% block content %}{% endblock %}
        </div>
    </main>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
// Services injected via Flask context processor (comes from .env / compose env)
window.servicesData = {{ services | tojson }};

// Optional debug (remove later if you want)
// console.log('Loaded services from environment:', window.servicesData);
</script>
<script>

// Theme Management
document.addEventListener('DOMContentLoaded', function() {
    // Load saved theme
    const savedTheme = localStorage.getItem('episeerr-theme') || 'default';
    setTheme(savedTheme);
    updateActiveTheme(savedTheme);
    
    // Initialize sidebar
    initializeSidebar();
    
    // Populate rules in sidebar
    // populateRulesSidebar(); // Disabled - rules shown in main content area
    
    // Populate system links
    populateSystemLinks();

    // Check for pending requests (same as original)
    checkForNewRequests();
});

function setTheme(theme) {
    if (theme === 'default') {
        document.documentElement.removeAttribute('data-theme');
    } else {
        document.documentElement.setAttribute('data-theme', theme);
    }
}

function updateActiveTheme(activeTheme) {
    document.querySelectorAll('.theme-option').forEach(opt => {
        opt.classList.toggle('active', opt.dataset.theme === activeTheme);
    });
}

function initializeSidebar() {
    const sidebar = document.getElementById('episeerrSidebar');
    const backdrop = document.getElementById('sidebarBackdrop');
    const toggleBtn = document.getElementById('sidebarToggle');

    // Mobile toggle
    if (toggleBtn) {
        toggleBtn.addEventListener('click', function() {
            sidebar.classList.toggle('show');
            backdrop.classList.toggle('show');
        });
    }

    // Close on backdrop click
    if (backdrop) {
        backdrop.addEventListener('click', function() {
            sidebar.classList.remove('show');
            backdrop.classList.remove('show');
        });
    }

    // Rules section expand/collapse
    const rulesHeader = document.getElementById('rulesSectionHeader');
    const rulesSubmenu = document.getElementById('rulesSubmenu');
    
    if (rulesHeader && rulesSubmenu) {
        // Load saved state
        const rulesExpanded = localStorage.getItem('sidebar-rules-expanded') !== 'false';
        if (rulesExpanded) {
            rulesSubmenu.classList.add('show');
        } else {
            rulesHeader.classList.add('collapsed');
        }

        rulesHeader.addEventListener('click', function() {
            const isExpanded = rulesSubmenu.classList.toggle('show');
            rulesHeader.classList.toggle('collapsed', !isExpanded);
            localStorage.setItem('sidebar-rules-expanded', isExpanded);
        });
    }

    // System section expand/collapse
    const systemHeader = document.getElementById('systemSectionHeader');
    const systemSubmenu = document.getElementById('systemSubmenu');
    
    if (systemHeader && systemSubmenu) {
        // Load saved state
        const systemExpanded = localStorage.getItem('sidebar-system-expanded') !== 'false';
        if (systemExpanded) {
            systemSubmenu.classList.add('show');
        } else {
            systemHeader.classList.add('collapsed');
        }

        systemHeader.addEventListener('click', function() {
            const isExpanded = systemSubmenu.classList.toggle('show');
            systemHeader.classList.toggle('collapsed', !isExpanded);
            localStorage.setItem('sidebar-system-expanded', isExpanded);
        });
    }

    // Theme section â€“ with auto-collapse on selection
    const themeHeader = document.getElementById('themeSectionHeader');
    const themeSubmenu = document.getElementById('themeSubmenu');
    if (themeHeader && themeSubmenu) {
        // Optional: remember if user wants it open (default closed)
        const expanded = localStorage.getItem('sidebar-theme-expanded') === 'true';
        if (expanded) themeSubmenu.classList.add('show');
        else themeHeader.classList.add('collapsed');

        themeHeader.addEventListener('click', (e) => {
            // Only toggle if not clicking inside a theme option
            if (!e.target.closest('.theme-option')) {
                const isExpanded = themeSubmenu.classList.toggle('show');
                themeHeader.classList.toggle('collapsed', !isExpanded);
                localStorage.setItem('sidebar-theme-expanded', isExpanded);
            }
        });
    }

    // Theme selection with auto-close
    document.querySelectorAll('.theme-option').forEach(option => {
        option.addEventListener('click', function(e) {
            e.stopPropagation(); // prevent header click from toggling

            const theme = this.dataset.theme;
            setTheme(theme);
            localStorage.setItem('episeerr-theme', theme);
            updateActiveTheme(theme);

            // Auto-collapse after selection
            if (themeSubmenu && themeHeader) {
                themeSubmenu.classList.remove('show');
                themeHeader.classList.add('collapsed');
                localStorage.setItem('sidebar-theme-expanded', 'false');
            }
        });
    });
}

// Toggle Rules section
function toggleRulesSection() {
    const rulesSubmenu = document.getElementById('rulesSubmenu');
    const rulesHeader = document.getElementById('rulesSectionHeader');
    const isExpanded = rulesSubmenu.classList.toggle('show');
    rulesHeader.classList.toggle('collapsed', !isExpanded);
    localStorage.setItem('sidebar-rules-expanded', isExpanded);
}

// Populate Rules in Sidebar
function populateRulesSidebar() {
    const container = document.getElementById('rulesListContainer');
    if (!container) return;

    // Fetch rules from API or use page data
    fetch('/api/rules-list')
        .then(response => response.json())
        .then(data => {
            if (data.rules && data.rules.length > 0) {
                container.innerHTML = data.rules.map(rule => {
                    const isDefault = rule.is_default;
                    const badgeHTML = isDefault 
                        ? `<span class="sidebar-rule-badge default"><i class="fas fa-star"></i> Default</span>`
                        : `<span class="sidebar-rule-badge">${rule.series_count}</span>`;
                    
                    return `
                        <div class="sidebar-rule-item">
                            <span class="sidebar-rule-name" title="${rule.description || rule.name}">${rule.display_name}</span>
                            ${badgeHTML}
                            <div class="sidebar-rule-actions">
                                <a href="/edit-rule/${rule.name}" class="sidebar-rule-btn edit" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </a>
                                ${!isDefault ? `
                                    <button class="sidebar-rule-btn delete" onclick="deleteRule('${rule.name}')" title="Delete">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
            } else {
                container.innerHTML = '<div class="sidebar-rule-item text-muted" style="font-size: 0.85rem;">No rules configured</div>';
            }
        })
        .catch(error => {
            console.error('Error loading rules:', error);
            container.innerHTML = '<div class="sidebar-rule-item text-muted" style="font-size: 0.85rem;">Error loading rules</div>';
        });
}

// Populate Quick Links - Load from database
function populateSystemLinks() {
    const container = document.getElementById('systemLinksContainer');
    if (!container) return;

    container.innerHTML = '<div class="sidebar-rule-item text-muted small py-2"><i class="fas fa-spinner fa-spin me-2"></i>Loading...</div>';

    // Fetch both services and custom links
    Promise.all([
        fetch('/api/services-sidebar').then(r => r.json()).catch(() => ({status: 'error', services: []})),
        fetch('/api/quick-links').then(r => r.json()).catch(() => ({status: 'error', links: []}))
    ])
    .then(([servicesData, linksData]) => {
        const allLinks = [];
        const serviceIds = new Set(); // Track IDs to prevent duplicates
        
        // Add configured integration services
        if (servicesData.status === 'success' && servicesData.services) {
            servicesData.services.forEach(service => {
                allLinks.push(service);
                serviceIds.add(service.id); // Track by ID not URL
            });
        }
        
        // Add custom quick links that aren't already in services (by ID)
        if (linksData.status === 'success' && linksData.links) {
            linksData.links.forEach(link => {
                if (!serviceIds.has(link.id)) {
                    allLinks.push(link);
                }
            });
        }
        
        if (allLinks.length > 0) {
            container.innerHTML = allLinks.map(link => {
                const isImageIcon = link.icon && (link.icon.startsWith('http') || link.icon.startsWith('/'));
                const iconHtml = isImageIcon 
                    ? `<img src="${link.icon}" alt="${link.name}" class="sidebar-icon-img" />`
                    : `<i class="${link.icon || 'fas fa-link'}"></i>`;
                
                if (link.open_in_iframe) {
                    // Use the quick link ID route
                    return `
                        <a href="/iframe/${link.id}" class="sidebar-rule-item" title="${link.name}">
                            ${iconHtml}
                            <span class="sidebar-rule-name">${link.name}</span>
                        </a>
                    `;
                } else {
                    return `
                        <a href="${link.url}" target="_blank" class="sidebar-rule-item" title="${link.name}">
                            ${iconHtml}
                            <span class="sidebar-rule-name">${link.name}</span>
                            <i class="fas fa-external-link-alt ms-1" style="font-size: 0.7rem; opacity: 0.6;"></i>
                        </a>
                    `;
                }
            }).join('');
        } else {
            container.innerHTML = `
                <div class="sidebar-rule-item text-muted small py-2">
                    No services configured
                    <a href="/setup" style="color: var(--accent-color);">Configure in Setup</a>
                </div>
            `;
        }
    })
    .catch(err => {
        console.error('Error loading quick links:', err);
        container.innerHTML = '<div class="sidebar-rule-item text-muted small py-2">Error loading links</div>';
    });
}
    
// Delete Rule Function
function deleteRule(ruleName) {
    if (confirm(`Are you sure you want to delete the rule "${ruleName}"?`)) {
        fetch(`/delete-rule/${ruleName}`, {
            method: 'POST'
        })
        .then(response => {
            if (response.ok) {
                window.location.reload();
            } else {
                alert('Error deleting rule');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error deleting rule');
        });
    }
}

// Check for pending requests (same as original)
function checkForNewRequests() {
    let requestCount = 0;
    let deletionCount = 0;
    
    fetch('/api/pending-requests')
        .then(response => response.json())
        .then(data => {
            requestCount = data.success ? data.count : 0;
            return fetch('/api/pending-deletions/count');
        })
        .then(response => response.json())
        .then(data => {
            deletionCount = data.count || 0;
            updatePendingBadge(requestCount, deletionCount);
        })
        .catch(error => console.error('Error checking pending items:', error));
}

function updatePendingBadge(requestCount, deletionCount) {
    const bellSidebar = document.getElementById('notification-bell-sidebar');
    const badgeSidebar = document.getElementById('request-count-badge-sidebar');
    const totalCount = requestCount + deletionCount;
    
    if (totalCount > 0) {
        if (bellSidebar) bellSidebar.style.display = 'inline';
        if (badgeSidebar) {
            badgeSidebar.textContent = totalCount;
            badgeSidebar.style.display = 'inline-block';
        }
        
        if (!window.location.pathname.includes('/episeerr')) {
            document.title = `(${totalCount}) ${document.title.replace(/^\(\d+\)\s*/, '')}`;
        }
    } else {
        if (bellSidebar) bellSidebar.style.display = 'none';
        if (badgeSidebar) badgeSidebar.style.display = 'none';
        document.title = document.title.replace(/^\(\d+\)\s*/, '');
    }
}

// Check every 30 seconds
setInterval(checkForNewRequests, 30000);
document.addEventListener('DOMContentLoaded', checkForNewRequests);
</script>

{% block extra_js %}{% endblock %}</body>
</html>