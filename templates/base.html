<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Episeerr{% endblock %}</title>
    
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<link href="{{ url_for('static', filename='styles.css') }}" rel="stylesheet">
<link href="{{ url_for('static', filename='sidebar.css') }}" rel="stylesheet">

<!-- Google Fonts for the brand -->
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;800;900&display=swap" rel="stylesheet">

<style>
    /* Sonarr-Style Layout System */
    body {
        margin: 0;
        padding: 0;
        overflow-x: hidden;
    }

    /* Main Layout Container */
    .episeerr-layout {
        display: flex;
        min-height: 100vh;
        width: 100%;
    }

    /* Persistent Sidebar */
    .episeerr-sidebar {
        width: 220px;
        background: var(--sidebar-bg, #1a1d29);
        border-right: 1px solid var(--border-color, #2d3142);
        position: fixed;
        left: 0;
        top: 0;
        bottom: 0;
        overflow-y: auto;
        overflow-x: hidden;
        z-index: 1040;
        transition: transform 0.3s ease-in-out;
    }

    /* Sidebar Logo Header */
    .sidebar-logo {
        padding: 16px 20px;
        border-bottom: 1px solid var(--border-color, #2d3142);
        display: flex;
        align-items: center;
        gap: 12px;
        background: var(--sidebar-header-bg, #151823);
    }

    .sidebar-logo img {
        height: 32px;
        width: auto;
    }

    .sidebar-logo .brand-text {
        font-family: 'Orbitron', sans-serif;
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--brand-color, #6366f1);
        letter-spacing: 1px;
    }

    /* Sidebar Navigation */
    .sidebar-nav {
        padding: 8px 0;
    }

    .sidebar-nav-item {
        padding: 10px 20px;
        color: var(--nav-text, #9ca3af);
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: 10px;
        transition: all 0.2s ease;
        border-left: 3px solid transparent;
    }

    .sidebar-nav-item:hover {
        background: var(--nav-hover-bg, #232736);
        color: var(--nav-hover-text, #fff);
    }

    .sidebar-nav-item.active {
        background: var(--nav-active-bg, #2d3142);
        color: var(--nav-active-text, #6366f1);
        border-left-color: var(--brand-color, #6366f1);
    }

    .sidebar-nav-item i {
        width: 20px;
        text-align: center;
        font-size: 16px;
    }

    /* Sidebar icon images (for dashboard icons) */
    .sidebar-icon-img {
        width: 20px;
        height: 20px;
        object-fit: contain;
        display: inline-block;
        vertical-align: middle;
    }

    /* Expandable Rules Section */
    .sidebar-section {
        margin-top: 8px;
    }

    .sidebar-section-header {
        padding: 10px 20px;
        color: var(--nav-text, #9ca3af);
        text-decoration: none;
        display: flex;
        align-items: center;
        justify-content: space-between;
        cursor: pointer;
        transition: all 0.2s ease;
        border-left: 3px solid transparent;
    }

    .sidebar-section-header:hover {
        background: var(--nav-hover-bg, #232736);
        color: var(--nav-hover-text, #fff);
    }

    .sidebar-section-header.active {
        background: var(--nav-active-bg, #2d3142);
        color: var(--nav-active-text, #6366f1);
    }

    .sidebar-section-header i.fa-chevron-down {
        transition: transform 0.3s ease;
        font-size: 12px;
    }

    .sidebar-section-header.collapsed i.fa-chevron-down {
        transform: rotate(-90deg);
    }

    /* Rules Submenu */
    .sidebar-submenu {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease-in-out;
        background: var(--submenu-bg, #151823);
    }

    .sidebar-submenu.show {
        max-height: 800px; /* Large enough for most rule lists */
    }

    .sidebar-rule-item {
        padding: 8px 20px 8px 45px;
        color: var(--nav-text, #9ca3af);
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
        transition: all 0.2s ease;
        border-left: 3px solid transparent;
    }

    .sidebar-rule-item:hover {
        background: var(--nav-hover-bg, #232736);
        color: var(--nav-hover-text, #fff);
    }

    .sidebar-rule-name {
        flex: 1;
        font-size: 0.9rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .sidebar-rule-badge {
        font-size: 0.65rem;
        padding: 2px 6px;
        border-radius: 10px;
        background: var(--badge-bg, #374151);
        color: var(--badge-text, #d1d5db);
        white-space: nowrap;
    }

    .sidebar-rule-badge.default {
        background: var(--warning-bg, #f59e0b);
        color: var(--warning-text, #000);
    }

    /* Rule Action Buttons */
    .sidebar-rule-actions {
        display: none;
        gap: 4px;
    }

    .sidebar-rule-item:hover .sidebar-rule-actions {
        display: flex;
    }

    .sidebar-rule-btn {
        padding: 2px 6px;
        font-size: 0.7rem;
        background: var(--btn-bg, #374151);
        border: none;
        color: var(--btn-text, #d1d5db);
        border-radius: 3px;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .sidebar-rule-btn:hover {
        background: var(--btn-hover-bg, #4b5563);
        color: var(--btn-hover-text, #fff);
    }

    .sidebar-rule-btn.edit:hover {
        background: var(--primary-color, #6366f1);
    }

    .sidebar-rule-btn.delete:hover {
        background: var(--danger-color, #ef4444);
    }

    /* Divider */
    .sidebar-divider {
        height: 1px;
        background: var(--border-color, #2d3142);
        margin: 8px 0;
    }

    /* Main Content Area */
    .episeerr-main {
        flex: 1;
        margin-left: 220px;
        min-height: 100vh;
        background: var(--main-bg, #0f1419);
        transition: margin-left 0.3s ease-in-out;
    }

    /* Top Action Bar (replaces navbar on desktop) */
    .top-action-bar {
        background: var(--topbar-bg, #1a1d29);
        border-bottom: 1px solid var(--border-color, #2d3142);
        padding: 12px 24px;
        display: flex;
        align-items: center;
        gap: 16px;
        position: sticky;
        top: 0;
        z-index: 1030;
    }

    .top-action-bar .nav-link {
        color: var(--nav-text, #9ca3af);
        text-decoration: none;
        padding: 6px 12px;
        border-radius: 6px;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .top-action-bar .nav-link:hover {
        background: var(--nav-hover-bg, #232736);
        color: var(--nav-hover-text, #fff);
    }

    /* Mobile Styles */
    @media (max-width: 991px) {
        .episeerr-sidebar {
            transform: translateX(-100%);
        }

        .episeerr-sidebar.show {
            transform: translateX(0);
        }

        .episeerr-main {
            margin-left: 0 !important;
            padding-left: 0 !important;
            max-width: 100vw !important;
            overflow-x: hidden !important;
        }
        
        .content-container {
            max-width: 100vw;
            padding: 16px;
        }

        .mobile-navbar {
            display: flex !important;
        }

        .top-action-bar {
            display: none;
        }
    }

    @media (min-width: 992px) {
        .mobile-navbar {
            display: none !important;
        }
    }

    /* Sidebar Backdrop for Mobile */
    .sidebar-backdrop {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1039;
    }

    .sidebar-backdrop.show {
        display: block;
    }

    /* Content Container */
    .content-container {
        padding: 24px;
        max-width: 1920px;
        width: 100%;
        margin: 0 auto;
    }

    /* Desktop: Account for sidebar width to prevent content hiding */
    @media (min-width: 768px) {
        .content-container {
            max-width: calc(100vw - 220px - 48px);
        }
    }

    /* Mobile Hamburger */
    .mobile-navbar {
        background: var(--topbar-bg, #1a1d29);
        border-bottom: 1px solid var(--border-color, #2d3142);
        padding: 12px 16px;
        display: flex;
        align-items: center;
        justify-content: flex-start;
    }

    .hamburger-btn {
        background: none;
        border: none;
        color: var(--nav-text, #9ca3af);
        font-size: 1.5rem;
        cursor: pointer;
        padding: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 8px;
    }

    .hamburger-btn:hover {
        opacity: 0.8;
    }

    .hamburger-btn img {
        display: block;
    }

    /* Theme Section (inline in sidebar) */
    .theme-option {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 8px 20px 8px 45px;     /* matches rule-item indentation */
        cursor: pointer;
        transition: all 0.2s ease;
        color: var(--nav-text, #9ca3af);
    }

    .theme-option:hover {
        background: var(--nav-hover-bg, #232736);
        color: var(--nav-hover-text, #fff);
    }

    .theme-option.active {
        background: var(--nav-active-bg, #2d3142);
        color: var(--nav-active-text, #6366f1);
        font-weight: 500;
        border-left: 3px solid var(--brand-color, #6366f1);
    }

    .theme-preview {
        width: 24px;
        height: 24px;
        border-radius: 4px;
        border: 1px solid var(--border-color, #2d3142);
        flex-shrink: 0;
    }

    /* Sidebar quick-links group headers */
    .sidebar-link-group-header {
        padding: 4px 12px 2px;
        font-size: 0.65rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--text-muted, #6b7280);
        display: flex;
        align-items: center;
        gap: 5px;
    }
    .sidebar-link-group-header i {
        font-size: 0.6rem;
    }
</style></head>
<body>
    <!-- Mobile Navbar (Hidden on Desktop) -->
    <div class="mobile-navbar">
        <div class="d-flex align-items-center gap-2">
            <button class="hamburger-btn logo-hamburger" id="sidebarToggle">
                <img src="{{ url_for('static', filename='logo.png') }}" alt="Menu" height="40">
            </button>
            <span class="brand-text" style="font-family: 'Orbitron', sans-serif; font-size: 1.25rem; font-weight: 700; color: var(--brand-color, #6366f1);">Episeerr</span>
        </div>
    </div>

<!-- Sidebar Backdrop (Mobile Only) -->
<div class="sidebar-backdrop" id="sidebarBackdrop"></div>

<!-- Main Layout Container -->
<div class="episeerr-layout">
    <!-- Persistent Sidebar -->
    <aside class="episeerr-sidebar" id="episeerrSidebar">
        <!-- Logo Header -->
        <div class="sidebar-logo">
            <img src="{{ url_for('static', filename='logo.png') }}" alt="Episeerr Logo">
            <span class="brand-text">Episeerr</span>
        </div>

        <!-- Navigation -->
        <nav class="sidebar-nav">
            <!-- Dashboard -->
            <a href="{{ url_for('dashboard.dashboard') }}" class="sidebar-nav-item {% if request.endpoint == 'dashboard.dashboard' %}active{% endif %}">
                <i class="fas fa-chart-line"></i>
                <span>Dashboard</span>
            </a>
            <!-- Series (Main Page) -->
            <a href="{{ url_for('series_management') }}" class="sidebar-nav-item {% if request.endpoint == 'series_management' %}active{% endif %}">
                <i class="fas fa-tv"></i>
                <span>Series</span>
            </a>
            
            

            <!-- Rules -->
            <a href="{{ url_for('rules_page') }}" class="sidebar-nav-item {% if request.endpoint == 'rules_page' %}active{% endif %}">
                <i class="fas fa-list"></i>
                <span>Rules</span>
            </a>

            <div class="sidebar-divider"></div>

            <!-- Pending Items -->
            <a href="{{ url_for('episeerr_index') }}" class="sidebar-nav-item {% if request.endpoint == 'episeerr_index' %}active{% endif %} position-relative">
                <i class="fas fa-bell"></i>
                <span>Pending Items</span>
                <i class="fas fa-exclamation-circle text-warning ms-1" id="notification-bell-sidebar" style="display: none; font-size: 0.8em;"></i>
                <span id="request-count-badge-sidebar" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" style="display: none; font-size: 0.65em; margin-left: -10px;">0</span>
            </a>

            <!-- Quick Links Section -->
            <div class="sidebar-section">
                <div class="sidebar-section-header" id="systemSectionHeader">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-link"></i>
                        <span>Quick Links</span>
                    </div>
                    <i class="fas fa-chevron-down"></i>
                </div>
                <div class="sidebar-submenu" id="systemSubmenu">
                    <div id="systemLinksContainer"></div>
                </div>
            </div>

            <!-- Containers Section — hidden until Docker is confirmed configured via JS -->
            <div id="containersSidebarWrapper" style="display: none;">
                <div class="sidebar-divider"></div>
                <div class="sidebar-section">
                    <div class="sidebar-section-header collapsed" id="containersSectionHeader">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-cubes"></i>
                            <span>Containers</span>
                        </div>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="sidebar-submenu" id="containersSubmenu">
                        <div id="containersListContainer">
                            <div class="sidebar-rule-item text-muted small py-2">
                                <i class="fas fa-spinner fa-spin me-2"></i>Loading...
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="sidebar-divider"></div>

            <!-- Admin Section (Expandable, collapsed by default) -->
            <div class="sidebar-section">
                <div class="sidebar-section-header collapsed" id="adminSectionHeader">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-cog"></i>
                        <span>Admin</span>
                    </div>
                    <i class="fas fa-chevron-down"></i>
                </div>
                <div class="sidebar-submenu" id="adminSubmenu">
                    <a href="{{ url_for('setup') }}" class="sidebar-rule-item {% if request.endpoint == 'setup' %}active{% endif %}">
                        <i class="fas fa-plug me-2"></i>
                        <span class="sidebar-rule-name">Services</span>
                    </a>
                    <a href="{{ url_for('scheduler_admin') }}" class="sidebar-rule-item {% if request.endpoint == 'scheduler_admin' %}active{% endif %}">
                        <i class="fas fa-sliders-h me-2"></i>
                        <span class="sidebar-rule-name">Settings</span>
                    </a>
                    <a href="{{ url_for('documentation') }}" class="sidebar-rule-item {% if request.endpoint == 'documentation' %}active{% endif %}">
                        <i class="fas fa-book me-2"></i>
                        <span class="sidebar-rule-name">Documentation</span>
                    </a>

                    <!-- Theme nested under Admin -->
                    <div class="sidebar-divider" style="margin: 4px 0;"></div>
                    <div class="sidebar-rule-item" id="themeSubHeader" style="cursor:pointer; justify-content:space-between;" onclick="toggleThemeSection()">
                        <div style="display:flex; align-items:center; gap:8px;">
                            <i class="fas fa-palette me-2"></i>
                            <span class="sidebar-rule-name">Theme</span>
                        </div>
                        <i class="fas fa-chevron-down" id="themeChevron" style="font-size:11px; transition: transform 0.3s;"></i>
                    </div>
                    <div id="themeSubmenu" style="max-height:0; overflow:hidden; transition: max-height 0.3s ease-in-out;">
                        <div class="theme-option active" data-theme="default">
                            <div class="theme-preview" style="background: linear-gradient(45deg, #0f1419, #6366f1);"></div>
                            <span>Default Dark</span>
                        </div>
                        <div class="theme-option" data-theme="night-owl">
                            <div class="theme-preview" style="background: linear-gradient(45deg, #011627, #c792ea);"></div>
                            <span>Night Owl</span>
                        </div>
                        <div class="theme-option" data-theme="nord">
                            <div class="theme-preview" style="background: linear-gradient(45deg, #2e3440, #88c0d0);"></div>
                            <span>Nord</span>
                        </div>
                        <div class="theme-option" data-theme="light-breeze">
                            <div class="theme-preview" style="background: linear-gradient(45deg, #f8fafc, #3b82f6);"></div>
                            <span>Light Breeze</span>
                        </div>
                        <div class="theme-option" data-theme="cyber-neon">
                            <div class="theme-preview" style="background: linear-gradient(45deg, #0a0a1a, #e040e0);"></div>
                            <span>Cyber Neon</span>
                        </div>
                    </div>
                </div>
            </div>

        </nav>
    </aside>

    <!-- Main Content Area -->
    <main class="episeerr-main">
        <!-- Top Action Bar (Desktop Only) -->
        <!-- Top Action Bar - Removed theme button, now only in sidebar -->
        

        <!-- Page Content -->
        <div class="content-container">
            {% block content %}{% endblock %}
        </div>
    </main>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
// Services injected via Flask context processor (comes from .env / compose env)
window.servicesData = {{ services | tojson }};

// Optional debug (remove later if you want)
// console.log('Loaded services from environment:', window.servicesData);
</script>
<script>

// Theme Management
document.addEventListener('DOMContentLoaded', function() {
    // Load saved theme
    const savedTheme = localStorage.getItem('episeerr-theme') || 'default';
    setTheme(savedTheme);
    updateActiveTheme(savedTheme);
    
    // Initialize sidebar
    initializeSidebar();
    
    // Populate system links
    populateSystemLinks();

    // Check for pending requests (same as original)
    checkForNewRequests();
});

function setTheme(theme) {
    if (theme === 'default') {
        document.documentElement.removeAttribute('data-theme');
    } else {
        document.documentElement.setAttribute('data-theme', theme);
    }
}

function updateActiveTheme(activeTheme) {
    document.querySelectorAll('.theme-option').forEach(opt => {
        opt.classList.toggle('active', opt.dataset.theme === activeTheme);
    });
}

function initializeSidebar() {
    const sidebar = document.getElementById('episeerrSidebar');
    const backdrop = document.getElementById('sidebarBackdrop');
    const toggleBtn = document.getElementById('sidebarToggle');

    // Mobile toggle
    if (toggleBtn) {
        toggleBtn.addEventListener('click', function() {
            sidebar.classList.toggle('show');
            backdrop.classList.toggle('show');
        });
    }

    // Close on backdrop click
    if (backdrop) {
        backdrop.addEventListener('click', function() {
            sidebar.classList.remove('show');
            backdrop.classList.remove('show');
        });
    }

    // System section expand/collapse
    const systemHeader = document.getElementById('systemSectionHeader');
    const systemSubmenu = document.getElementById('systemSubmenu');
    
    if (systemHeader && systemSubmenu) {
        // Load saved state
        const systemExpanded = localStorage.getItem('sidebar-system-expanded') !== 'false';
        if (systemExpanded) {
            systemSubmenu.classList.add('show');
        } else {
            systemHeader.classList.add('collapsed');
        }

        systemHeader.addEventListener('click', function() {
            const isExpanded = systemSubmenu.classList.toggle('show');
            systemHeader.classList.toggle('collapsed', !isExpanded);
            localStorage.setItem('sidebar-system-expanded', isExpanded);
        });
    }

    // Admin section (collapsed by default)
    const adminHeader = document.getElementById('adminSectionHeader');
    const adminSubmenu = document.getElementById('adminSubmenu');
    if (adminHeader && adminSubmenu) {
        const expanded = localStorage.getItem('sidebar-admin-expanded') === 'true';
        if (expanded) {
            adminSubmenu.classList.add('show');
            adminHeader.classList.remove('collapsed');
        }
        adminHeader.addEventListener('click', () => {
            const isExpanded = adminSubmenu.classList.toggle('show');
            adminHeader.classList.toggle('collapsed', !isExpanded);
            localStorage.setItem('sidebar-admin-expanded', isExpanded);
        });
    }

    // Containers section — check Docker availability on load, expand if previously open
    const containersHeader = document.getElementById('containersSectionHeader');
    const containersSubmenu = document.getElementById('containersSubmenu');
    if (containersHeader && containersSubmenu) {
        // Always check availability (shows/hides the wrapper)
        populateContainersSidebar();

        const expanded = localStorage.getItem('sidebar-containers-expanded') === 'true';
        if (expanded) {
            containersSubmenu.classList.add('show');
            containersHeader.classList.remove('collapsed');
        }
        containersHeader.addEventListener('click', () => {
            const isExpanded = containersSubmenu.classList.toggle('show');
            containersHeader.classList.toggle('collapsed', !isExpanded);
            localStorage.setItem('sidebar-containers-expanded', isExpanded);
            if (isExpanded) populateContainersSidebar();
        });
    }
}

function toggleThemeSection() {
    const submenu = document.getElementById('themeSubmenu');
    const chevron = document.getElementById('themeChevron');
    if (!submenu) return;
    const isOpen = submenu.style.maxHeight && submenu.style.maxHeight !== '0px';
    submenu.style.maxHeight = isOpen ? '0px' : '300px';
    if (chevron) chevron.style.transform = isOpen ? '' : 'rotate(-180deg)';
    localStorage.setItem('sidebar-theme-expanded', String(!isOpen));
}

// Theme option click — select and auto-close
document.addEventListener('DOMContentLoaded', function() {
    const themeSubmenu = document.getElementById('themeSubmenu');
    if (themeSubmenu && localStorage.getItem('sidebar-theme-expanded') === 'true') {
        themeSubmenu.style.maxHeight = '300px';
        const chevron = document.getElementById('themeChevron');
        if (chevron) chevron.style.transform = 'rotate(-180deg)';
    }

    document.querySelectorAll('.theme-option').forEach(option => {
        option.addEventListener('click', function(e) {
            e.stopPropagation();
            const theme = this.dataset.theme;
            setTheme(theme);
            localStorage.setItem('episeerr-theme', theme);
            updateActiveTheme(theme);
            const sub = document.getElementById('themeSubmenu');
            const chev = document.getElementById('themeChevron');
            if (sub) sub.style.maxHeight = '0px';
            if (chev) chev.style.transform = '';
            localStorage.setItem('sidebar-theme-expanded', 'false');
        });
    });
});
function populateSystemLinks() {
    const container = document.getElementById('systemLinksContainer');
    if (!container) return;

    container.innerHTML = '<div class="sidebar-rule-item text-muted small py-2"><i class="fas fa-spinner fa-spin me-2"></i>Loading...</div>';

    Promise.all([
        fetch('/api/media-server').then(r => r.json()).catch(() => []),
        fetch('/api/optional-integrations').then(r => r.json()).catch(() => []),
        fetch('/api/quick-links').then(r => r.json()).catch(() => ({status: 'error', links: []}))
    ])
    .then(([mediaServer, optionalIntegrations, linksData]) => {
        let html = '';
        // Track rendered URLs to prevent duplicates across all sections
        const shownUrls = new Set();

        // ── Required Services ──────────────────────────────────────────
        const sonarrLink = (linksData.links || []).find(l => l.name === 'Sonarr');
        if (sonarrLink) {
            html += renderSidebarLink(sonarrLink);
            shownUrls.add(sonarrLink.url);
        } else {
            html += `<div class="sidebar-rule-item text-muted small">Sonarr not configured</div>`;
        }

        // ── Media Servers ──────────────────────────────────────────────
        if (mediaServer && mediaServer.length > 0) {
            mediaServer.forEach(server => {
                if (!shownUrls.has(server.url)) {
                    const iconHtml = `<img src="${server.icon}" alt="${server.name}" class="sidebar-icon-img" />`;
                    html += `<a href="${server.url}" target="_blank" class="sidebar-rule-item" title="${server.name}">
                                ${iconHtml}
                                <span class="sidebar-rule-name">${server.name}</span>
                                <i class="fas fa-external-link-alt ms-1" style="font-size:0.7rem;opacity:0.6;"></i>
                             </a>`;
                    shownUrls.add(server.url);
                }
            });
        }

        // ── Optional Integrations ──────────────────────────────────────
        if (optionalIntegrations && optionalIntegrations.length > 0) {
            optionalIntegrations.forEach(integration => {
                if (!shownUrls.has(integration.url)) {
                    html += renderSidebarLink(integration);
                    shownUrls.add(integration.url);
                }
            });
        }

        // ── Custom Bookmarks ───────────────────────────────────────────
        // Exclude system-managed names and any URL already rendered above
        const systemNames = new Set(['Sonarr', 'Tautulli']);
        const customLinks = (linksData.links || []).filter(l =>
            !systemNames.has(l.name) && !shownUrls.has(l.url)
        );
        customLinks.forEach(link => { html += renderSidebarLink(link); });

        container.innerHTML = html || `
            <div class="sidebar-rule-item text-muted small py-2">
                No services configured
                <a href="/setup" style="color: var(--accent-color);">Configure in Setup</a>
            </div>`;
    })
    .catch(err => {
        console.error('Error loading quick links:', err);
        container.innerHTML = '<div class="sidebar-rule-item text-muted small py-2">Error loading links</div>';
    });
}

function renderSidebarLink(link) {
    const isImageIcon = link.icon && (link.icon.startsWith('http') || link.icon.startsWith('/'));
    const iconHtml = isImageIcon
        ? `<img src="${link.icon}" alt="${link.name}" class="sidebar-icon-img" />`
        : `<i class="${link.icon || 'fas fa-link'}"></i>`;
    if (link.open_in_iframe) {
        const href = link.iframe_url || `/iframe/${link.id}`;
        return `<a href="${href}" class="sidebar-rule-item" title="${link.name}">
                    ${iconHtml}
                    <span class="sidebar-rule-name">${link.name}</span>
                </a>`;
    }
    return `<a href="${link.url}" target="_blank" class="sidebar-rule-item" title="${link.name}">
                ${iconHtml}
                <span class="sidebar-rule-name">${link.name}</span>
                <i class="fas fa-external-link-alt ms-1" style="font-size:0.7rem;opacity:0.6;"></i>
            </a>`;
}
    
// Populate Containers in Sidebar
function populateContainersSidebar() {
    const wrapper = document.getElementById('containersSidebarWrapper');
    const container = document.getElementById('containersListContainer');
    if (!container) return;

    container.innerHTML = '<div class="sidebar-rule-item text-muted small py-2"><i class="fas fa-spinner fa-spin me-2"></i>Loading...</div>';

    fetch('/api/docker/media-containers')
        .then(r => r.json())
        .then(data => {
            // Hide entire section if Docker not configured
            if (!data.available) {
                if (wrapper) wrapper.style.display = 'none';
                return;
            }
            // Show section now that Docker is confirmed available
            if (wrapper) wrapper.style.display = 'block';

            if (!data.containers || data.containers.length === 0) {
                container.innerHTML = '<div class="sidebar-rule-item text-muted small py-2">No media containers found</div>';
                return;
            }
            container.innerHTML = data.containers.map(c => {
                const isRunning = c.status === 'running';
                const statusDot = `<span style="
                    width:8px; height:8px; border-radius:50%; flex-shrink:0;
                    background:${isRunning ? '#22c55e' : '#ef4444'};
                    display:inline-block;"></span>`;
                return `
                    <div class="sidebar-rule-item" style="justify-content: space-between;">
                        <div style="display:flex; align-items:center; gap:6px; overflow:hidden;">
                            ${statusDot}
                            <span class="sidebar-rule-name" title="${c.name}">${c.name}</span>
                        </div>
                        <div style="display:flex; gap:4px; flex-shrink:0;">
                            ${isRunning
                                ? `<button class="sidebar-rule-btn" onclick="containerAction('${c.id}','restart')" title="Restart"><i class="fas fa-redo"></i></button>
                                   <button class="sidebar-rule-btn delete" onclick="containerAction('${c.id}','stop')" title="Stop"><i class="fas fa-stop"></i></button>`
                                : `<button class="sidebar-rule-btn edit" onclick="containerAction('${c.id}','start')" title="Start"><i class="fas fa-play"></i></button>`
                            }
                        </div>
                    </div>`;
            }).join('');
        })
        .catch(() => {
            // On error, hide the section silently
            if (wrapper) wrapper.style.display = 'none';
        });
}

function containerAction(containerId, action) {
    fetch(`/api/docker/container/${containerId}/${action}`, { method: 'POST' })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                setTimeout(populateContainersSidebar, 1500); // refresh after action settles
            } else {
                alert(`Action failed: ${data.error || 'Unknown error'}`);
            }
        })
        .catch(() => alert('Docker request failed'));
}

// Delete Rule Function
function deleteRule(ruleName) {
    if (confirm(`Are you sure you want to delete the rule "${ruleName}"?`)) {
        fetch(`/delete-rule/${ruleName}`, {
            method: 'POST'
        })
        .then(response => {
            if (response.ok) {
                window.location.reload();
            } else {
                alert('Error deleting rule');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error deleting rule');
        });
    }
}

// Check for pending requests (same as original)
function checkForNewRequests() {
    let requestCount = 0;
    let deletionCount = 0;
    
    fetch('/api/pending-requests')
        .then(response => response.json())
        .then(data => {
            requestCount = data.success ? data.count : 0;
            return fetch('/api/pending-deletions/count');
        })
        .then(response => response.json())
        .then(data => {
            deletionCount = data.count || 0;
            updatePendingBadge(requestCount, deletionCount);
        })
        .catch(error => console.error('Error checking pending items:', error));
}

function updatePendingBadge(requestCount, deletionCount) {
    const bellSidebar = document.getElementById('notification-bell-sidebar');
    const badgeSidebar = document.getElementById('request-count-badge-sidebar');
    const totalCount = requestCount + deletionCount;
    
    if (totalCount > 0) {
        if (bellSidebar) bellSidebar.style.display = 'inline';
        if (badgeSidebar) {
            badgeSidebar.textContent = totalCount;
            badgeSidebar.style.display = 'inline-block';
        }
        
        if (!window.location.pathname.includes('/episeerr')) {
            document.title = `(${totalCount}) ${document.title.replace(/^\(\d+\)\s*/, '')}`;
        }
    } else {
        if (bellSidebar) bellSidebar.style.display = 'none';
        if (badgeSidebar) badgeSidebar.style.display = 'none';
        document.title = document.title.replace(/^\(\d+\)\s*/, '');
    }
}

// Check every 30 seconds
setInterval(checkForNewRequests, 30000);
document.addEventListener('DOMContentLoaded', checkForNewRequests);
</script>

{% block extra_js %}{% endblock %}</body>
</html>