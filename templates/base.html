<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}OCDarr{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #1a1a1a;
            color: #e0e0e0;
        }
        .navbar {
            background-color: #2d2d2d !important;
        }
        .card {
            background-color: #2d2d2d;
            border: 1px solid #404040;
        }
        .table-dark {
            --bs-table-bg: #2d2d2d;
        }
        .btn-primary {
            background-color: #0d6efd;
            border-color: #0d6efd;
        }
        .form-control, .form-select {
            background-color: #404040;
            border-color: #606060;
            color: #e0e0e0;
        }
        .form-control:focus, .form-select:focus {
            background-color: #404040;
            border-color: #0d6efd;
            color: #e0e0e0;
            box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
        }
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            cursor: default;
            user-select: none;
        }
        .stats-card .card-body {
            text-align: center;
            padding: 1rem;
        }
        .stats-card h5 {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            opacity: 0.9;
        }
        .stats-card h2 {
            font-size: 2rem;
            font-weight: 700;
            margin: 0;
            line-height: 1;
        }
        .rule-badge {
            font-size: 0.75rem;
        }
        
        /* Stats cards grid layout - mobile 2x2, desktop 4 in a row */
        .stats-row {
            display: grid !important;
            grid-template-columns: repeat(2, 1fr) !important;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }
        
        @media (min-width: 768px) {
            .stats-row {
                grid-template-columns: repeat(4, 1fr) !important;
            }
        }
        
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            cursor: default;
            user-select: none;
            width: 100% !important;
            height: 100%;
        }
        
        .stats-card .card-body {
            text-align: center;
            padding: 1rem;
        }
        
        .stats-card h5 {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            opacity: 0.9;
        }
        
        .stats-card h2 {
            font-size: 2rem;
            font-weight: 700;
            margin: 0;
            line-height: 1;
        }
        
        /* Mobile optimizations */
        @media (max-width: 767px) {
            .stats-card .card-body {
                padding: 0.75rem;
            }
            .stats-card h5 {
                font-size: 0.8rem;
                margin-bottom: 0.25rem;
            }
            .stats-card h2 {
                font-size: 1.5rem;
            }
            .container {
                padding-left: 0.75rem;
                padding-right: 0.75rem;
            }
            .table-responsive {
                font-size: 0.85rem;
            }
            .btn-group {
                flex-wrap: wrap;
            }
            .btn-group .btn {
                font-size: 0.8rem;
                padding: 0.25rem 0.5rem;
            }
        }
        
        /* Desktop: 4 cards in a row */
        @media (min-width: 769px) {
            .stats-row {
                grid-template-columns: 1fr 1fr 1fr 1fr;
            }
            .stats-card {
                margin-bottom: 0;
                box-shadow: 0 2px 4px rgba(0,0,0,0.3);
                border-radius: 8px;
            }
        }
        
        /* Prevent stats cards from looking clickable */
        .stats-card:hover {
            transform: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        .stats-card * {
            pointer-events: none;
        }

        /* OCDarr Banner Styles */
        .ocdarr-banner {
            position: relative;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            padding: 12px 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            transition: all 0.3s ease;
            margin-bottom: 15px;
        }

        .banner-content {
            display: flex;
            align-items: center;
            justify-content: center;
            max-width: 1200px;
            margin: 0 auto;
            position: relative;
        }

        .banner-icon {
            font-size: 16px;
            margin-right: 10px;
            font-weight: bold;
        }

        .banner-message {
            flex: 1;
            text-align: center;
            font-weight: 500;
            font-size: 14px;
        }

        .banner-close {
            position: absolute;
            right: 0;
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.8;
            transition: opacity 0.2s;
            color: inherit;
        }

        .banner-close:hover {
            opacity: 1;
        }

        /* Banner type styles */
        .banner-success {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.95), rgba(21, 128, 61, 0.95));
            color: white;
        }

        .banner-info {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.95), rgba(29, 78, 216, 0.95));
            color: white;
        }

        .banner-warning {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.95), rgba(217, 119, 6, 0.95));
            color: white;
        }

        .banner-error {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.95), rgba(185, 28, 28, 0.95));
            color: white;
        }

        .banner-download {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.95), rgba(109, 40, 217, 0.95));
            color: white;
        }

        .banner-processing {
            background: linear-gradient(135deg, rgba(6, 182, 212, 0.95), rgba(8, 145, 178, 0.95));
            color: white;
        }

        /* Remove the content padding adjustment since banner is no longer fixed */
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('index') }}">
                <img src="{{ url_for('static', filename='ocdarrlogo.png') }}" alt="OCDarr Logo" height="42">
            </a>
            <div class="navbar-nav ms-auto">
               
               <a class="nav-link" href="{{ url_for('scheduler_admin') }}">
                    <i class="fas fa-clock me-1"></i>Scheduler
               </a>
               <a class="nav-link" href="{{ url_for('cleanup') }}">
                    <i class="fas fa-broom me-1"></i>Clean Config
               </a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        {% block content %}{% endblock %}
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    {% block scripts %}{% endblock %}

    <script>
    class OCDarrBanner {
        constructor() {
            this.bannerElement = null;
            this.autoHideTimeout = null;
            this.defaultHideDelay = 5000;
            this.init();
        }

        init() {
            if (!document.querySelector('.ocdarr-banner')) {
                this.createBannerContainer();
            }
            this.checkForServerMessages();
            this.startPeriodicUpdates();
        }

        createBannerContainer() {
            const bannerHtml = `
                <div class="ocdarr-banner" id="ocdarr-banner" style="display: none;">
                    <div class="banner-content">
                        <span class="banner-icon"></span>
                        <span class="banner-message"></span>
                        <button class="banner-close" onclick="ocdarrBanner.hide()">&times;</button>
                    </div>
                </div>
            `;
            // Insert inside container, like the old alert
            const container = document.querySelector('.container.mt-4');
            if (container) {
                container.insertAdjacentHTML('afterbegin', bannerHtml);
            } else {
                document.body.insertAdjacentHTML('afterbegin', bannerHtml);
            }
            this.bannerElement = document.getElementById('ocdarr-banner');
        }

        show(message, type = 'info', autoHide = true, hideDelay = this.defaultHideDelay) {
            if (!this.bannerElement) return;
            
            if (this.autoHideTimeout) {
                clearTimeout(this.autoHideTimeout);
            }
            
            const messageElement = this.bannerElement.querySelector('.banner-message');
            const iconElement = this.bannerElement.querySelector('.banner-icon');
            
            messageElement.textContent = message;
            this.bannerElement.className = `ocdarr-banner banner-${type}`;
            
            const icons = {
                success: 'âœ“',
                info: 'â„¹',
                warning: 'âš ',
                error: 'âœ—',
                download: 'â¬‡',
                processing: 'âš™'
            };
            iconElement.textContent = icons[type] || icons.info;
            
            this.bannerElement.style.display = 'block';
            
            if (autoHide) {
                this.autoHideTimeout = setTimeout(() => {
                    this.hide();
                }, hideDelay);
            }
        }

        hide() {
            if (this.bannerElement) {
                this.bannerElement.style.display = 'none';
            }
            if (this.autoHideTimeout) {
                clearTimeout(this.autoHideTimeout);
                this.autoHideTimeout = null;
            }
        }

        checkForServerMessages() {
            const urlParams = new URLSearchParams(window.location.search);
            const message = urlParams.get('message');
            
            if (message) {
                const decodedMessage = decodeURIComponent(message.replace(/\+/g, ' '));
                
                let type = 'info';
                if (decodedMessage.includes('successfully') || decodedMessage.includes('created') || decodedMessage.includes('updated')) {
                    type = 'success';
                } else if (decodedMessage.includes('error') || decodedMessage.includes('failed')) {
                    type = 'error';
                } else if (decodedMessage.includes('warning')) {
                    type = 'warning';
                }
                
                this.show(decodedMessage, type);
                
                const newUrl = window.location.pathname;
                window.history.replaceState({}, document.title, newUrl);
            }
        }

        async startPeriodicUpdates() {
            setInterval(() => {
                this.checkRecentActivity();
            }, 30000);
        }

        async checkRecentActivity() {
            try {
                const response = await fetch('/api/recent-activity');
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.recentDownloads && data.recentDownloads.length > 0) {
                        const download = data.recentDownloads[0];
                        this.show(
                            `ðŸ“º Downloaded: ${download.series} S${download.season}E${download.episode}`,
                            'download',
                            true,
                            7000
                        );
                    } else if (data.recentRuleApplications && data.recentRuleApplications.length > 0) {
                        const rule = data.recentRuleApplications[0];
                        this.show(
                            `âš™ Applied "${rule.ruleName}" to ${rule.series}`,
                            'processing',
                            true,
                            6000
                        );
                    }
                }
            } catch (error) {
                console.debug('Recent activity check failed:', error);
            }
        }

        showRuleApplied(seriesName, ruleName) {
            this.show(`Rule "${ruleName}" applied to ${seriesName}`, 'success');
        }

        showDownloadStarted(seriesName, episode) {
            this.show(`Download started: ${seriesName} ${episode}`, 'download', true, 8000);
        }

        showProcessingComplete(seriesName, count) {
            this.show(`Processing complete: ${seriesName} (${count} episodes)`, 'success');
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        window.ocdarrBanner = new OCDarrBanner();
    });
    </script>
</body>
</html>