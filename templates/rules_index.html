{% extends "base.html" %}

{% block content %}
<div class="container-fluid">

  <!-- Filters + View Toggle + Selected Count -->
  <div class="series-header mb-3 p-3 bg-dark border border-secondary rounded">
    <div class="row g-3 align-items-end">

      <!-- View Toggle -->
      <div class="col-auto">
        <div class="btn-group" role="group">
          <button type="button" class="btn btn-outline-primary active" id="gridViewBtn" onclick="setView('grid')">
            <i class="fas fa-th"></i> Grid
          </button>
          <button type="button" class="btn btn-outline-primary" id="tableViewBtn" onclick="setView('table')">
            <i class="fas fa-tasks"></i> Manage
          </button>
        </div>
      </div>

      <!-- Search -->
      <div class="col-md-3">
        <div class="input-group input-group-sm">
          <span class="input-group-text bg-dark border-secondary"><i class="fas fa-search text-muted"></i></span>
          <input type="text" id="seriesSearchInput" class="form-control bg-dark text-light border-secondary" placeholder="Search series...">
        </div>
      </div>

      <!-- Rule Filter -->
      <div class="col-md-3">
        <select id="ruleFilterSelect" class="form-select form-select-sm bg-dark text-light border-secondary">
          <option value="">All Rules</option>
          <option value="Unassigned">Unassigned</option>
          {% for rule_name in config.rules.keys() | sort %}
          <option value="{{ rule_name }}">{{ rule_name.replace('_', ' ').title() }}</option>
          {% endfor %}
        </select>
      </div>

      <!-- Status Filter -->
      <div class="col-md-3">
        <select id="statusFilterSelect" class="form-select form-select-sm bg-dark text-light border-secondary">
          <option value="">All Status</option>
          <option value="continuing">Continuing</option>
          <option value="ended">Ended</option>
          <option value="upcoming">Upcoming</option>
        </select>
      </div>

      <!-- Selected Count -->
      <div class="col-auto ms-auto">
        <span class="text-muted small fw-bold" id="selectedCount">0 selected</span>
      </div>

    </div>
  </div>

  <!-- Bulk Actions Bar (appears in table/manage view) -->
  <div class="bulk-actions-bar mb-4 p-3 bg-dark border border-primary rounded" id="bulkActionsBar" style="display: none;">
    <div class="row g-3 align-items-center">
      <div class="col-auto">
        <strong><span id="bulkSelectedCount">0</span> selected</strong>
      </div>
      <div class="col-md-3">
        <select id="bulkRuleSelect" class="form-select form-select-sm bg-dark text-light border-secondary">
          <option value="">Assign to Rule...</option>
          {% for rule_name in config.rules.keys() | sort %}
          <option value="{{ rule_name }}">{{ rule_name.replace('_', ' ').title() }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-auto">
        <button class="btn btn-sm btn-primary" onclick="assignSelected()">
          <i class="fas fa-check me-1"></i> Assign
        </button>
      </div>
      <div class="col-auto">
        <button class="btn btn-sm btn-outline-danger" onclick="unassignSelected()">
          <i class="fas fa-unlink me-1"></i> Unassign
        </button>
      </div>
      <div class="col-auto">
        <button class="btn btn-sm btn-outline-secondary" onclick="clearSelection()">
          <i class="fas fa-ban me-1"></i> Clear
        </button>
      </div>
    </div>
  </div>

  <!-- Grid View -->
  <div id="seriesGridView">
    <div class="row g-3" id="seriesGrid"></div>
  </div>

  <!-- Table View -->
  <div id="seriesTableView" class="table-responsive" style="display: none;">
    <table class="table table-dark table-hover table-sm">
      <thead class="sticky-top bg-dark">
        <tr>
          <th width="50" class="text-center">
            <input type="checkbox" id="select-all-checkbox" onchange="toggleAll()">
          </th>
          <th class="sortable" data-sort="title" style="cursor: pointer;">
            Series <i class="fas fa-sort ms-1"></i>
          </th>
          <th class="sortable" data-sort="rule" style="cursor: pointer;">
            Current Rule <i class="fas fa-sort ms-1"></i>
          </th>
          <th class="sortable" data-sort="status" style="cursor: pointer;">
            Status <i class="fas fa-sort ms-1"></i>
          </th>
        </tr>
      </thead>
      <tbody id="series-table-body"></tbody>
    </table>
  </div>

  <!-- Hidden form for submissions -->
  <form method="POST" action="{{ url_for('assign_rules') }}" id="assignment-form" style="display: none;">
    <input type="hidden" name="rule_name" id="hidden-rule-name">
  </form>

</div>

<style>
/* Series Grid Styles */
.series-grid-col {
  flex: 0 0 auto;
  display: flex;
  justify-content: center; /* Center cards on all screen sizes */
}

@media (min-width: 1600px) { .series-grid-col { width: 12.5%; } }
@media (min-width: 1400px) and (max-width: 1599px) { .series-grid-col { width: 14.285%; } }
@media (min-width: 1200px) and (max-width: 1399px) { .series-grid-col { width: 16.666667%; } }
@media (min-width: 992px) and (max-width: 1199px) { .series-grid-col { width: 20%; } }
@media (min-width: 768px) and (max-width: 991px) { .series-grid-col { width: 25%; } }
@media (min-width: 576px) and (max-width: 767px) { .series-grid-col { width: 33.333333%; } }
@media (max-width: 575px) { .series-grid-col { width: 50%; } }

.series-grid-card {
  background: var(--card-bg, #1a1d29);
  border: 1px solid var(--border-color, #2d3142);
  border-radius: 8px;
  overflow: hidden;
  transition: all 0.2s ease;
  height: 100%;
  width: 100%; /* Fill the flex container */
}

.series-grid-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
  border-color: var(--brand-color, #6366f1);
}

.series-poster-container {
  position: relative;
  width: 100%;
  padding-top: 150%;
  background: var(--poster-bg, #0f1419);
  overflow: hidden;
}

.series-poster {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.series-checkbox-overlay {
  position: absolute;
  top: 8px;
  left: 8px;
  z-index: 10;
}

.series-checkbox-overlay input[type="checkbox"] {
  width: 20px;
  height: 20px;
  cursor: pointer;
}

.series-info {
  padding: 12px;
}

.series-title {
  font-size: 0.95rem;
  font-weight: 600;
  margin-bottom: 8px;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
  text-overflow: ellipsis;
  min-height: 2.8em;
}

.series-badges {
  display: flex;
  flex-wrap: wrap;
  gap: 4px;
}

.series-badge {
  font-size: 0.75rem;
  padding: 2px 8px;
  border-radius: 12px;
}

.badge-rule {
  background: var(--primary-color, #6366f1);
  color: white;
}

.badge-unassigned {
  background: var(--secondary-bg, #6b7280);
  color: white;
}

.badge-continuing {
  background: var(--success-bg, #10b981);
  color: white;
}

.badge-ended {
  background: var(--danger-bg, #ef4444);
  color: white;
}

.badge-upcoming {
  background: var(--info-bg, #3b82f6);
  color: white;
}

.status-continuing { color: #10b981; }
.status-ended { color: #ef4444; }
.status-upcoming { color: #3b82f6; }
</style>
{% endblock %}

{% block extra_js %}
<script>


// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Globals
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const allSeriesData = {{ all_series|tojson|safe }} || [];
let currentView = localStorage.getItem('episeerr-series-view') || 'grid';
let currentSort = { column: 'title', direction: 'asc' };
const SONARR_URL = '{{ SONARR_URL }}';

console.log('Episeerr loaded:', allSeriesData.length, 'series');

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Initialize on page load
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('DOMContentLoaded', () => {
  setView(currentView, false);
  renderView();
  setupEventListeners();
  updateSelectedCount();
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// View Toggle (Grid / Table)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setView(view, save = true) {
  currentView = view;

  document.getElementById('seriesGridView').style.display = view === 'grid' ? 'block' : 'none';
  document.getElementById('seriesTableView').style.display = view === 'table' ? 'block' : 'none';
  document.getElementById('bulkActionsBar').style.display = view === 'table' ? 'block' : 'none';

  document.getElementById('gridViewBtn').classList.toggle('active', view === 'grid');
  document.getElementById('tableViewBtn').classList.toggle('active', view === 'table');

  if (save) localStorage.setItem('episeerr-series-view', view);

  renderView();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Render current view (grid or table)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderView() {
  const filtered = getFilteredAndSortedSeries();

  if (currentView === 'grid') {
    renderGridView(filtered);
  } else {
    renderTableView(filtered);
  }

  updateSelectedCount();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Filter + Sort Logic
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getFilteredAndSortedSeries() {
  let data = [...allSeriesData];

  // Search
  const search = (document.getElementById('seriesSearchInput')?.value || '').toLowerCase().trim();
  if (search) {
    data = data.filter(s => s.title.toLowerCase().includes(search));
  }

  // Rule filter
  const ruleVal = document.getElementById('ruleFilterSelect')?.value;
  if (ruleVal) {
    if (ruleVal === 'Unassigned') {
      data = data.filter(s => !s.assigned_rule || s.assigned_rule === 'None');
    } else {
      data = data.filter(s => s.assigned_rule === ruleVal);
    }
  }

  // Status filter
  const statusVal = document.getElementById('statusFilterSelect')?.value;
  if (statusVal) {
    data = data.filter(s => s.status === statusVal);
  }

  // Sort
  data.sort((a, b) => {
    let va, vb;
    switch (currentSort.column) {
      case 'title':
        va = a.title.toLowerCase();
        vb = b.title.toLowerCase();
        break;
      case 'rule':
        va = (a.assigned_rule || 'zzz').toLowerCase();
        vb = (b.assigned_rule || 'zzz').toLowerCase();
        break;
      case 'status':
        const prio = { continuing: 1, upcoming: 2, ended: 3 };
        va = prio[a.status] || 4;
        vb = prio[b.status] || 4;
        break;
      default: return 0;
    }
    if (typeof va === 'string') {
      return currentSort.direction === 'asc' ? va.localeCompare(vb) : vb.localeCompare(va);
    }
    return currentSort.direction === 'asc' ? va - vb : vb - va;
  });

  return data;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Grid Rendering
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderGridView(series) {
  const container = document.getElementById('seriesGrid');
  if (!container) return;

  if (!series.length) {
    container.innerHTML = '<div class="col-12 text-center py-5 text-muted">No series match your filters</div>';
    return;
  }

  container.innerHTML = series.map(s => {
    const poster = s.images?.find(i => i.coverType === 'poster')?.remoteUrl || '/static/placeholder.png';
    const rule = s.assigned_rule && s.assigned_rule !== 'None'
      ? s.assigned_rule.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())
      : 'Unassigned';
    const ruleCls = rule === 'Unassigned' ? 'badge-unassigned' : 'badge-rule';

    return `
      <div class="col series-grid-col">
        <div class="card series-grid-card">
          <div class="series-poster-container">
            <img src="${poster}" class="series-poster" alt="${s.title}" loading="lazy" onerror="this.src='/static/placeholder.png'">
            
          </div>
          <div class="series-info">
            <div class="series-title">${s.title}</div>
            <div class="series-badges">
              <span class="badge series-badge ${ruleCls}">${rule}</span>
              <span class="badge series-badge badge-${s.status || 'unknown'}">${getStatusText(s)}</span>
            </div>
          </div>
        </div>
      </div>
    `;
  }).join('');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Table Rendering
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderTableView(series) {
  const tbody = document.getElementById('series-table-body');
  if (!tbody) return;

  tbody.innerHTML = '';

  if (!series.length) {
    tbody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-muted">No series match your filters</td></tr>';
    return;
  }

  tbody.innerHTML = series.map(s => {
    const rule = s.assigned_rule && s.assigned_rule !== 'None'
      ? s.assigned_rule.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())
      : 'Unassigned';
    const ruleCls = rule === 'Unassigned' ? 'bg-secondary' : 'bg-primary';

    return `
      <tr>
        <td class="text-center">
          <input type="checkbox" class="series-checkbox" value="${s.id}" onchange="updateSelectedCount()">
        </td>
        <td>
          <a href="${SONARR_URL}/series/${s.titleSlug || encodeURIComponent(s.title)}" target="_blank" class="text-light text-decoration-none">
            ${s.title}
          </a>
        </td>
        <td><span class="badge ${ruleCls}">${rule}</span></td>
        <td><span class="status-${s.status || 'unknown'}">${getStatusText(s)}</span></td>
      </tr>
    `;
  }).join('');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Status Helper
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getStatusText(s) {
  const map = {
    continuing: 'ðŸ“º Continuing',
    ended: 'ðŸ Ended',
    upcoming: 'ðŸ”œ Upcoming'
  };
  return map[s.status] || 'â“ Unknown';
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Selection & Bulk Actions
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateSelectedCount() {
  const count = document.querySelectorAll('.series-checkbox:checked').length;
  document.getElementById('selectedCount').textContent = `${count} selected`;
  document.getElementById('bulkSelectedCount').textContent = count;
  // Bar visibility is controlled by view mode, not selection count
}

function toggleAll() {
  const checked = document.getElementById('select-all-checkbox').checked;
  document.querySelectorAll('.series-checkbox').forEach(cb => cb.checked = checked);
  updateSelectedCount();
}

function clearSelection() {
  document.querySelectorAll('.series-checkbox').forEach(cb => cb.checked = false);
  document.getElementById('select-all-checkbox').checked = false;
  updateSelectedCount();
}

function assignSelected() {
  const rule = document.getElementById('bulkRuleSelect')?.value;
  if (!rule) return alert('Please select a rule to assign to.');

  const ids = Array.from(document.querySelectorAll('.series-checkbox:checked')).map(cb => cb.value);
  if (!ids.length) return alert('No series selected.');

  const form = document.getElementById('assignment-form');
  form.querySelector('[name="rule_name"]').value = rule;

  ids.forEach(id => {
    const inp = document.createElement('input');
    inp.type = 'hidden';
    inp.name = 'series_ids';
    inp.value = id;
    form.appendChild(inp);
  });

  form.submit();
}

function unassignSelected() {
  const ids = Array.from(document.querySelectorAll('.series-checkbox:checked')).map(cb => cb.value);
  if (!ids.length) return alert('No series selected.');
  if (!confirm(`Unassign ${ids.length} series from all rules?`)) return;

  const form = document.createElement('form');
  form.method = 'POST';
  form.action = '{{ url_for("unassign_series") }}';

  ids.forEach(id => {
    const inp = document.createElement('input');
    inp.type = 'hidden';
    inp.name = 'series_ids';
    inp.value = id;
    form.appendChild(inp);
  });

  document.body.appendChild(form);
  form.submit();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Event Listeners
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setupEventListeners() {
  ['seriesSearchInput', 'ruleFilterSelect', 'statusFilterSelect'].forEach(id => {
    const el = document.getElementById(id);
    if (el) {
      if (el.tagName === 'INPUT') el.addEventListener('input', renderView);
      else el.addEventListener('change', renderView);
    }
  });

  document.querySelectorAll('.sortable').forEach(h => {
    h.addEventListener('click', () => {
      const col = h.dataset.sort;
      if (currentSort.column === col) {
        currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
      } else {
        currentSort.column = col;
        currentSort.direction = 'asc';
      }
      renderView();
    });
  });
}
</script>
{% endblock %}