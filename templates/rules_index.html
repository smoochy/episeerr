{% extends "base.html" %}

{% block content %}
<!-- Series Management - Main View -->
<div class="series-header mb-3">
    <div class="row g-3 align-items-center">
        <!-- View Toggle -->
        <div class="col-auto">
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-outline-primary active" id="gridViewBtn" onclick="setView('grid')">
                    <i class="fas fa-th"></i> Grid
                </button>
                <button type="button" class="btn btn-outline-primary" id="tableViewBtn" onclick="setView('table')">
                    <i class="fas fa-list"></i> Table
                </button>
            </div>
        </div>

        <!-- Search -->
        <div class="col-md-3">
            <div class="input-group">
                <span class="input-group-text"><i class="fas fa-search"></i></span>
                <input type="text" class="form-control" id="seriesSearchInput" placeholder="Search series...">
            </div>
        </div>

        <!-- Rule Filter -->
        <div class="col-md-2">
            <select class="form-select" id="ruleFilterSelect">
                <option value="">All Rules</option>
                <option value="Unassigned">Unassigned</option>
                {% for rule_name in config.rules.keys() %}
                <option value="{{ rule_name }}">{{ rule_name.replace('_', ' ').title() }}</option>
                {% endfor %}
            </select>
        </div>

        <!-- Status Filter -->
        <div class="col-md-2">
            <select class="form-select" id="statusFilterSelect">
                <option value="">All Status</option>
                <option value="continuing">Continuing</option>
                <option value="ended">Ended</option>
                <option value="upcoming">Upcoming</option>
            </select>
        </div>

        <!-- Selected Count -->
        <div class="col-md-auto ms-auto">
            <span class="text-muted" id="selectedCount">0 selected</span>
        </div>
    </div>
</div>

<!-- Bulk Actions Bar -->
<div class="bulk-actions-bar mb-3" id="bulkActionsBar" style="display: none;">
    <div class="row g-2 align-items-center">
        <div class="col-auto">
            <strong><span id="bulkSelectedCount">0</span> series selected</strong>
        </div>
        <div class="col-md-3">
            <select class="form-select form-select-sm" id="bulkRuleSelect">
                <option value="">Assign to Rule...</option>
                {% for rule_name in config.rules.keys() %}
                <option value="{{ rule_name }}">{{ rule_name.replace('_', ' ').title() }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-auto">
            <button class="btn btn-primary btn-sm" onclick="assignSelectedSeries()">
                <i class="fas fa-check me-1"></i> Assign
            </button>
        </div>
        <div class="col-auto">
            <button class="btn btn-outline-danger btn-sm" onclick="unassignSelectedSeries()">
                <i class="fas fa-times me-1"></i> Unassign
            </button>
        </div>
        <div class="col-auto">
            <button class="btn btn-outline-secondary btn-sm" onclick="clearSelection()">
                <i class="fas fa-ban me-1"></i> Clear Selection
            </button>
        </div>
    </div>
</div>

<!-- Grid View -->
<div id="seriesGridView" style="display: none;">
    <div class="row g-3" id="seriesGrid">
        <div class="col-12 text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2 text-muted">Loading series...</p>
        </div>
    </div>
</div>

<!-- Table View -->
<div id="seriesTableView" class="table-responsive">
    <table class="table table-hover">
        <thead>
            <tr>
                <th style="width: 40px;">
                    <input type="checkbox" id="select-all-checkbox">
                </th>
                <th class="sortable" data-sort="title" style="cursor: pointer;">
                    Series <i class="fas fa-sort ms-1"></i>
                </th>
                <th class="sortable" data-sort="rule" style="cursor: pointer;">
                    Rule <i class="fas fa-sort ms-1"></i>
                </th>
                <th class="sortable" data-sort="status" style="cursor: pointer;">
                    Status <i class="fas fa-sort ms-1"></i>
                </th>
            </tr>
        </thead>
        <tbody id="series-table-body">
            <tr>
                <td colspan="4" class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2 text-muted">Loading series...</p>
                </td>
            </tr>
        </tbody>
    </table>
</div>

<style>
/* Series Header Bar */
.series-header {
    background: var(--card-bg, #1a1d29);
    padding: 16px 20px;
    border-radius: 8px;
    border: 1px solid var(--border-color, #2d3142);
}

/* Bulk Actions Bar */
.bulk-actions-bar {
    background: var(--sidebar-header-bg, #151823);
    padding: 12px 20px;
    border-radius: 8px;
    border: 1px solid var(--brand-color, #6366f1);
}

/* Grid View Styles */
.series-grid-card {
    background: var(--card-bg, #1a1d29);
    border: 1px solid var(--border-color, #2d3142);
    border-radius: 8px;
    overflow: hidden;
    transition: all 0.2s ease;
    cursor: pointer;
    position: relative;
}

.series-grid-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
    border-color: var(--brand-color, #6366f1);
}

.series-poster-container {
    position: relative;
    width: 100%;
    padding-top: 150%; /* 2:3 aspect ratio */
    background: var(--poster-bg, #0f1419);
    overflow: hidden;
}

.series-poster {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.series-poster-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(to bottom, rgba(0,0,0,0) 0%, rgba(0,0,0,0.8) 100%);
    opacity: 0;
    transition: opacity 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
}

.series-grid-card:hover .series-poster-overlay {
    opacity: 1;
}

.series-checkbox-container {
    position: absolute;
    top: 8px;
    left: 8px;
    z-index: 10;
}

.series-checkbox-container input[type="checkbox"] {
    width: 20px;
    height: 20px;
    cursor: pointer;
}

.series-info {
    padding: 12px;
}

.series-title {
    font-size: 0.95rem;
    font-weight: 600;
    color: var(--text-primary, #fff);
    margin-bottom: 6px;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-overflow: ellipsis;
    min-height: 2.8em;
}

.series-metadata {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-top: 8px;
}

.series-badge {
    font-size: 0.75rem;
    padding: 3px 8px;
    border-radius: 12px;
    background: var(--badge-bg, #374151);
    color: var(--badge-text, #d1d5db);
}

.series-badge.rule {
    background: var(--primary-color, #6366f1);
    color: white;
}

.series-badge.unassigned {
    background: var(--secondary-bg, #6b7280);
}

.series-badge.continuing {
    background: var(--success-bg, #10b981);
    color: white;
}

.series-badge.ended {
    background: var(--danger-bg, #ef4444);
    color: white;
}

/* Responsive Grid */
@media (min-width: 1600px) {
    .series-grid-col { flex: 0 0 12.5%; max-width: 12.5%; }
}
@media (min-width: 1400px) and (max-width: 1599px) {
    .series-grid-col { flex: 0 0 14.285%; max-width: 14.285%; }
}
@media (min-width: 1200px) and (max-width: 1399px) {
    .series-grid-col { flex: 0 0 16.666667%; max-width: 16.666667%; }
}
@media (min-width: 992px) and (max-width: 1199px) {
    .series-grid-col { flex: 0 0 20%; max-width: 20%; }
}
@media (min-width: 768px) and (max-width: 991px) {
    .series-grid-col { flex: 0 0 25%; max-width: 25%; }
}
@media (min-width: 576px) and (max-width: 767px) {
    .series-grid-col { flex: 0 0 33.333333%; max-width: 33.333333%; }
}
@media (max-width: 575px) {
    .series-grid-col { flex: 0 0 50%; max-width: 50%; }
}
</style>

<script>
// Store services data for sidebar (only if they exist)
window.servicesData = {};

{% if SONARR_URL %}
window.servicesData['sonarr'] = {
    'name': 'Sonarr',
    'url': '{{ SONARR_URL }}',
    'icon': 'fas fa-video'
};
{% endif %}

{% if JELLYSEERR_URL %}
window.servicesData['jellyseerr'] = {
    'name': 'Jellyseerr',
    'url': '{{ JELLYSEERR_URL }}',
    'icon': 'fas fa-film'
};
{% endif %}

{% if OVERSEERR_URL %}
window.servicesData['overseerr'] = {
    'name': 'Overseerr',
    'url': '{{ OVERSEERR_URL }}',
    'icon': 'fas fa-film'
};
{% endif %}

{% if JELLYFIN_URL %}
window.servicesData['jellyfin'] = {
    'name': 'Jellyfin',
    'url': '{{ JELLYFIN_URL }}',
    'icon': 'fas fa-play-circle'
};
{% endif %}

{% if PLEX_URL %}
window.servicesData['plex'] = {
    'name': 'Plex',
    'url': '{{ PLEX_URL }}',
    'icon': 'fas fa-server'
};
{% endif %}

{% if TAUTULLI_URL %}
window.servicesData['tautulli'] = {
    'name': 'Tautulli',
    'url': '{{ TAUTULLI_URL }}',
    'icon': 'fas fa-chart-bar'
};
{% endif %}

// Global state
const allSeriesData = {{ all_series|tojson|safe }};
let currentView = localStorage.getItem('episeerr-series-view') || 'grid';
let currentSort = { column: 'title', direction: 'asc' };
const SONARR_URL = '{{ SONARR_URL }}';

console.log('Episeerr loaded:', allSeriesData.length, 'series');
console.log('System Links:', Object.keys(window.servicesData).length, 'services');

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    setView(currentView, false);
    renderView();
    setupEventListeners();
});

function setView(view, save = true) {
    currentView = view;
    const gridView = document.getElementById('seriesGridView');
    const tableView = document.getElementById('seriesTableView');
    const gridBtn = document.getElementById('gridViewBtn');
    const tableBtn = document.getElementById('tableViewBtn');
    
    if (view === 'grid') {
        gridView.style.display = 'block';
        tableView.style.display = 'none';
        gridBtn.classList.add('active');
        tableBtn.classList.remove('active');
    } else {
        gridView.style.display = 'none';
        tableView.style.display = 'block';
        gridBtn.classList.remove('active');
        tableBtn.classList.add('active');
    }
    
    if (save) localStorage.setItem('episeerr-series-view', view);
    renderView();
}

function setupEventListeners() {
    document.getElementById('seriesSearchInput')?.addEventListener('input', renderView);
    document.getElementById('ruleFilterSelect')?.addEventListener('change', renderView);
    document.getElementById('statusFilterSelect')?.addEventListener('change', renderView);
    
    document.getElementById('select-all-checkbox')?.addEventListener('change', function() {
        document.querySelectorAll('.series-checkbox').forEach(cb => cb.checked = this.checked);
        updateSelectedCount();
    });
    
    document.querySelectorAll('.sortable').forEach(header => {
        header.addEventListener('click', function() {
            const sortColumn = this.dataset.sort;
            if (currentSort.column === sortColumn) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.column = sortColumn;
                currentSort.direction = 'asc';
            }
            renderView();
        });
    });
}

function getFilteredAndSortedSeries() {
    let filtered = [...allSeriesData];
    
    const searchTerm = document.getElementById('seriesSearchInput')?.value.toLowerCase() || '';
    if (searchTerm) {
        filtered = filtered.filter(s => s.title.toLowerCase().includes(searchTerm));
    }
    
    const ruleValue = document.getElementById('ruleFilterSelect')?.value || '';
    if (ruleValue) {
        if (ruleValue === 'Unassigned') {
            filtered = filtered.filter(s => !s.assigned_rule || s.assigned_rule === 'None');
        } else {
            filtered = filtered.filter(s => s.assigned_rule === ruleValue);
        }
    }
    
    const statusValue = document.getElementById('statusFilterSelect')?.value || '';
    if (statusValue) {
        filtered = filtered.filter(s => s.status === statusValue);
    }
    
    filtered.sort((a, b) => {
        let aVal, bVal;
        switch(currentSort.column) {
            case 'title':
                aVal = a.title.toLowerCase();
                bVal = b.title.toLowerCase();
                break;
            case 'rule':
                aVal = a.assigned_rule || 'zzz';
                bVal = b.assigned_rule || 'zzz';
                break;
            case 'status':
                aVal = a.status || '';
                bVal = b.status || '';
                break;
            default:
                return 0;
        }
        
        if (aVal < bVal) return currentSort.direction === 'asc' ? -1 : 1;
        if (aVal > bVal) return currentSort.direction === 'asc' ? 1 : -1;
        return 0;
    });
    
    return filtered;
}

function renderView() {
    const series = getFilteredAndSortedSeries();
    if (currentView === 'grid') {
        renderGridView(series);
    } else {
        renderTableView(series);
    }
}

function renderGridView(series) {
    const grid = document.getElementById('seriesGrid');
    if (!grid) return;
    
    if (series.length === 0) {
        grid.innerHTML = '<div class="col-12 text-center py-5 text-muted">No series found</div>';
        return;
    }
    
    grid.innerHTML = series.map(s => {
        const posterUrl = s.images?.find(img => img.coverType === 'poster')?.remoteUrl || '/static/placeholder.png';
        const ruleDisplay = s.assigned_rule && s.assigned_rule !== 'None' 
            ? s.assigned_rule.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())
            : 'Unassigned';
        const statusDisplay = getStatusText(s);
        
        return `
            <div class="col series-grid-col">
                <div class="series-grid-card">
                    <div class="series-checkbox-container">
                        <input type="checkbox" class="series-checkbox" value="${s.id}" onchange="updateSelectedCount()">
                    </div>
                    <div class="series-poster-container">
                        <img class="series-poster" src="${posterUrl}" alt="${s.title}" loading="lazy" onerror="this.src='/static/placeholder.png'">
                        <div class="series-poster-overlay">
                            <a href="${SONARR_URL}/series/${s.titleSlug || ''}" target="_blank" class="btn btn-sm btn-primary">
                                <i class="fas fa-external-link-alt"></i> Sonarr
                            </a>
                        </div>
                    </div>
                    <div class="series-info">
                        <div class="series-title">${s.title}</div>
                        <div class="series-metadata">
                            <span class="series-badge ${s.assigned_rule && s.assigned_rule !== 'None' ? 'rule' : 'unassigned'}">
                                ${ruleDisplay}
                            </span>
                            <span class="series-badge ${s.status || 'unknown'}">
                                ${statusDisplay}
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

function renderTableView(series) {
    const tbody = document.getElementById('series-table-body');
    if (!tbody) return;
    
    if (series.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted py-4">No series found</td></tr>';
        return;
    }
    
    tbody.innerHTML = series.map(s => {
        const ruleText = s.assigned_rule && s.assigned_rule !== 'None' 
            ? s.assigned_rule.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())
            : 'Unassigned';
        const ruleBadgeClass = s.assigned_rule && s.assigned_rule !== 'None' ? 'bg-primary' : 'bg-secondary';
        const statusText = getStatusText(s);
        const statusClass = `status-${s.status || 'unknown'}`;
        
        return `
            <tr>
                <td><input type="checkbox" class="series-checkbox" value="${s.id}" onchange="updateSelectedCount()"></td>
                <td>
                    <a href="${SONARR_URL}/series/${s.titleSlug || ''}" target="_blank" class="text-decoration-none text-light">
                        <strong>${s.title}</strong>
                        <i class="fas fa-external-link-alt ms-1 text-muted" style="font-size: 0.8em;"></i>
                    </a>
                </td>
                <td><span class="badge ${ruleBadgeClass}">${ruleText}</span></td>
                <td>
                    <span class="${statusClass}">${statusText}</span>
                    <br><small class="text-muted">${getStatusDetails(s)}</small>
                </td>
            </tr>
        `;
    }).join('');
}

function getStatusText(series) {
    switch(series.status) {
        case 'continuing': return 'ðŸ“º Continuing';
        case 'ended': return 'ðŸ Ended';
        case 'upcoming': return 'ðŸ”œ Upcoming';
        default: return 'â“ Unknown';
    }
}

function getStatusDetails(series) {
    if (series.lastEpisode) {
        const lastDate = new Date(series.lastEpisode);
        return `Last: ${lastDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}`;
    }
    return series.year ? `Year: ${series.year}` : 'No date info';
}

function updateSelectedCount() {
    const count = document.querySelectorAll('.series-checkbox:checked').length;
    document.getElementById('selectedCount').textContent = `${count} selected`;
    document.getElementById('bulkSelectedCount').textContent = count;
    document.getElementById('bulkActionsBar').style.display = count > 0 ? 'block' : 'none';
}

function clearSelection() {
    document.querySelectorAll('.series-checkbox').forEach(cb => cb.checked = false);
    document.getElementById('select-all-checkbox').checked = false;
    updateSelectedCount();
}

function assignSelectedSeries() {
    const ruleName = document.getElementById('bulkRuleSelect')?.value;
    if (!ruleName) return alert('Please select a rule first');
    
    const selectedIds = Array.from(document.querySelectorAll('.series-checkbox:checked')).map(cb => cb.value);
    if (selectedIds.length === 0) return alert('Please select at least one series');
    
    fetch('/assign-to-rule', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ rule_name: ruleName, series_ids: selectedIds })
    })
    .then(r => r.json())
    .then(data => {
        if (data.status === 'success') window.location.reload();
        else alert('Error: ' + (data.message || 'Unknown error'));
    })
    .catch(e => alert('Error assigning series'));
}

function unassignSelectedSeries() {
    const selectedIds = Array.from(document.querySelectorAll('.series-checkbox:checked')).map(cb => cb.value);
    if (selectedIds.length === 0) return alert('Please select at least one series');
    if (!confirm(`Unassign ${selectedIds.length} series?`)) return;
    
    fetch('/unassign-series', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ series_ids: selectedIds })
    })
    .then(r => r.json())
    .then(data => {
        if (data.status === 'success') window.location.reload();
        else alert('Error: ' + (data.message || 'Unknown error'));
    })
    .catch(e => alert('Error unassigning series'));
}
</script>
{% endblock %}