<!-- templates/setup.html -->
{% extends "base.html" %}

{% block title %}Setup - Episeerr{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <h2><i class="fas fa-plug me-2"></i>Service Setup</h2>
            <p class="text-muted">Connect external services to Episeerr</p>
        </div>
    </div>

    <!-- Setup Status Banner -->
    {% if not setup_complete %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert alert-warning">
                <h5 class="alert-heading"><i class="fas fa-exclamation-triangle me-2"></i>Setup Required</h5>
                <p class="mb-0">Connect Sonarr and a media server (Jellyfin, Emby, or Plex) to get started.</p>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Required Services -->
    <div class="row mb-3">
        <div class="col-12">
            <h4><i class="fas fa-star text-danger me-2"></i>Required Services</h4>
        </div>
    </div>

    <!-- Sonarr Card -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="mb-0">
                            <i class="fas fa-tv me-2"></i>Sonarr
                            {% if sonarr_connected %}
                                <span class="badge bg-success ms-2"><i class="fas fa-check me-1"></i>Connected</span>
                            {% else %}
                                <span class="badge bg-danger ms-2"><i class="fas fa-times me-1"></i>Not Connected</span>
                            {% endif %}
                        </h5>
                        <small class="text-muted">Core TV automation engine</small>
                    </div>
                    <button class="btn btn-primary btn-sm" data-bs-toggle="collapse" data-bs-target="#sonarr-config">
                        <i class="fas fa-cog me-1"></i>Configure
                    </button>
                </div>
                <div id="sonarr-config" class="collapse {% if not sonarr_connected %}show{% endif %}">
                    <div class="card-body">
                        <form id="sonarr-form">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="sonarr-url" class="form-label">Sonarr URL</label>
                                    <input type="url" class="form-control" id="sonarr-url" name="sonarr-url"
                                           placeholder="http://192.168.1.100:8989" 
                                           value="{{ sonarr_url or '' }}" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="sonarr-apikey" class="form-label">API Key</label>
                                    <input type="text" class="form-control" id="sonarr-apikey" name="sonarr-apikey"
                                           placeholder="Sonarr API key" 
                                           value="{{ sonarr_apikey or '' }}" required>
                                    <small class="text-muted">Settings → General → API Key</small>
                                </div>
                            </div>
                            <div class="d-flex justify-content-between">
                                <button type="button" class="btn btn-secondary" onclick="testConnection('sonarr')">
                                    <i class="fas fa-plug me-1"></i>Test Connection
                                </button>
                                <button type="submit" class="btn btn-success">
                                    <i class="fas fa-save me-1"></i>Save
                                </button>
                            </div>
                            <div id="sonarr-test-result" class="mt-3" style="display: none;"></div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Media Server Section -->
    <div class="row mb-3">
        <div class="col-12">
            <h5><i class="fas fa-film me-2"></i>Media Server <small class="text-muted">(Choose One)</small></h5>
        </div>
    </div>

    <!-- Jellyfin -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-0">
                            <i class="fas fa-play-circle me-2"></i>Jellyfin
                            {% if jellyfin_connected %}
                                <span class="badge bg-success ms-2"><i class="fas fa-check me-1"></i>Connected</span>
                            {% else %}
                                <span class="badge bg-secondary ms-2">Not Connected</span>
                            {% endif %}
                        </h6>
                    </div>
                    <button class="btn btn-sm btn-primary" data-bs-toggle="collapse" data-bs-target="#jellyfin-config">
                        <i class="fas fa-cog"></i>
                    </button>
                </div>
                <div id="jellyfin-config" class="collapse">
                    <div class="card-body">
                        <form id="jellyfin-form">
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label for="jellyfin-url" class="form-label">URL</label>
                                    <input type="url" class="form-control" id="jellyfin-url" name="jellyfin-url"
                                           placeholder="http://192.168.1.100:8096" value="{{ jellyfin_url or '' }}">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="jellyfin-apikey" class="form-label">API Key</label>
                                    <input type="text" class="form-control" id="jellyfin-apikey" name="jellyfin-apikey"
                                           placeholder="API Key" value="{{ jellyfin_apikey or '' }}">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="jellyfin-userid" class="form-label">User ID</label>
                                    <input type="text" class="form-control" id="jellyfin-userid" name="jellyfin-userid"
                                           placeholder="Username" value="{{ jellyfin_userid or '' }}">
                                </div>
                            </div>
                            
                            <div class="card bg-dark border-secondary mb-3">
                                <div class="card-body">
                                    <h6><i class="fas fa-satellite-dish me-2"></i>Detection Method</h6>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="radio" name="jellyfin-method" 
                                               id="jellyfin-progress" value="progress" checked>
                                        <label class="form-check-label" for="jellyfin-progress">
                                            <strong>PlaybackProgress</strong> <span class="badge bg-success">Recommended</span>
                                            <br><small class="text-muted">Real-time updates, processes once at 50-55%</small>
                                        </label>
                                    </div>
                                    <div class="row ms-4" id="jellyfin-progress-settings">
                                        <div class="col-md-6 mb-2">
                                            <label for="jellyfin-trigger-min" class="form-label">Min %</label>
                                            <input type="number" class="form-control form-control-sm" 
                                                   id="jellyfin-trigger-min" name="jellyfin-trigger-min"
                                                   value="{{ jellyfin_trigger_min or '50.0' }}" 
                                                   step="0.1" min="0" max="100">
                                        </div>
                                        <div class="col-md-6 mb-2">
                                            <label for="jellyfin-trigger-max" class="form-label">Max %</label>
                                            <input type="number" class="form-control form-control-sm" 
                                                   id="jellyfin-trigger-max" name="jellyfin-trigger-max"
                                                   value="{{ jellyfin_trigger_max or '55.0' }}" 
                                                   step="0.1" min="0" max="100">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="d-flex justify-content-between">
                                <button type="button" class="btn btn-secondary" onclick="testConnection('jellyfin')">
                                    <i class="fas fa-plug me-1"></i>Test
                                </button>
                                <button type="submit" class="btn btn-success">
                                    <i class="fas fa-save me-1"></i>Save
                                </button>
                            </div>
                            <div id="jellyfin-test-result" class="mt-3" style="display: none;"></div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Emby -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-0">
                            <i class="fas fa-play-circle me-2"></i>Emby
                            {% if emby_connected %}
                                <span class="badge bg-success ms-2"><i class="fas fa-check me-1"></i>Connected</span>
                            {% else %}
                                <span class="badge bg-secondary ms-2">Not Connected</span>
                            {% endif %}
                        </h6>
                    </div>
                    <button class="btn btn-sm btn-primary" data-bs-toggle="collapse" data-bs-target="#emby-config">
                        <i class="fas fa-cog"></i>
                    </button>
                </div>
                <div id="emby-config" class="collapse">
                    <div class="card-body">
                        <form id="emby-form">
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label for="emby-url" class="form-label">URL</label>
                                    <input type="url" class="form-control" id="emby-url" name="emby-url"
                                           placeholder="http://192.168.1.100:8096" value="{{ emby_url or '' }}">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="emby-apikey" class="form-label">API Key</label>
                                    <input type="text" class="form-control" id="emby-apikey" name="emby-apikey"
                                           placeholder="API Key" value="{{ emby_apikey or '' }}">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="emby-userid" class="form-label">User ID</label>
                                    <input type="text" class="form-control" id="emby-userid" name="emby-userid"
                                           placeholder="Username" value="{{ emby_userid or '' }}">
                                </div>
                            </div>
                            
                            <div class="card bg-dark border-secondary mb-3">
                                <div class="card-body">
                                    <h6><i class="fas fa-satellite-dish me-2"></i>Polling Settings</h6>
                                    <small class="text-muted d-block mb-3">Emby uses polling - Episeerr checks playback status at intervals</small>
                                    <div class="row">
                                        <div class="col-md-6 mb-2">
                                            <label for="emby-poll-interval" class="form-label">Poll Interval (seconds)</label>
                                            <input type="number" class="form-control" id="emby-poll-interval" name="emby-poll-interval"
                                                   value="{{ emby_poll_interval or '5' }}" min="5">
                                            <small class="text-muted">5 = check every 5 seconds</small>
                                        </div>
                                        <div class="col-md-6 mb-2">
                                            <label for="emby-trigger-percent" class="form-label">Trigger %</label>
                                            <input type="number" class="form-control" id="emby-trigger-percent" name="emby-trigger-percent"
                                                   value="{{ emby_trigger_percent or '50.0' }}" step="0.1" min="0" max="100">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="d-flex justify-content-between">
                                <button type="button" class="btn btn-secondary" onclick="testConnection('emby')">
                                    <i class="fas fa-plug me-1"></i>Test
                                </button>
                                <button type="submit" class="btn btn-success">
                                    <i class="fas fa-save me-1"></i>Save
                                </button>
                            </div>
                            <div id="emby-test-result" class="mt-3" style="display: none;"></div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Plex/Tautulli -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-0">
                            <i class="fas fa-play-circle me-2"></i>Plex (via Tautulli)
                            {% if tautulli_connected %}
                                <span class="badge bg-success ms-2"><i class="fas fa-check me-1"></i>Connected</span>
                            {% else %}
                                <span class="badge bg-secondary ms-2">Not Connected</span>
                            {% endif %}
                        </h6>
                        <small class="text-muted">Requires Tautulli for webhook support</small>
                    </div>
                    <button class="btn btn-sm btn-primary" data-bs-toggle="collapse" data-bs-target="#tautulli-config">
                        <i class="fas fa-cog"></i>
                    </button>
                </div>
                <div id="tautulli-config" class="collapse">
                    <div class="card-body">
                        <form id="tautulli-form">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="tautulli-url" class="form-label">Tautulli URL</label>
                                    <input type="url" class="form-control" id="tautulli-url" name="tautulli-url"
                                           placeholder="http://192.168.1.100:8181" value="{{ tautulli_url or '' }}">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="tautulli-apikey" class="form-label">API Key</label>
                                    <input type="text" class="form-control" id="tautulli-apikey" name="tautulli-apikey"
                                           placeholder="API Key" value="{{ tautulli_apikey or '' }}">
                                </div>
                            </div>
                            
                            <div class="d-flex justify-content-between">
                                <button type="button" class="btn btn-secondary" onclick="testConnection('tautulli')">
                                    <i class="fas fa-plug me-1"></i>Test
                                </button>
                                <button type="submit" class="btn btn-success">
                                    <i class="fas fa-save me-1"></i>Save
                                </button>
                            </div>
                            <div id="tautulli-test-result" class="mt-3" style="display: none;"></div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Optional Services -->
    <div class="row mb-3">
        <div class="col-12">
            <h4><i class="fas fa-puzzle-piece text-info me-2"></i>Optional Integrations</h4>
        </div>
    </div>

    <!-- Jellyseerr -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-0">
                            <i class="fas fa-ticket-alt me-2"></i>Jellyseerr/Overseerr
                            {% if jellyseerr_connected %}
                                <span class="badge bg-success ms-2"><i class="fas fa-check me-1"></i>Connected</span>
                            {% else %}
                                <span class="badge bg-secondary ms-2">Optional</span>
                            {% endif %}
                        </h6>
                        <small class="text-muted">Removes requests when Episeerr tags detected</small>
                    </div>
                    <button class="btn btn-sm btn-primary" data-bs-toggle="collapse" data-bs-target="#jellyseerr-config">
                        <i class="fas fa-cog"></i>
                    </button>
                </div>
                <div id="jellyseerr-config" class="collapse">
                    <div class="card-body">
                        <form id="jellyseerr-form">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="jellyseerr-url" class="form-label">URL</label>
                                    <input type="url" class="form-control" id="jellyseerr-url" name="jellyseerr-url"
                                           placeholder="http://192.168.1.100:5055" value="{{ jellyseerr_url or '' }}">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="jellyseerr-apikey" class="form-label">API Key</label>
                                    <input type="text" class="form-control" id="jellyseerr-apikey" name="jellyseerr-apikey"
                                           placeholder="API Key" value="{{ jellyseerr_apikey or '' }}">
                                </div>
                            </div>
                            
                            <div class="d-flex justify-content-between">
                                <button type="button" class="btn btn-secondary" onclick="testConnection('jellyseerr')">
                                    <i class="fas fa-plug me-1"></i>Test
                                </button>
                                <button type="submit" class="btn btn-success">
                                    <i class="fas fa-save me-1"></i>Save
                                </button>
                            </div>
                            <div id="jellyseerr-test-result" class="mt-3" style="display: none;"></div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Dashboard Integrations (Auto-Generated from Plugins) -->
{% if integrations %}
<div class="row mb-3">
    <div class="col-12">
        <h4><i class="fas fa-puzzle-piece text-info me-2"></i>Dashboard Integrations</h4>
    </div>
</div>

{% for integration in integrations %}
    {% if integration.category == 'dashboard' %}
    {% set service = integration.service_name %}
    {% set config = integration_configs.get(service, {}) %}
    
    <div class="row mb-3">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-0">
                            {% if integration.icon.startswith('http') %}
                                <img src="{{ integration.icon }}" style="width: 20px; height: 20px;" class="me-2">
                            {% else %}
                                <i class="{{ integration.icon }} me-2"></i>
                            {% endif %}
                            {{ integration.display_name }}
                            
                            {% if config.connected %}
                                <span class="badge bg-success ms-2"><i class="fas fa-check me-1"></i>Connected</span>
                            {% else %}
                                <span class="badge bg-secondary ms-2">Optional</span>
                            {% endif %}
                        </h6>
                        <small class="text-muted">{{ integration.description }}</small>
                    </div>
                    <button class="btn btn-sm btn-primary" data-bs-toggle="collapse" 
                            data-bs-target="#{{ service }}-config">
                        <i class="fas fa-cog"></i>
                    </button>
                </div>
                
                <div id="{{ service }}-config" class="collapse {% if not config.connected %}{% endif %}">
                    <div class="card-body">
                        <form id="{{ service }}-form">
                            {% for field in integration.setup_fields %}
                            <div class="col-md-6 mb-3">
                                <label for="{{ service }}-{{ field.name }}" class="form-label">
                                    {{ field.label }}
                                </label>
                                <input type="{{ field.type }}" 
                                       class="form-control" 
                                       id="{{ service }}-{{ field.name }}" 
                                       name="{{ service }}-{{ field.name }}"
                                       placeholder="{{ field.placeholder }}"
                                       value="{{ config.get(field.name, '') }}"
                                       {% if field.required %}required{% endif %}>
                                {% if field.help %}
                                <small class="text-muted">{{ field.help }}</small>
                                {% endif %}
                            </div>
                            {% endfor %}
                            
                            <div class="d-flex justify-content-between">
                                <button type="button" class="btn btn-secondary" 
                                        onclick="testConnection('{{ service }}')">
                                    <i class="fas fa-plug me-1"></i>Test
                                </button>
                                <button type="submit" class="btn btn-success">
                                    <i class="fas fa-save me-1"></i>Save
                                </button>
                            </div>
                            <div id="{{ service }}-test-result" class="mt-3" style="display: none;"></div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
{% endfor %}
{% endif %}
    <!-- TMDB -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-0">
                            <i class="fas fa-image me-2"></i>TMDB
                            {% if tmdb_connected %}
                                <span class="badge bg-success ms-2"><i class="fas fa-check me-1"></i>Connected</span>
                            {% else %}
                                <span class="badge bg-secondary ms-2">Optional</span>
                            {% endif %}
                        </h6>
                        <small class="text-muted">Artwork and metadata for dashboard</small>
                    </div>
                    <button class="btn btn-sm btn-primary" data-bs-toggle="collapse" data-bs-target="#tmdb-config">
                        <i class="fas fa-cog"></i>
                    </button>
                </div>
                <div id="tmdb-config" class="collapse">
                    <div class="card-body">
                        <form id="tmdb-form">
                            <div class="mb-3">
                                <label for="tmdb-apikey" class="form-label">API Key (Bearer Token)</label>
                                <input type="text" class="form-control" id="tmdb-apikey" name="tmdb-apikey"
                                       placeholder="eyJhbGciOiJIUzI1NiJ9..." value="{{ tmdb_apikey or '' }}">
                                <small class="text-muted">Get from <a href="https://www.themoviedb.org/settings/api" target="_blank">TMDB Settings</a></small>
                            </div>
                            
                            <div class="d-flex justify-content-between">
                                <button type="button" class="btn btn-secondary" onclick="testConnection('tmdb')">
                                    <i class="fas fa-plug me-1"></i>Test
                                </button>
                                <button type="submit" class="btn btn-success">
                                    <i class="fas fa-save me-1"></i>Save
                                </button>
                            </div>
                            <div id="tmdb-test-result" class="mt-3" style="display: none;"></div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Quick Links / System Links Section -->
    <div class="row mb-3 mt-5">
        <div class="col-12">
            <h4><i class="fas fa-link text-primary me-2"></i>System Links</h4>
            <p class="text-muted">Quick access to your connected services and custom links</p>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-external-link-alt me-2"></i>Configured Links</h6>
                </div>
                <div class="card-body">
                    <!-- Connected Services (Auto-generated) -->
                    <div class="mb-4">
                        <h6 class="text-muted mb-3">Connected Services</h6>
                        <div id="service-links" class="d-flex flex-wrap gap-2">
                            {% if sonarr_connected %}
                            <a href="{{ sonarr_url }}" target="_blank" class="btn btn-outline-primary btn-sm">
                                <i class="fas fa-tv me-1"></i>Sonarr
                            </a>
                            {% endif %}
                            {% if jellyfin_connected %}
                            <a href="{{ jellyfin_url }}" target="_blank" class="btn btn-outline-primary btn-sm">
                                <i class="fas fa-film me-1"></i>Jellyfin
                            </a>
                            {% endif %}
                            {% if emby_connected %}
                            <a href="{{ emby_url }}" target="_blank" class="btn btn-outline-primary btn-sm">
                                <i class="fas fa-film me-1"></i>Emby
                            </a>
                            {% endif %}
                            {% if tautulli_connected %}
                            <a href="{{ tautulli_url }}" target="_blank" class="btn btn-outline-primary btn-sm">
                                <i class="fas fa-chart-line me-1"></i>Tautulli
                            </a>
                            {% endif %}
                            {% if jellyseerr_connected %}
                            <a href="{{ jellyseerr_url }}" target="_blank" class="btn btn-outline-primary btn-sm">
                                <i class="fas fa-ticket-alt me-1"></i>Jellyseerr
                            </a>
                            {% endif %}
                            
                            {% if not (sonarr_connected or jellyfin_connected or emby_connected or tautulli_connected or jellyseerr_connected) %}
                            <p class="text-muted mb-0">
                                <i class="fas fa-info-circle me-1"></i>
                                No external services configured in .env
                            </p>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Custom Quick Links -->
                    <div>
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="text-muted mb-0">Custom Links</h6>
                            <button type="button" class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#addLinkModal">
                                <i class="fas fa-plus me-1"></i>Add Link
                            </button>
                        </div>
                        
                        <div id="custom-links" class="d-flex flex-wrap gap-2">
                            <!-- Custom links will be loaded here via JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Link Modal -->
    <div class="modal fade" id="addLinkModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add Custom Link</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="add-link-form">
                        <div class="mb-3">
                            <label for="link-name" class="form-label">Name *</label>
                            <input type="text" class="form-control" id="link-name" name="name" required placeholder="e.g., Radarr">
                        </div>
                        <div class="mb-3">
                            <label for="link-url" class="form-label">URL *</label>
                            <input type="url" class="form-control" id="link-url" name="url" required placeholder="https://...">
                        </div>
                        <div class="mb-3">
                            <label for="link-icon" class="form-label">Icon (Font Awesome class)</label>
                            <input type="text" class="form-control" id="link-icon" name="icon" placeholder="https://cdn.jsdelivr.net/gh/walkxcode/dashboard-icons/png/radarr.png">
                            <small class="form-text text-muted">
                                Browse icons at <a href="https://github.com/walkxcode/dashboard-icons/tree/main/png" target="_blank">github.com/walkxcode/dashboard-icons</a>
                            </small>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" onclick="addCustomLink()">
                        <i class="fas fa-save me-1"></i>Add Link
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>


// Load custom links on page load
document.addEventListener('DOMContentLoaded', function() {
    loadCustomLinks();
});

// Load custom links from API
function loadCustomLinks() {
    fetch('/api/quick-links')
        .then(res => res.json())
        .then(data => {
            if (data.status === 'success' && data.links && data.links.length > 0) {
                displayCustomLinks(data.links);
            } else {
                document.getElementById('custom-links').innerHTML = 
                    '<p class="text-muted mb-0"><i class="fas fa-info-circle me-1"></i>No custom links added yet</p>';
            }
        })
        .catch(err => {
            console.error('Error loading custom links:', err);
            document.getElementById('custom-links').innerHTML = 
                '<p class="text-danger mb-0"><i class="fas fa-exclamation-triangle me-1"></i>Error loading links</p>';
        });
}

// Display custom links
function displayCustomLinks(links) {
    const container = document.getElementById('custom-links');
    
    if (!links || links.length === 0) {
        container.innerHTML = '<p class="text-muted mb-0"><i class="fas fa-info-circle me-1"></i>No custom links added yet</p>';
        return;
    }
    
    container.innerHTML = links.map(link => `
        <div class="btn-group" role="group">
            <a href="${link.url}" target="_blank" class="btn btn-outline-secondary btn-sm">
                <i class="${link.icon || 'fas fa-link'} me-1"></i>${link.name}
            </a>
            <button type="button" class="btn btn-outline-danger btn-sm" onclick="deleteCustomLink(${link.id})" title="Delete">
                <i class="fas fa-trash"></i>
            </button>
        </div>
    `).join('');
}

// Add custom link
function addCustomLink() {
    const form = document.getElementById('add-link-form');
    const formData = new FormData(form);
    
    // Validate
    if (!formData.get('name') || !formData.get('url')) {
        alert('Name and URL are required');
        return;
    }
    
    const data = {
        name: formData.get('name'),
        url: formData.get('url'),
        icon: formData.get('icon') || 'fas fa-link'
    };
    
    fetch('/api/quick-links', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    })
    .then(res => res.json())
    .then(result => {
        if (result.status === 'success') {
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('addLinkModal'));
            modal.hide();
            
            // Reset form
            form.reset();
            
            // Reload links
            loadCustomLinks();
            
            // Show success toast/alert instead of showResult
            alert('Link added successfully!');
        } else {
            alert('Error adding link: ' + (result.message || 'Unknown error'));
        }
    })
    .catch(err => {
        console.error('Error adding link:', err);
        alert('Error adding link: ' + err.message);
    });
}

// Delete custom link
function deleteCustomLink(linkId) {
    if (!confirm('Delete this link?')) {
        return;
    }
    
    fetch(`/api/quick-links/${linkId}`, {
        method: 'DELETE'
    })
    .then(res => res.json())
    .then(result => {
        if (result.status === 'success') {
            loadCustomLinks();
            showResult('custom-links-result', 'Link deleted', true);
        } else {
            alert('Error deleting link');
        }
    })
    .catch(err => {
        console.error('Error deleting link:', err);
        alert('Error deleting link');
    });
}
// Helper: show temporary message in a result div
function showResult(elementId, message, isSuccess = true) {
    const div = document.getElementById(elementId);
    div.style.display = 'block';
    div.innerHTML = `<div class="alert ${isSuccess ? 'alert-success' : 'alert-danger'} mb-0">
        <i class="fas ${isSuccess ? 'fa-check-circle' : 'fa-times-circle'} me-2"></i>${message}
    </div>`;
    setTimeout(() => { div.style.display = 'none'; }, 8000);
}

// Test connection
function testConnection(service) {
    const resultDiv = document.getElementById(`${service}-test-result`);
    showResult(`${service}-test-result`, '<i class="fas fa-spinner fa-spin me-2"></i>Testing...', true);

    const form = document.getElementById(`${service}-form`);
    if (!form) return console.error(`Form #${service}-form not found`);

    const data = {};
    new FormData(form).forEach((value, key) => {
        data[key] = value;
    });

    // Add checked radio value explicitly if present
    const checkedRadio = form.querySelector('input[type="radio"]:checked');
    if (checkedRadio) {
        data[checkedRadio.name] = checkedRadio.value;
    }

    console.log(`[TEST] Sending to /api/test-connection/${service}:`, data);

    fetch(`/api/test-connection/${service}`, {
        method: 'POST',
        headers: { 
            'Content-Type': 'application/json',
            'Accept': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(async res => {
        console.log(`[TEST] Response status: ${res.status}`);
        console.log(`[TEST] Response headers:`, res.headers.get('content-type'));
        
        // Try to get response text first
        const text = await res.text();
        console.log(`[TEST] Response text:`, text);
        
        // Try to parse as JSON
        let result;
        try {
            result = JSON.parse(text);
        } catch (e) {
            // Not JSON - show raw response
            console.error('[TEST] Not JSON:', e);
            showResult(`${service}-test-result`, `Server error: ${text.substring(0, 200)}`, false);
            return;
        }
        
        if (res.ok && result.status === 'success') {
            showResult(`${service}-test-result`, result.message || 'Connected!', true);
        } else {
            showResult(`${service}-test-result`, result.message || `Error: ${res.status}`, false);
        }
    })
    .catch(err => {
        console.error('[TEST] Error:', err);
        showResult(`${service}-test-result`, `Error: ${err.message}`, false);
    });
}

// Form save handler
document.querySelectorAll('form[id$="-form"]').forEach(form => {
    form.addEventListener('submit', function(e) {
        e.preventDefault();

        const serviceType = this.id.replace('-form', '');
        const resultId = `${serviceType}-test-result`;

        // Basic client-side check
        const requiredFields = this.querySelectorAll('[required]');
        let valid = true;
        requiredFields.forEach(field => {
            if (!field.value.trim()) {
                valid = false;
                field.classList.add('is-invalid');
            } else {
                field.classList.remove('is-invalid');
            }
        });

        if (!valid) {
            showResult(resultId, 'Please fill in all required fields', false);
            return;
        }

        // Collect all values
        const data = {};
        new FormData(this).forEach((value, key) => {
            data[key] = value.trim();
        });

        // Handle checkboxes explicitly (they need special treatment)
        this.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
            data[checkbox.name] = checkbox.checked;
        });

        // Handle radio buttons explicitly
        const checkedRadio = this.querySelector('input[type="radio"]:checked');
        if (checkedRadio) {
            data[checkedRadio.name] = checkedRadio.value;
        }

        console.log(`[SAVE] Sending to /api/save-service/${serviceType}:`, data);

        fetch(`/api/save-service/${serviceType}`, {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify(data)
        })
        .then(res => {
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            return res.json();
        })
        .then(result => {
            if (result.status === 'success') {
                showResult(resultId, result.message || 'Settings saved successfully!', true);
                // Optional: reload after short delay so UI updates
                setTimeout(() => location.reload(), 1200);
            } else {
                showResult(resultId, result.message || 'Save failed', false);
            }
        })
        .catch(err => {
            console.error(err);
            showResult(resultId, 'Error saving: ' + (err.message || 'unknown error'), false);
        });
    });
});
</script>
{% endblock %}