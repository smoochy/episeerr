{% extends "base.html" %}

{% block title %}Documentation - Episeerr{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-3">
        <div class="col">
            <h2><i class="fas fa-book me-2"></i>Episeerr Documentation</h2>
            <p class="text-muted">Complete guide to episode management and automation</p>
        </div>
    </div>

    <!-- Quick Navigation -->
    <div class="card mb-3">
        <div class="card-body">
            <h5><i class="fas fa-compass me-2"></i>Quick Navigation</h5>
            <div class="row">
                <div class="col-md-4">
                    <a href="#overview" class="btn btn-outline-primary btn-sm w-100 mb-2">Overview</a>
                    <a href="#setup-page" class="btn btn-outline-success btn-sm w-100 mb-2">Setup Page (New!)</a>
                    <a href="#getting-started" class="btn btn-outline-success btn-sm w-100 mb-2">Getting Started</a>
                    <a href="#rules" class="btn btn-outline-primary btn-sm w-100 mb-2">Rules System</a>
                </div>
                <div class="col-md-4">
                    <a href="#grace-periods" class="btn btn-outline-primary btn-sm w-100 mb-2">Grace Periods</a>
                    <a href="#pending-deletions" class="btn btn-outline-warning btn-sm w-100 mb-2">Pending Deletions</a>
                    <a href="#workflows" class="btn btn-outline-primary btn-sm w-100 mb-2">Workflows</a>
                </div>
                <div class="col-md-4">
                    <a href="#webhooks" class="btn btn-outline-info btn-sm w-100 mb-2">Webhook Setup</a>
                    <a href="#tag-management" class="btn btn-outline-success btn-sm w-100 mb-2">Tag Management</a>
                    <a href="#auto-assign" class="btn btn-outline-info btn-sm w-100 mb-2">Auto-Assign</a>
                    <a href="#troubleshooting" class="btn btn-outline-primary btn-sm w-100 mb-2">Troubleshooting</a>
                </div>
            </div>
        </div>
    </div>
        <div class="alert alert-success mb-3">
        <h5>üéâ New in v3.2.0</h5>
        <ul class="mb-0">
            <li><strong>Setup Page:</strong> Configure everything via GUI at <a href="/setup">/setup</a> - no .env file needed!</li>
            <li><strong>Emby Support:</strong> Full webhook integration for viewing automation</li>
            <li><strong>Quick Links:</strong> Auto-populated sidebar links to your services</li>
        </ul>
    </div>
    <!-- Overview -->
    <div class="card mb-3" id="overview">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0"><i class="fas fa-info-circle me-2"></i>What is Episeerr?</h4>
        </div>
        <div class="card-body">
            <p class="lead">Episeerr is an intelligent episode management system that automates content delivery and cleanup for Sonarr-managed TV shows.</p>
            
            <h5 class="mt-4">Four Ways to Manage Episodes:</h5>
            <div class="row mt-3">
                <div class="col-md-4">
                    <div class="card h-100 border-primary">
                        <div class="card-header bg-primary text-white">
                            <h6><i class="fas fa-hand-pointer me-2"></i>Manual Selection</h6>
                        </div>
                        <div class="card-body">
                            <p>Select specific episodes across multiple seasons</p>
                            <ul>
                                <li>Pick any episodes you want</li>
                                <li>Multi-season support</li>
                                <li>Perfect for catching up</li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card h-100 border-success">
                        <div class="card-header bg-success text-white">
                            <h6><i class="fas fa-eye me-2"></i>Viewing-Based</h6>
                        </div>
                        <div class="card-body">
                            <p>Automatic based on what you watch</p>
                            <ul>
                                <li>Watch episode ‚Üí Get next</li>
                                <li>Webhook integration</li>
                                <li>Zero manual work</li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card h-100 border-warning">
                        <div class="card-header bg-warning">
                            <h6><i class="fas fa-clock me-2"></i>Time-Based</h6>
                        </div>
                        <div class="card-body">
                            <p>Automatic cleanup after inactivity</p>
                            <ul>
                                <li>Grace periods</li>
                                <li>Dormant timers</li>
                                <li>Smart cleanup</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Second row with the new card -->
            <div class="row mt-3">
                <div class="col-md-4">
                    <div class="card h-100 border-info">
                        <div class="card-header bg-info text-white">
                            <h6><i class="fas fa-shield-check me-2"></i>Approval-Based</h6>
                        </div>
                        <div class="card-body">
                            <p>Review deletions before they happen</p>
                            <ul>
                                <li>Dry run mode enabled by default</li>
                                <li>Approve or reject each deletion</li>
                                <li>Full transparency on cleanup decisions</li>
                            </ul>
                        </div>
                    </div>
                </div>
                <!-- Empty columns to maintain layout -->
                <div class="col-md-4"></div>
                <div class="col-md-4"></div>
            </div>
        </div>
    </div>

    <!-- Setup Page Section (NEW!) -->
    <div class="card mb-3" id="setup-page">
        <div class="card-header bg-success text-white">
            <h4 class="mb-0"><i class="fas fa-cog me-2"></i>Setup Page - Configure Services</h4>
        </div>
        <div class="card-body">
            <div class="alert alert-success">
                <h5><i class="fas fa-sparkles me-2"></i>New in v3.2.0: GUI Configuration</h5>
                <p class="mb-0">No more manual .env file editing! Configure everything through the web interface.</p>
            </div>

            <h5 class="mt-4">Accessing Setup Page</h5>
            <p><strong>URL:</strong> <code>http://your-server:5002/setup</code></p>
            <p>Or click <strong>"Setup"</strong> in the sidebar</p>

            <h5 class="mt-4">Required Services</h5>
            <div class="row">
                <div class="col-md-6">
                    <div class="card border-primary mb-3">
                        <div class="card-header bg-primary text-white">
                            <i class="fas fa-tv me-2"></i>Sonarr
                        </div>
                        <div class="card-body">
                            <p><strong>Required for:</strong> All features</p>
                            <p><strong>You need:</strong></p>
                            <ul class="mb-0">
                                <li>Sonarr URL (e.g., <code>http://sonarr:8989</code>)</li>
                                <li>API Key from Sonarr ‚Üí Settings ‚Üí General</li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card border-primary mb-3">
                        <div class="card-header bg-primary text-white">
                            <i class="fas fa-film me-2"></i>TMDB
                        </div>
                        <div class="card-body">
                            <p><strong>Required for:</strong> Episode selection</p>
                            <p><strong>You need:</strong></p>
                            <ul class="mb-0">
                                <li>TMDB API Read Access Token</li>
                                <li>Get one free at <a href="https://www.themoviedb.org/settings/api" target="_blank">themoviedb.org/settings/api</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <h5 class="mt-4">Optional Services (For Automation)</h5>
            <div class="row">
                <div class="col-md-4">
                    <div class="card border-info mb-3">
                        <div class="card-header bg-info text-white">
                            <i class="fas fa-play me-2"></i>Media Server
                        </div>
                        <div class="card-body">
                            <p><strong>Choose one:</strong></p>
                            <ul>
                                <li><strong>Jellyfin</strong> - Real-time or polling</li>
                                <li><strong>Emby</strong> - Polling mode</li>
                                <li><strong>Plex</strong> - Via Tautulli</li>
                            </ul>
                            <p class="mb-0"><strong>Enables:</strong> Viewing automation (next episode on watch)</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card border-info mb-3">
                        <div class="card-header bg-info text-white">
                            <i class="fas fa-chart-bar me-2"></i>Tautulli
                        </div>
                        <div class="card-body">
                            <p><strong>For Plex users</strong></p>
                            <p>Tautulli bridges Plex viewing data to Episeerr</p>
                            <p class="mb-0"><strong>Enables:</strong> Viewing automation with Plex</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card border-info mb-3">
                        <div class="card-header bg-info text-white">
                            <i class="fas fa-inbox me-2"></i>Request Integration
                        </div>
                        <div class="card-body">
                            <p><strong>Choose one:</strong></p>
                            <ul>
                                <li>Overseerr</li>
                                <li>Jellyseerr</li>
                            </ul>
                            <p class="mb-0"><strong>Enables:</strong> Automatic episode selection for new requests</p>
                        </div>
                    </div>
                </div>
            </div>

            <h5 class="mt-4">Setup Page Features</h5>
            <ul>
                <li><i class="fas fa-check-circle text-success me-2"></i><strong>Test Connections:</strong> Verify URLs and API keys before saving</li>
                <li><i class="fas fa-check-circle text-success me-2"></i><strong>Quick Links:</strong> Auto-populate sidebar links to configured services</li>
                <li><i class="fas fa-check-circle text-success me-2"></i><strong>Database Storage:</strong> Configuration persists across container restarts</li>
                <li><i class="fas fa-check-circle text-success me-2"></i><strong>No .env needed:</strong> Fresh installs can configure everything via GUI</li>
                <li><i class="fas fa-check-circle text-success me-2"></i><strong>Migration Support:</strong> Existing .env values appear as defaults</li>
            </ul>

            <div class="alert alert-info mt-4">
                <h6><i class="fas fa-info-circle me-2"></i>Configuration Priority</h6>
                <p class="mb-0">Database configuration takes priority over .env files. You can use both (database overrides .env), but we recommend configuring everything through the GUI for easier management.</p>
            </div>

            <h5 class="mt-4">After Setup</h5>
            <ol>
                <li>Configure your services on the Setup page</li>
                <li>Test each connection (green checkmark = success)</li>
                <li>Save configuration</li>
                <li>Check Quick Links in sidebar - they should auto-populate</li>
                <li>Set up webhooks (see <a href="#webhooks">Webhook Setup</a> section below)</li>
                <li>Create your first rule!</li>
            </ol>
        </div>
    </div>

    <!-- Getting Started -->
    <div class="card mb-3" id="getting-started">
        <div class="card-header bg-success text-white">
            <h4 class="mb-0"><i class="fas fa-rocket me-2"></i>Getting Started - Initial Setup</h4>
        </div>
        <div class="card-body">
            <p class="lead">Before using Episeerr, you need to configure Sonarr and set up a default rule.</p>
            
            <h5 class="mt-4"><i class="fas fa-cog text-primary me-2"></i>Step 1: Sonarr Delay Profile (CRITICAL)</h5>
            <div class="alert alert-danger">
                <strong><i class="fas fa-exclamation-triangle me-2"></i>IMPORTANT:</strong> You MUST set up a delay profile in Sonarr or episodes will download immediately, bypassing Episeerr!
            </div>
            
            <div class="card mb-3">
                <div class="card-header bg-light">
                    <strong>Why Delay Profiles?</strong>
                </div>
                <div class="card-body">
                    <p>Without a delay profile:</p>
                    <ul>
                        <li>‚ùå Sonarr downloads ALL available episodes immediately</li>
                        <li>‚ùå Episeerr can't control what gets downloaded</li>
                        <li>‚ùå Your rules don't work</li>
                    </ul>
                    <p class="mb-0">With a delay profile:</p>
                    <ul class="mb-0">
                        <li>‚úÖ Episodes stay "monitored" but don't auto-download</li>
                        <li>‚úÖ Episeerr decides which episodes to grab</li>
                        <li>‚úÖ Your rules work perfectly</li>
                    </ul>
                </div>
            </div>

            <h6>How to Set Up Delay Profile in Sonarr:</h6>
            <ol>
                <li>Go to <strong>Sonarr ‚Üí Settings ‚Üí Profiles ‚Üí Delay Profiles</strong></li>
                <li>Click <strong>Add New Delay Profile</strong> or edit existing</li>
                <li>Set delays:
                    <ul>
                        <li><strong>Usenet Delay:</strong> 999999 minutes (essentially infinite)</li>
                        <li><strong>Torrent Delay:</strong> 999999 minutes (essentially infinite)</li>
                    </ul>
                </li>
                <li>Set <strong>Tags:</strong> <code>episeerr_[rule_name]</code> and/or <code>episeerr_select</code></li>
                <li>Save</li>
            </ol>

            <div class="alert alert-info">
                <strong><i class="fas fa-lightbulb me-2"></i>Pro Tip:</strong> Create a delay profile specifically for Episeerr-managed shows. This way, other shows can still auto-download normally.
            </div>

            <h5 class="mt-4"><i class="fas fa-list text-success me-2"></i>Step 2: Create Your First Rule</h5>
            <ol>
                <li>Go to <strong>Admin Panel</strong></li>
                <li>Scroll to <strong>Rule Management</strong></li>
                <li>Click <strong>Create New Rule</strong></li>
                <li>Configure:
                    <ul>
                        <li><strong>Rule Name:</strong> e.g., "Default Weekly Shows"</li>
                        <li><strong>Get:</strong> 1 episode</li>
                        <li><strong>Keep:</strong> 0 or 1 episodes</li>
                        <li><strong>Grace Unwatched:</strong> 7 days</li>
                        <li><strong>Grace Watched:</strong> 3 days</li>
                        <li><strong>Dormant Timer:</strong> 30 days</li>
                    </ul>
                </li>
                <li>Save</li>
            </ol>

            <h5 class="mt-4"><i class="fas fa-tags text-warning me-2"></i>Step 3: Add Shows to Episeerr</h5>
            <p>There are two ways to add shows:</p>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="card border-success mb-3">
                        <div class="card-header bg-success text-white">
                            <h6><i class="fas fa-magic me-2"></i>Method 1: Sonarr Tags (Recommended)</h6>
                        </div>
                        <div class="card-body">
                            <ol>
                                <li>In Sonarr, select a show</li>
                                <li>Add tag: <code>episeerr_[rule_name]</code></li>
                                <li>Save</li>
                                <li>Sonarr webhook triggers</li>
                                <li>Episeerr automatically adds to default rule</li>
                                <li>Tag is removed automatically</li>
                            </ol>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="card border-warning mb-3">
                        <div class="card-header bg-warning">
                            <h6><i class="fas fa-hand-pointer me-2"></i>Method 2: Manual Selection</h6>
                        </div>
                        <div class="card-body">
                            <ol>
                                <li>In Sonarr, select a show</li>
                                <li>Add tag: <code>episeerr_select</code></li>
                                <li>Save</li>
                                <li>Sonarr webhook triggers</li>
                                <li>Creates selection request in Episeerr</li>
                                <li>You manually pick episodes</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>

            <h5 class="mt-4"><i class="fas fa-bolt text-info me-2"></i>Step 4: Set Up Webhooks</h5>
            <p>Configure webhooks for automation (see <a href="#integration">Integration</a> section below for details):</p>
            <ul>
                <li><strong>Sonarr webhook:</strong> ‚úÖ REQUIRED - <code>http://your-server:5002/sonarr-webhook</code></li>
                <li><strong>Jellyseerr/Overseerr:</strong> ‚úÖ REQUIRED if using *seerr</li>
                <li><strong>Tautulli/Jellyfin:</strong> ‚öôÔ∏è OPTIONAL - For viewing-based automation</li>
            </ul>

            <div class="alert alert-success mt-3">
                <h6><i class="fas fa-check-circle me-2"></i>You're Ready!</h6>
                <p class="mb-0">With delay profiles set and a rule created, Episeerr is now managing your shows. Add tags to shows and watch the automation happen!</p>
            </div>
        </div>
    </div>

    <!-- Rules System -->
    <div class="card mb-3" id="rules">
        <div class="card-header bg-success text-white">
            <h4 class="mb-0"><i class="fas fa-sliders-h me-2"></i>Rules System</h4>
        </div>
        <div class="card-body">
            <p>Rules define how episodes are managed for different shows. Each rule has four main settings:</p>
            
            <div class="row mt-3">
                <div class="col-md-6">
                    <h5><i class="fas fa-download text-primary me-2"></i>Get Settings</h5>
                    <p>Controls what new content to download after watching:</p>
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Type</th>
                                <th>Behavior</th>
                                <th>Example</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>Episodes</strong></td>
                                <td>Get X episodes ahead</td>
                                <td>Get 2 = next 2 episodes</td>
                            </tr>
                            <tr>
                                <td><strong>Seasons</strong></td>
                                <td>Get X seasons ahead</td>
                                <td>Get 1 = entire next season</td>
                            </tr>
                            <tr>
                                <td><strong>All</strong></td>
                                <td>Get everything available</td>
                                <td>All = complete series</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="col-md-6">
                    <h5><i class="fas fa-shield-alt text-success me-2"></i>Keep Settings</h5>
                    <p>Controls what watched content to retain:</p>
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Type</th>
                                <th>Behavior</th>
                                <th>Example</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>Episodes</strong></td>
                                <td>Keep X watched episodes</td>
                                <td>Keep 1 = last watched only</td>
                            </tr>
                            <tr>
                                <td><strong>Seasons</strong></td>
                                <td>Keep X watched seasons</td>
                                <td>Keep 1 = current season</td>
                            </tr>
                            <tr>
                                <td><strong>All</strong></td>
                                <td>Keep everything watched</td>
                                <td>Never delete watched</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="row mt-3">
                <div class="col-12">
                    <h5><i class="fas fa-anchor text-info me-2"></i>Always Have (Optional)</h5>
                    <p>An expression that defines episodes to always keep downloaded and protected from cleanup. Think of it as the baseline state of a show ‚Äî these episodes are always there regardless of what Get/Keep does.</p>
                    <p>When a show is assigned to a rule with Always Have, those episodes get monitored and searched immediately. Cleanup (grace, keep) will never delete them. Dormant cleanup is the only exception ‚Äî dormant is nuclear and ignores Always Have.</p>
                    
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Expression</th>
                                <th>What It Grabs</th>
                                <th>Use Case</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><code>s1e1</code></td>
                                <td>Just the pilot</td>
                                <td>Placeholder in Plex</td>
                            </tr>
                            <tr>
                                <td><code>s1</code></td>
                                <td>All of season 1</td>
                                <td>First season to try</td>
                            </tr>
                            <tr>
                                <td><code>s1, s*e1</code></td>
                                <td>Season 1 + first episode of every other season</td>
                                <td>Plex shows all seasons exist without downloading everything</td>
                            </tr>
                            <tr>
                                <td><code>s1-3</code></td>
                                <td>Seasons 1 through 3</td>
                                <td>First few seasons to start</td>
                            </tr>
                            <tr>
                                <td><code>s1e1-5</code></td>
                                <td>Season 1, episodes 1-5</td>
                                <td>Try first handful of episodes</td>
                            </tr>
                            <tr>
                                <td><code>all</code></td>
                                <td>Everything</td>
                                <td>Combined with Keep for full protection</td>
                            </tr>
                        </tbody>
                    </table>
                    <p><small class="text-muted">Combine with commas: <code>s1, s3e1-3, s*e1</code>. Leave blank to skip ‚Äî Get/Keep will handle everything.</small></p>
                </div>
            </div>

            <div class="alert alert-secondary mt-3">
                <h6><i class="fas fa-puzzle-piece me-2"></i>How The Pieces Fit Together</h6>
                <p class="mb-1"><strong>Always Have</strong> = what's always present on disk (the floor)</p>
                <p class="mb-1"><strong>Get</strong> = what to download next when you watch (ongoing)</p>
                <p class="mb-1"><strong>Keep</strong> = how many watched episodes to retain (immediate cleanup after watching)</p>
                <p class="mb-1"><strong>Grace</strong> = time-based cleanup for inactive shows (days since last watch)</p>
                <p class="mb-0"><strong>Dormant</strong> = nuclear cleanup for abandoned shows (ignores everything)</p>
                <p class="mt-2 mb-0">They're all independent ‚Äî use any combination. A show can have Always Have + Get + Grace with no Keep, or just Get with no cleanup at all.</p>
            </div>

            <div class="alert alert-info mt-3">
                <strong><i class="fas fa-lightbulb me-2"></i>Rule Examples:</strong>
                <ul class="mb-0">
                    <li><strong>Get 1, Keep 1:</strong> Rolling window - always have 1 watched + 1 unwatched</li>
                    <li><strong>Get 3, Keep 0:</strong> Binge mode - get 3 ahead, delete after watching</li>
                    <li><strong>Get 1 season, Keep 1 season:</strong> Season-based - entire seasons at a time</li>
                    <li><strong>Get All, Keep All:</strong> Hoarder mode - download everything, keep forever</li>
                    <li><strong>Always Have: s1, s*e1 + Get 1:</strong> Showcase ‚Äî Plex shows all seasons, grab 1 at a time when watching</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Examples -->
    <div class="card mb-3" id="examples">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0"><i class="fas fa-lightbulb me-2"></i>Example Scenarios</h4>
        </div>
        <div class="card-body">
            <div class="accordion" id="examplesAccordion">
                <!-- Example 1 -->
                <div class="accordion-item">
                    <h2 class="accordion-header" id="example1">
                        <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapse1">
                            <strong>Scenario 1: Weekly Show (The Office)</strong>
                        </button>
                    </h2>
                    <div id="collapse1" class="accordion-collapse collapse show" data-bs-parent="#examplesAccordion">
                        <div class="accordion-body">
                            <strong>Goal:</strong> Always have next episode ready, delete after watching<br>
                            <strong>Rule Settings:</strong>
                            <ul>
                                <li>Get: 1 episode</li>
                                <li>Keep: 0 episodes</li>
                                <li>Grace Unwatched: 7 days</li>
                            </ul>
                            <strong>Behavior:</strong> Watch S1E1 ‚Üí Get S1E2 ‚Üí Delete S1E1 immediately
                        </div>
                    </div>
                </div>

                <!-- Example 2 -->
                <div class="accordion-item">
                    <h2 class="accordion-header" id="example2">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse2">
                            <strong>Scenario 2: Binge Watching (Stranger Things)</strong>
                        </button>
                    </h2>
                    <div id="collapse2" class="accordion-collapse collapse" data-bs-parent="#examplesAccordion">
                        <div class="accordion-body">
                            <strong>Goal:</strong> Get 3 episodes ahead, keep last watched<br>
                            <strong>Rule Settings:</strong>
                            <ul>
                                <li>Get: 3 episodes</li>
                                <li>Keep: 1 episode</li>
                                <li>Grace Watched: 14 days</li>
                            </ul>
                            <strong>Behavior:</strong> Always have 3 unwatched + 1 watched episode available
                        </div>
                    </div>
                </div>

                <!-- Example 3 -->
                <div class="accordion-item">
                    <h2 class="accordion-header" id="example3">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse3">
                            <strong>Scenario 3: Family Show (Landman - Multi-Viewer)</strong>
                        </button>
                    </h2>
                    <div id="collapse3" class="accordion-collapse collapse" data-bs-parent="#examplesAccordion">
                        <div class="accordion-body">
                            <strong>Goal:</strong> Wife watches S2, son watches S1 - keep both protected<br>
                            <strong>Rule Settings:</strong>
                            <ul>
                                <li>Get: 1 episode</li>
                                <li>Keep: 1 season</li>
                                <li>Grace Watched: 14 days</li>
                                <li><strong>Grace Scope: Per Season</strong></li>
                            </ul>
                            <strong>Behavior:</strong> S1 and S2 have independent grace timers - son watching S1 doesn't reset S2's timer
                        </div>
                    </div>
                </div>

                <!-- Example 4 -->
                <div class="accordion-item">
                    <h2 class="accordion-header" id="example4">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse4">
                            <strong>Scenario 4: Limited Storage (Budget Seedbox)</strong>
                        </button>
                    </h2>
                    <div id="collapse4" class="accordion-collapse collapse" data-bs-parent="#examplesAccordion">
                        <div class="accordion-body">
                            <strong>Goal:</strong> Aggressive cleanup, only keep what's needed<br>
                            <strong>Rule Settings:</strong>
                            <ul>
                                <li>Get: 1 episode</li>
                                <li>Keep: 0 episodes</li>
                                <li>Grace Unwatched: 3 days</li>
                                <li>Dormant: 30 days</li>
                            </ul>
                            <strong>Global Settings:</strong>
                            <ul>
                                <li>Storage Threshold: 20 GB</li>
                            </ul>
                            <strong>Behavior:</strong> Only cleans up when storage drops below 20GB, aggressive deletion
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Grace Periods -->
    <div class="card mb-3" id="grace-periods">
        <div class="card-header bg-warning">
            <h4 class="mb-0"><i class="fas fa-clock me-2"></i>Grace Periods & Time-Based Cleanup</h4>
        </div>
        <div class="card-body">
            <p>Grace periods free up space from inactive shows while preserving your position so you can always resume where you left off.</p>
            
            <div class="alert alert-info">
                <h6><i class="fas fa-bookmark me-2"></i>Bookmark Preservation System</h6>
                <p class="mb-0">Grace periods now keep "bookmarks" so you never lose your place! Even after cleanup, you keep:
                <ul class="mb-0">
                    <li><strong>Last watched episode</strong> - Your "finished watching" bookmark</li>
                    <li><strong>Next unwatched episode</strong> - Your "resume here" bookmark</li>
                </ul>
                This means you can pick up exactly where you left off, even months later.
                </p>
            </div>
            
            <div class="row mt-3">
                <div class="col-md-4">
                    <div class="card h-100">
                        <div class="card-header bg-light">
                            <h6><i class="fas fa-eye text-success me-2"></i>Grace Watched</h6>
                        </div>
                        <div class="card-body">
                            <p><strong>What:</strong> Deletes all watched episodes EXCEPT the last one after X days of inactivity</p>
                            <p><strong>Exception:</strong> Keeps most recent watched episode (reference point)</p>
                            <p><strong>Overrides:</strong> Keep settings (independent cleanup)</p>
                            <p><strong>Example:</strong> Grace Watched: 14 days<br>
                            ‚Üí Watch S2E1-E5<br>
                            ‚Üí 14 days later (no activity)<br>
                            ‚Üí Delete S2E1-E4, keep S2E5 (bookmark)<br>
                            ‚Üí Marked as cleaned until you watch again</p>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <div class="card h-100">
                        <div class="card-header bg-light">
                            <h6><i class="fas fa-forward text-warning me-2"></i>Grace Unwatched</h6>
                        </div>
                        <div class="card-body">
                            <p><strong>What:</strong> Deletes unwatched episodes after X days (watch deadline)</p>
                            <p><strong>Exception:</strong> Keeps next unwatched episode (resume point)</p>
                            <p><strong>Overrides:</strong> Get settings (independent cleanup)</p>
                            <p><strong>Use case:</strong> Clear backlog while keeping position</p>
                            <p><strong>Example:</strong> Grace Unwatched: 10 days<br>
                            ‚Üí Got S2E6, S2E7, S2E8<br>
                            ‚Üí 10 days later (didn't watch any)<br>
                            ‚Üí Delete S2E7, S2E8<br>
                            ‚Üí Keep S2E6 (next episode bookmark)</p>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <div class="card h-100">
                        <div class="card-header bg-light">
                            <h6><i class="fas fa-ban text-danger me-2"></i>Dormant Timer</h6>
                        </div>
                        <div class="card-body">
                            <p><strong>What:</strong> Nuclear option for abandoned shows</p>
                            <p><strong>When it expires:</strong> Deletes EVERYTHING (all episodes)</p>
                            <p><strong>Reset by:</strong> Watching ANY episode in the series</p>
                            <p><strong>Use case:</strong> Final cleanup for shows you'll never return to</p>
                            <p><strong>Example:</strong> Dormant: 60 days<br>
                            ‚Üí No activity for 60 days<br>
                            ‚Üí Delete entire show (no bookmarks)</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="alert alert-success mt-3">
                <h6><i class="fas fa-lightbulb me-2"></i>How Grace Periods Work Together</h6>
                <p><strong>Grace Watched + Grace Unwatched:</strong> Maximum space savings while preserving position</p>
                <ul class="mb-0">
                    <li>After inactivity, you're left with just 2 episodes: last watched + next unwatched</li>
                    <li>Both bookmarks preserved automatically</li>
                    <li>Can resume anytime, even months later</li>
                </ul>
            </div>
            
            <div class="alert alert-primary mt-3">
                <h6><i class="fas fa-sync me-2"></i>Cleanup Loop Behavior</h6>
                <p><strong>How grace cleanup stops and starts:</strong></p>
                <ul class="mb-2">
                    <li><strong>Has bookmark:</strong> Marked as cleaned ‚Üí Won't check again until you watch</li>
                    <li><strong>Missing next episode:</strong> Keeps checking daily until episode grabbed</li>
                    <li><strong>Watch activity:</strong> Clears flag ‚Üí Re-enters grace period after inactivity</li>
                </ul>
                <p class="mb-0"><strong>Webhooks required:</strong></p>
                <ul class="mb-0">
                    <li><strong>Watch webhook</strong> (Tautulli/Jellyfin): Clears grace_cleaned flag, applies Get rule</li>
                    <li><strong>Grab webhook</strong> (Sonarr): Sets grace_cleaned flag, stops checking loop</li>
                </ul>
            </div>

            <div class="alert alert-info mt-3">
                <h6><i class="fas fa-star me-2"></i>Grace Period Scope</h6>
                <p>Choose how grace timers are tracked:</p>
                <ul class="mb-0">
                    <li><strong>Per Series (default):</strong> One timer for entire show - watching ANY episode resets grace for ALL episodes</li>
                    <li><strong>Per Season:</strong> Independent timers per season - perfect for multi-viewer households where different people watch different seasons</li>
                </ul>
            </div>

            <div class="card bg-light mt-3">
                <div class="card-body">
                    <h6><i class="fas fa-question-circle me-2"></i>Grace vs Keep vs Dormant vs Always Have</h6>
                    <table class="table table-sm table-bordered mb-0">
                        <thead>
                            <tr>
                                <th>Setting</th>
                                <th>When It Acts</th>
                                <th>What It Does</th>
                                <th>Preserves Position?</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>Always Have</strong></td>
                                <td>On rule assignment + during cleanup</td>
                                <td>Downloads matching episodes, protects from deletion</td>
                                <td>N/A (these never leave)</td>
                            </tr>
                            <tr>
                                <td><strong>Keep</strong></td>
                                <td>Immediately after watching</td>
                                <td>Deletes beyond Keep window (real-time)</td>
                                <td>Yes (last_season/episode)</td>
                            </tr>
                            <tr>
                                <td><strong>Grace Watched</strong></td>
                                <td>After X days of inactivity</td>
                                <td>Deletes watched episodes except last one</td>
                                <td>Yes (keeps 1 watched bookmark)</td>
                            </tr>
                            <tr>
                                <td><strong>Grace Unwatched</strong></td>
                                <td>After X days of inactivity</td>
                                <td>Deletes unwatched episodes except first one</td>
                                <td>Yes (keeps 1 unwatched bookmark)</td>
                            </tr>
                            <tr>
                                <td><strong>Dormant</strong></td>
                                <td>After X days of inactivity</td>
                                <td>Deletes EVERYTHING (nuclear, ignores Always Have)</td>
                                <td>No (complete removal)</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <!-- Pending Deletions -->
    <div class="card mb-3" id="pending-deletions">
        <div class="card-header bg-warning">
            <h4 class="mb-0"><i class="fas fa-trash-alt me-2"></i>Pending Deletions - Approval System</h4>
        </div>
        <div class="card-body">
            <p class="lead">All deletions go through an approval queue first - giving you full control before anything is removed.</p>
            
            <div class="alert alert-success">
                <h6><i class="fas fa-shield-alt me-2"></i>Safety First</h6>
                <p class="mb-0">Dry run mode is now <strong>enabled by default</strong>. This means all cleanup operations queue deletions for your review instead of executing immediately.</p>
            </div>

            <h5 class="mt-4"><i class="fas fa-flow-chart text-primary me-2"></i>How It Works</h5>
            <ol>
                <li><strong>Cleanup Runs:</strong> Scheduled cleanup identifies episodes for deletion based on your rules</li>
                <li><strong>Queued for Review:</strong> Episodes are added to pending deletions (not deleted)</li>
                <li><strong>You Review:</strong> Visit the Pending page to see what would be deleted and why</li>
                <li><strong>You Decide:</strong> Approve (deletes immediately) or Reject (caches for 30 days)</li>
            </ol>

            <h5 class="mt-4"><i class="fas fa-list-check text-success me-2"></i>Review Options</h5>
            <div class="row">
                <div class="col-md-6">
                    <div class="card border-success mb-3">
                        <div class="card-header bg-success text-white">
                            <h6><i class="fas fa-check me-2"></i>Approval Levels</h6>
                        </div>
                        <div class="card-body">
                            <p>Approve deletions at multiple levels:</p>
                            <ul class="mb-0">
                                <li><strong>Individual Episodes:</strong> One at a time</li>
                                <li><strong>Entire Season:</strong> All episodes in a season</li>
                                <li><strong>Entire Series:</strong> All queued episodes</li>
                                <li><strong>Selected Episodes:</strong> Check boxes and bulk approve</li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="card border-secondary mb-3">
                        <div class="card-header bg-secondary text-white">
                            <h6><i class="fas fa-times me-2"></i>Rejection Behavior</h6>
                        </div>
                        <div class="card-body">
                            <p>When you reject an episode:</p>
                            <ul class="mb-0">
                                <li>Removed from pending queue</li>
                                <li>Cached for 30 days</li>
                                <li>Won't reappear during that time</li>
                                <li>After 30 days, can be flagged again</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <h5 class="mt-4"><i class="fas fa-info-circle text-info me-2"></i>What You See</h5>
            <p>Each pending deletion shows:</p>
            <div class="card border-info">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <ul>
                                <li><strong>Series/Season/Episode:</strong> Organized hierarchically</li>
                                <li><strong>Reason:</strong> Why it's marked (Grace Period, Keep Rule, Dormant, etc.)</li>
                                <li><strong>Rule Name:</strong> Which rule triggered it</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <ul>
                                <li><strong>Date Source:</strong> Tautulli or Sonarr air date</li>
                                <li><strong>Date Used:</strong> The actual date in the decision</li>
                                <li><strong>File Size:</strong> How much space you'll reclaim</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <h5 class="mt-4"><i class="fas fa-cog text-warning me-2"></i>Configuring Dry Run Mode</h5>
            <p>Dry run can be enabled at two levels:</p>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="card border-primary mb-3">
                        <div class="card-header bg-primary text-white">
                            <strong>Global Dry Run</strong>
                        </div>
                        <div class="card-body">
                            <p><strong>Location:</strong> Admin ‚Üí Scheduler ‚Üí Global Dry Run Mode</p>
                            <p><strong>Effect:</strong> Applies to ALL rules</p>
                            <p class="mb-0"><strong>Default:</strong> ‚úÖ Enabled (for safety)</p>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="card border-success mb-3">
                        <div class="card-header bg-success text-white">
                            <strong>Per-Rule Dry Run</strong>
                        </div>
                        <div class="card-body">
                            <p><strong>Location:</strong> Admin ‚Üí Dry Run Settings ‚Üí By Rule</p>
                            <p><strong>Effect:</strong> Applies to specific rule only</p>
                            <p class="mb-0"><strong>Use case:</strong> Test one rule while others run normally</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="alert alert-info">
                <h6><i class="fas fa-lightbulb me-2"></i>How They Work Together</h6>
                <p class="mb-0">If <strong>either</strong> global OR per-rule dry run is enabled, deletions are queued for approval. This gives you maximum flexibility - protect everything globally or test individual rules.</p>
            </div>

            <h5 class="mt-4"><i class="fas fa-bell text-primary me-2"></i>Notifications</h5>
            <p>The navigation badge shows combined pending items:</p>
            <ul>
                <li><strong>Pending Requests:</strong> Episode selection requests</li>
                <li><strong>Pending Deletions:</strong> Episodes awaiting approval</li>
                <li><strong>Badge:</strong> Shows total count of both</li>
            </ul>

            <h5 class="mt-4"><i class="fas fa-thumbs-up text-success me-2"></i>Best Practices</h5>
            <div class="card border-success">
                <div class="card-body">
                    <ol class="mb-0">
                        <li><strong>Start with dry run enabled</strong> (default) - Review deletions for a few weeks</li>
                        <li><strong>Check pending deletions regularly</strong> - Weekly or after each cleanup run</li>
                        <li><strong>Create proper rules</strong> instead of repeatedly rejecting the same content</li>
                        <li><strong>Monitor the logs</strong> to understand why episodes are targeted</li>
                        <li><strong>Use rule-specific dry run</strong> to test changes to individual rules</li>
                    </ol>
                </div>
            </div>

            <div class="alert alert-warning mt-3">
                <h6><i class="fas fa-exclamation-triangle me-2"></i>Important Notes</h6>
                <ul class="mb-0">
                    <li><strong>Rejection is temporary:</strong> Use proper rules for permanent protection</li>
                    <li><strong>Dry run doesn't affect "Get":</strong> New episodes are still monitored/searched</li>
                    <li><strong>Badge updates every 30 seconds:</strong> Reflects real-time pending count</li>
                    <li><strong>Approved deletions execute immediately:</strong> No undo after approval</li>
                </ul>
            </div>
        </div>
    </div>
    <!-- Workflows -->
    <div class="card mb-3" id="workflows">
        <div class="card-header bg-info text-white">
            <h4 class="mb-0"><i class="fas fa-project-diagram me-2"></i>Sonarr Workflows</h4>
        </div>
        <div class="card-body">
            <p>Episeerr integrates with Sonarr using tags to trigger different workflows:</p>
            
            <h5 class="mt-3">Tag-Based Workflows:</h5>
            <div class="row">
                <div class="col-md-6">
                    <div class="card border-success mb-3">
                        <div class="card-header bg-success text-white">
                            <h6><i class="fas fa-tags me-2"></i>Rule Tags</h6>
                        </div>
                        <div class="card-body">
                            <p><strong>Direct Rule Assignment</strong></p>
                            <p>Tag shows with <code>episeerr_[rule_name]</code> to process immediately:</p>
                            <ul>
                                <li><code>episeerr_one_at_a_time</code></li>
                                <li><code>episeerr_gracewatched</code></li>
                                <li><code>episeerr_keepall</code></li>
                                <li>Or any rule you've created</li>
                            </ul>
                            <p><strong>How it works:</strong></p>
                            <ol>
                                <li>Add rule tag to show in Sonarr</li>
                                <li>Episeerr processes immediately</li>
                                <li>Episodes managed by that rule</li>
                            </ol>
                            <p class="text-muted"><small>Perfect for shows you want managed by a specific rule</small></p>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="card border-warning mb-3">
                        <div class="card-header bg-warning">
                            <h6><i class="fas fa-hand-pointer me-2"></i>episeerr_select</h6>
                        </div>
                        <div class="card-body">
                            <p><strong>Manual Episode Selection</strong></p>
                            <ol>
                                <li>Add tag to show in Sonarr</li>
                                <li>Creates selection request in Episeerr</li>
                                <li>You manually pick episodes</li>
                                <li>Tag removed after selection</li>
                            </ol>
                            <p class="text-muted"><small>Perfect for catching up or selecting specific episodes</small></p>
                        </div>
                    </div>
                </div>
            </div>

            <h5 class="mt-3">Auto-Assign (Separate Feature):</h5>
            <div class="alert alert-info">
                <p><strong>Auto-assign is independent from tags</strong> - it automatically adds new shows to your default rule when they're added to Sonarr without any tags.</p>
                <ul class="mb-0">
                    <li><strong>Enable it:</strong> New shows automatically join default rule (waits for first watch)</li>
                    <li><strong>Disable it:</strong> Only tagged shows get managed</li>
                    <li><strong>Works together:</strong> You can use BOTH auto-assign AND direct rule tags</li>
                </ul>
                <p class="mb-0 mt-2"><small>See the <a href="#auto-assign">Auto-Assign section</a> below for full details.</small></p>
            </div>

            <h5 class="mt-3">Jellyseerr/Overseerr Integration:</h5>
            <div class="alert alert-info">
                <p>When requesting shows through Jellyseerr/Overseerr:</p>
                <ul class="mb-0">
                    <li>Request gets sent to Sonarr</li>
                    <li>Episeerr captures the requested seasons</li>
                    <li>If auto-assign is ON, automatically adds to default rule</li>
                    <li>If you tagged it with a rule tag, uses that rule instead</li>
                    <li>Season-aware: starts from the season you requested, not always Season 1</li>
                </ul>
            </div>
        </div>
    </div>
    <!-- Tag Management & Drift Detection -->
    <div class="card mb-3" id="tag-management">
        <div class="card-header bg-success text-white">
            <h4 class="mb-0"><i class="fas fa-tags me-2"></i>Tag Management & Drift Detection</h4>
        </div>
        <div class="card-body">
            <p class="lead">Tags are automatically created and managed by Episeerr. You don't need to manually create or maintain them.</p>
            
            <h5 class="mt-4">How Tags Work:</h5>
            <ol>
                <li><strong>When you create a rule</strong> called "binge_watcher":
                    <ul>
                        <li>Episeerr creates <code>episeerr_binge_watcher</code> tag in Sonarr automatically</li>
                        <li>Tag is added to Sonarr's delay profile (if configured)</li>
                    </ul>
                </li>
                <li><strong>When series is assigned to that rule</strong>:
                    <ul>
                        <li>Episeerr applies <code>episeerr_binge_watcher</code> tag to the series in Sonarr</li>
                        <li>Tag indicates which rule manages this series</li>
                    </ul>
                </li>
                <li><strong>If you manually change the tag in Sonarr</strong>:
                    <ul>
                        <li>Episeerr detects the drift (on next watch, cleanup, or startup)</li>
                        <li>Automatically moves the series to the correct rule in config</li>
                        <li>Your manual tag change becomes the new source of truth</li>
                    </ul>
                </li>
                <li><strong>When you delete a rule</strong>:
                    <ul>
                        <li>Tag removed from all series</li>
                        <li>Tag removed from Sonarr entirely</li>
                        <li>Tag removed from delay profile</li>
                    </ul>
                </li>
            </ol>

            <h5 class="mt-4">Drift Detection:</h5>
            <p>Episeerr checks for tag mismatches in 4 places:</p>
            <div class="row">
                <div class="col-md-3">
                    <div class="card border-primary mb-2">
                        <div class="card-body text-center">
                            <i class="fas fa-eye fa-2x text-primary mb-2"></i>
                            <p class="mb-0"><strong>Watch Webhooks</strong><br><small>When you watch an episode</small></p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card border-success mb-2">
                        <div class="card-body text-center">
                            <i class="fas fa-clock fa-2x text-success mb-2"></i>
                            <p class="mb-0"><strong>Cleanup Cycles</strong><br><small>Every 6 hours (configurable)</small></p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card border-warning mb-2">
                        <div class="card-body text-center">
                            <i class="fas fa-power-off fa-2x text-warning mb-2"></i>
                            <p class="mb-0"><strong>Startup</strong><br><small>When Episeerr starts</small></p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card border-info mb-2">
                        <div class="card-body text-center">
                            <i class="fas fa-broom fa-2x text-info mb-2"></i>
                            <p class="mb-0"><strong>Clean Config</strong><br><small>When you click button</small></p>
                        </div>
                    </div>
                </div>
            </div>

            <h5 class="mt-4">What Gets Detected:</h5>
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th>Scenario</th>
                        <th>Detection</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Tag changed in Sonarr</td>
                        <td><span class="badge bg-success">‚úì Detected</span></td>
                        <td>Series moved to matching rule</td>
                    </tr>
                    <tr>
                        <td>Tag removed in Sonarr</td>
                        <td><span class="badge bg-success">‚úì Detected</span></td>
                        <td>Tag re-added from config</td>
                    </tr>
                    <tr>
                        <td>Tag added to unmanaged series</td>
                        <td><span class="badge bg-success">‚úì Detected</span></td>
                        <td>Series added to that rule</td>
                    </tr>
                </tbody>
            </table>

            <div class="alert alert-success mt-3">
                <h6><i class="fas fa-magic me-2"></i>Tag-Based Management</h6>
                <p class="mb-0">You can manage series assignment <strong>entirely through Sonarr tags</strong> if you prefer! 
                Just tag shows in Sonarr with <code>episeerr_rulename</code> and Episeerr will automatically detect and assign them. 
                No need to use the Episeerr UI at all.</p>
            </div>

            <h5 class="mt-4">Example Workflow:</h5>
            <div class="card bg-light">
                <div class="card-body">
                    <p><strong>Scenario:</strong> Series "Breaking Bad" is in "binge_watcher" rule</p>
                    <ol>
                        <li>You manually change tag to <code>episeerr_weekly</code> in Sonarr</li>
                        <li>Next time Episeerr checks (watch/cleanup/startup/clean_config):
                            <ul>
                                <li>‚úì Detects drift</li>
                                <li>‚úì Moves "Breaking Bad" from "binge_watcher" to "weekly" rule</li>
                                <li>‚úì Series now managed by "weekly" rule</li>
                            </ul>
                        </li>
                    </ol>
                    <p class="mb-0"><em>Your manual tag change in Sonarr becomes the new source of truth!</em></p>
                </div>
            </div>

            <h5 class="mt-4">Rule Descriptions:</h5>
            <p>Add optional descriptions to rules to document their purpose:</p>
            <ul>
                <li>Hover over rule names to see descriptions as tooltips</li>
                <li>Helps organize and understand multiple rules</li>
                <li>Examples: "Weekly shows I'm actively watching", "Binge-watching mode - get full seasons"</li>
            </ul>
        </div>
    </div>
    <!-- Integration -->
    <div class="card mb-3" id="integration">
        <div class="card-header bg-secondary text-white">
            <h4 class="mb-0"><i class="fas fa-plug me-2"></i>Webhook Integration</h4>
        </div>
        <div class="card-body">
            <h5>Supported Services:</h5>
            <div class="row">
                <div class="col-md-4">
                <h6><i class="fas fa-chart-bar text-primary me-2"></i>Tautulli</h6>
                <p>Tracks viewing activity in Plex</p>
                <pre class="bg-dark text-light p-2"><code>Webhook URL:
            http://your-server:5002/webhook

            Trigger:
            Playback Stop</code></pre>
            </div>

            <div class="col-md-4">
                <h6><i class="fas fa-film text-success me-2"></i>Jellyfin (3 Modes)</h6>
                <p class="small mb-1"><strong>Mode 1:</strong> PlaybackProgress (real-time)</p>
                <p class="small mb-1"><strong>Mode 2:</strong> Session Start/Stop (polling)</p>
                <p class="small mb-2"><strong>Mode 3:</strong> Playback Stop (on-stop)</p>
                <pre class="bg-dark text-light p-2"><code>Webhook URL:
            http://your-server:5002/jellyfin-webhook

            Trigger: (depends on mode)
            See full guide below</code></pre>
                <p class="small mb-0">
                    <a href="https://github.com/Vansmak/episeerr/blob/main/docs/configuration/webhook-setup.md" target="_blank" class="text-decoration-none">
                        üìñ Full Jellyfin Setup Guide ‚Üí
                    </a>
                </p>
            </div>

            <div class="col-md-4">
                <h6><i class="fas fa-tv text-warning me-2"></i>Sonarr</h6>
                <p>Detects new series additions</p>
                <pre class="bg-dark text-light p-2"><code>Webhook URL:
            http://your-server:5002/sonarr-webhook

            Trigger:
            On Series Add</code></pre>
            </div>
            </div>
        </div>
    </div>

    <!-- Delay Profiles Deep Dive -->
    <div class="card mb-3" id="delay-profiles">
        <div class="card-header bg-warning">
            <h4 class="mb-0"><i class="fas fa-stopwatch me-2"></i>Delay Profiles - Critical Setup</h4>
        </div>
        <div class="card-body">
            <div class="alert alert-danger">
                <strong><i class="fas fa-exclamation-triangle me-2"></i>CRITICAL:</strong> Without delay profiles configured correctly in Sonarr, Episeerr CANNOT control episode downloads!
            </div>

            <h5>What Delay Profiles Do:</h5>
            <p>Delay profiles tell Sonarr to <strong>wait</strong> before automatically downloading episodes. This gives Episeerr control over which episodes get downloaded.</p>

            <div class="row">
                <div class="col-md-6">
                    <div class="card border-danger mb-3">
                        <div class="card-header bg-danger text-white">
                            <strong>‚ùå WITHOUT Delay Profile</strong>
                        </div>
                        <div class="card-body">
                            <p><strong>What happens:</strong></p>
                            <ol>
                                <li>Add show to Sonarr</li>
                                <li>Sonarr immediately downloads ALL episodes</li>
                                <li>Episeerr can't control anything</li>
                                <li>Your disk fills up</li>
                                <li>Rules don't work</li>
                            </ol>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="card border-success mb-3">
                        <div class="card-header bg-success text-white">
                            <strong>‚úÖ WITH Delay Profile</strong>
                        </div>
                        <div class="card-body">
                            <p><strong>What happens:</strong></p>
                            <ol>
                                <li>Add show to Sonarr</li>
                                <li>Episodes stay "monitored" but NOT downloaded</li>
                                <li>Episeerr tells Sonarr which episodes to grab</li>
                                <li>Only get what you need</li>
                                <li>Rules work perfectly</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>

            <h5 class="mt-3">Step-by-Step Setup:</h5>
            <ol>
                <li>
                    <strong>Open Sonarr</strong>
                    <ul>
                        <li>Navigate to <strong>Settings ‚Üí Profiles ‚Üí Delay Profiles</strong></li>
                    </ul>
                </li>
                <li>
                    <strong>Create New Profile or Edit Default</strong>
                    <ul>
                        <li>Click the <strong>+</strong> button to add new</li>
                    </ul>
                </li>
                <li>
                    <strong>Set Infinite Delays</strong>
                    <ul>
                        <li><strong>Usenet Delay:</strong> <code>999999</code> minutes</li>
                        <li><strong>Torrent Delay:</strong> <code>999999</code> minutes</li>
                        <li>This essentially disables auto-downloading</li>
                    </ul>
                </li>
                <li>
                    <strong>Assign Tags (IMPORTANT)</strong>
                    <ul>
                        <li><strong>Tags:</strong> <code>episeerr_[rule_name]</code>, <code>episeerr_select</code></li>
                        <li>Any show with these tags will use this delay profile</li>
                    </ul>
                </li>
                <li>
                    <strong>Set Priority</strong>
                    <ul>
                        <li>Preferred Protocol: Doesn't matter (Episeerr will handle it)</li>
                    </ul>
                </li>
                <li>
                    <strong>Save</strong>
                </li>
            </ol>

            <div class="card bg-light mt-3">
                <div class="card-body">
                    <h6><i class="fas fa-info-circle text-info me-2"></i>Example Configuration:</h6>
                    <pre class="bg-dark text-light p-2 mb-0"><code>Delay Profile Name: Episeerr Managed Shows
Usenet Delay: 999999 minutes
Torrent Delay: 999999 minutes
Tags: episeerr_[rule_name], episeerr_select
Order: 1 (higher priority)</code></pre>
                </div>
            </div>

            <div class="alert alert-info mt-3">
                <h6><i class="fas fa-lightbulb me-2"></i>Pro Tips:</h6>
                <ul class="mb-0">
                    <li><strong>Multiple Profiles:</strong> Create separate delay profiles for Episeerr shows vs regular shows</li>
                    <li><strong>Order Matters:</strong> Episeerr delay profile should be higher priority (lower order number)</li>
                    <li><strong>Test It:</strong> Add a show with <code>episeerr_[rule_name]</code> tag and verify it doesn't auto-download</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Auto-Assign -->
    <div class="card mb-3" id="auto-assign">
        <div class="card-header bg-info text-white">
            <h4 class="mb-0"><i class="fas fa-magic me-2"></i>Auto-Assign New Series</h4>
        </div>
        <div class="card-body">
            <p><strong>Auto-assign is a separate feature from tags</strong> - it automatically adds new shows to your default rule when they're added to Sonarr <strong>WITHOUT any tags</strong>.</p>

            <h5>How It Works:</h5>
            <div class="row">
                <div class="col-md-6">
                    <div class="card border-secondary mb-3">
                        <div class="card-header bg-light">
                            <strong>‚ùå Auto-Assign: OFF</strong>
                        </div>
                        <div class="card-body">
                            <p><strong>What happens:</strong></p>
                            <ol>
                                <li>Add show to Sonarr</li>
                                <li>Nothing happens (unless you tag it)</li>
                                <li>Must use rule tags to manage</li>
                                <li>Or use <code>episeerr_select</code> for manual selection</li>
                            </ol>
                            <p class="text-muted"><small>Only tagged shows get managed</small></p>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="card border-success mb-3">
                        <div class="card-header bg-success text-white">
                            <strong>‚úÖ Auto-Assign: ON</strong>
                        </div>
                        <div class="card-body">
                            <p><strong>What happens:</strong></p>
                            <ol>
                                <li>Add show to Sonarr (no tags)</li>
                                <li>Episeerr automatically assigns to default rule</li>
                                <li>Waits for first watch to start processing</li>
                                <li>Zero manual work!</li>
                            </ol>
                            <p class="text-muted"><small>Passive assignment - waits for viewing activity</small></p>
                        </div>
                    </div>
                </div>
            </div>

            <h5 class="mt-3">Tags and Auto-Assign Work Together:</h5>
            <div class="alert alert-success">
                <p><strong>You can use BOTH at the same time:</strong></p>
                <ul class="mb-0">
                    <li><strong>Tagged shows:</strong> Process immediately with their rule tag</li>
                    <li><strong>Untagged shows (with auto-assign ON):</strong> Automatically join default rule</li>
                    <li><strong>Untagged shows (with auto-assign OFF):</strong> Not managed at all</li>
                </ul>
            </div>

            <h5 class="mt-3">When to Enable Auto-Assign:</h5>
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th>Scenario</th>
                        <th>Auto-Assign Setting</th>
                        <th>Reason</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>All shows managed by Episeerr</td>
                        <td><span class="badge bg-success">ON</span></td>
                        <td>Automatic - every new show gets managed</td>
                    </tr>
                    <tr>
                        <td>Mix of Episeerr + regular shows</td>
                        <td><span class="badge bg-danger">OFF</span></td>
                        <td>Manual control - only tagged shows managed</td>
                    </tr>
                    <tr>
                        <td>Using Jellyseerr/Overseerr</td>
                        <td><span class="badge bg-success">ON</span></td>
                        <td>Requests automatically managed</td>
                    </tr>
                    <tr>
                        <td>Testing/Learning Episeerr</td>
                        <td><span class="badge bg-danger">OFF</span></td>
                        <td>Better control during learning phase</td>
                    </tr>
                </tbody>
            </table>

            <h5 class="mt-3">How to Enable/Disable:</h5>
            <ol>
                <li>Go to <strong>Settings</strong> (in sidebar)</li>
                <li>Find <strong>Global Storage Gate</strong> card at top</li>
                <li>Check/Uncheck <strong>"Auto-assign new series"</strong></li>
                <li>Click <strong>Save Global Settings</strong></li>
            </ol>

            <div class="alert alert-warning mt-3">
                <h6><i class="fas fa-exclamation-triangle me-2"></i>Important Notes:</h6>
                <ul class="mb-0">
                    <li><strong>Only affects NEW shows:</strong> Existing shows are not automatically assigned</li>
                    <li><strong>Requires default rule:</strong> Must have at least one rule marked as "default"</li>
                    <li><strong>Tags override auto-assign:</strong> If a show has a rule tag or <code>episeerr_select</code>, it uses that instead</li>
                    <li><strong>Works with *seerr:</strong> Shows requested through Jellyseerr/Overseerr are auto-assigned if enabled</li>
                    <li><strong>Passive mode:</strong> Auto-assigned shows wait for first watch before processing</li>
                </ul>
            </div>

            <h5 class="mt-3">Workflow Comparison:</h5>
            <div class="row">
                <div class="col-md-6">
                    <h6>Manual Workflow (Auto-Assign OFF):</h6>
                    <ol>
                        <li>Add show in Sonarr</li>
                        <li>Go to Sonarr ‚Üí Series ‚Üí Select show</li>
                        <li>Add rule tag (e.g., <code>episeerr_one_at_a_time</code>)</li>
                        <li>Save</li>
                        <li>Episeerr processes via webhook</li>
                    </ol>
                </div>
                <div class="col-md-6">
                    <h6>Automatic Workflow (Auto-Assign ON):</h6>
                    <ol>
                        <li>Add show in Sonarr</li>
                        <li><em>That's it!</em></li>
                        <li>Episeerr automatically assigns and manages</li>
                        <li>Zero extra steps</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>


    <!-- Troubleshooting -->
<div class="card mb-3" id="troubleshooting">
    <div class="card-header bg-danger text-white">
        <h4 class="mb-0"><i class="fas fa-wrench me-2"></i>Troubleshooting</h4>
    </div>
    <div class="card-body">
        <h5>Common Issues:</h5>
        
        <!-- EXISTING CARD 1 -->
        <div class="card mb-3">
            <div class="card-header">
                <strong>Episodes aren't being processed</strong>
            </div>
            <div class="card-body">
                <p><strong>Check:</strong></p>
                <ul>
                    <li>Is the series assigned to a rule?</li>
                    <li>Are webhooks configured and firing?</li>
                    <li>Check logs: Admin ‚Üí View Logs ‚Üí episeerr.log</li>
                    <li>Verify Sonarr tags are correct (episeerr_[rule_name] or episeerr_select)</li>
                </ul>
            </div>
        </div>

        <!-- EXISTING CARD 2 -->
        <div class="card mb-3">
            <div class="card-header">
                <strong>Episodes deleted too quickly</strong>
            </div>
            <div class="card-body">
                <p><strong>Solution:</strong></p>
                <ul>
                    <li>Increase Grace Watched/Unwatched periods</li>
                    <li>Check if Dormant timer is too short</li>
                    <li>Consider changing Keep settings to retain more episodes</li>
                </ul>
            </div>
        </div>

        <!-- EXISTING CARD 3 -->
        <div class="card mb-3">
            <div class="card-header">
                <strong>Nothing is being deleted</strong>
            </div>
            <div class="card-body">
                <p><strong>Check:</strong></p>
                <ul>
                    <li>Is cleanup scheduler running? (Admin ‚Üí Scheduler Status)</li>
                    <li>Check Storage Gate - cleanup only runs when below threshold</li>
                    <li>Verify grace periods aren't too long</li>
                    <li>Check if Dry Run Mode is enabled globally</li>
                </ul>
            </div>
        </div>

        <!-- NEW CARD 4 - ADD THIS -->
        <div class="card mb-3">
            <div class="card-header">
                <strong>Episodes showing in pending deletions but I want to keep them</strong>
            </div>
            <div class="card-body">
                <p><strong>Solution:</strong></p>
                <ul>
                    <li><strong>Reject the deletion:</strong> Removes it for 30 days</li>
                    <li><strong>Better solution:</strong> Create a rule with no cleanup parameters (leave grace periods empty)</li>
                    <li><strong>Adjust existing rule:</strong> Increase grace periods or change dormant timer</li>
                    <li><strong>Check why it's targeted:</strong> Review the "Reason" field in pending deletions</li>
                </ul>
            </div>
        </div>

        <!-- NEW CARD 5 - ADD THIS -->
        <div class="card mb-3">
            <div class="card-header">
                <strong>Badge shows pending count but page shows nothing</strong>
            </div>
            <div class="card-body">
                <p><strong>Check:</strong></p>
                <ul>
                    <li>Refresh the page (F5)</li>
                    <li>Check browser console for JavaScript errors</li>
                    <li>Verify /api/pending-deletions/count endpoint is working</li>
                    <li>Clear browser cache and reload</li>
                </ul>
            </div>
        </div>
    </div>
</div>

    <!-- FAQ -->
    <div class="card mb-3" id="faq">
        <div class="card-header bg-dark text-white">
            <h4 class="mb-0"><i class="fas fa-question-circle me-2"></i>Frequently Asked Questions</h4>
        </div>
        <div class="card-body">
            <dl>
                <dt>Q: Which webhooks do I need?</dt>
                <dd>
                    <strong>A: It depends on your setup:</strong>
                    <ul>
                        <li><strong>Sonarr webhook:</strong> ‚úÖ REQUIRED - Detects new series and processes tags (episeerr_[rule_name]/episeerr_select)</li>
                        <li><strong>Jellyseerr/Overseerr webhook:</strong> ‚úÖ REQUIRED if you use *seerr - Captures requested seasons for proper automation</li>
                        <li><strong>Tautulli/Jellyfin webhook:</strong> ‚öôÔ∏è OPTIONAL - Only needed for viewing-based automation (auto-get next episode after watching)</li>
                    </ul>
                    <p class="mb-0"><em>Without viewing webhooks, you can still use manual selection and time-based cleanup rules.</em></p>
                </dd>
                
                <dt>Q: Can I use multiple rules?</dt>
                <dd>A: Yes! Create different rules for different types of shows (weekly vs binge, kids vs adults, etc.)</dd>
                
                <dt>Q: What happens if I don't set grace periods?</dt>
                <dd>A: Without grace periods, episodes are deleted immediately based on Keep settings only.</dd>
                
                <dt>Q: Can I test rules without actually deleting?</dt>
                <dd>A: Yes! Enable Dry Run Mode in Admin ‚Üí Global Settings, or set it per-rule.</dd>
                
                <dt>Q: How do I know what's being deleted?</dt>
                <dd>A: Check Admin ‚Üí View Logs ‚Üí cleanup.log for detailed deletion logs.</dd>
                
                <dt>Q: What is "Pending Deletions"?</dt>
                <dd>
                    <strong>A:</strong> A safety system that queues all deletions for your review before executing them. 
                    When dry run mode is enabled (default), cleanup operations add episodes to a pending queue instead of 
                    deleting immediately. You review the queue and approve or reject each deletion.
                </dd>

                <dt>Q: Why aren't episodes being deleted?</dt>
                <dd>
                    <strong>A:</strong> Check if dry run mode is enabled (Admin ‚Üí Scheduler ‚Üí Global Dry Run Mode). 
                    When enabled, all deletions go to the Pending page for review. This is the default behavior for safety. 
                    Review and approve deletions from the Pending page, or disable dry run if you want automatic deletion.
                </dd>

                <dt>Q: What happens if I reject an episode deletion?</dt>
                <dd>
                    <strong>A:</strong> The episode is removed from the pending queue and cached for 30 days. It won't 
                    appear in pending deletions again during that time. After 30 days, if cleanup rules still target it, 
                    it will reappear. For permanent protection, create a rule with no cleanup parameters.
                </dd>

                <dt>Q: Can I approve/reject multiple episodes at once?</dt>
                <dd>
                    <strong>A:</strong> Yes! You can approve or reject at multiple levels:
                    <ul>
                        <li>Individual episodes (one at a time)</li>
                        <li>Entire seasons (all episodes in that season)</li>
                        <li>Entire series (all pending episodes for that show)</li>
                        <li>Selected episodes (check boxes and bulk approve/reject)</li>
                    </ul>
                </dd>

                <dt>Q: What's the difference between global and per-rule dry run?</dt>
                <dd>
                    <strong>A:</strong> 
                    <ul>
                        <li><strong>Global dry run:</strong> Affects ALL rules - all deletions are queued</li>
                        <li><strong>Per-rule dry run:</strong> Affects only that specific rule - lets you test individual rules</li>
                        <li><strong>Either one enabled:</strong> Deletions are queued for approval</li>
                    </ul>
                    Use global dry run when learning Episeerr, per-rule dry run when testing changes to specific rules.
                </dd>

                <dt>Q: Can different family members watch different seasons?</dt>
                <dd>A: Yes! Use "Grace Scope: Per Season" in your rule settings.</dd>

                <dt>Q: Why is polling running when I use PlaybackProgress?</dt>
                <dd>A: (Fixed v2.9.8) System now auto-detects mode. If you have TRIGGER_MIN/MAX but no POLL_INTERVAL, polling is disabled automatically.</dd>

                <dt>Q: Why 404 errors for deleted series?</dt>
                <dd>A: (Fixed v2.9.8) Series auto-removed from config on startup. 404s logged as DEBUG, not ERROR.</dd>
            </dl>
        </div>
    </div>


    <!-- Support -->
    <div class="card mb-3">
        <div class="card-header bg-info text-white">
            <h4 class="mb-0"><i class="fas fa-life-ring me-2"></i>Need Help?</h4>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4">
                    <h6><i class="fab fa-github me-2"></i>GitHub</h6>
                    <p>Report issues or request features</p>
                    <a href="https://github.com/vansmak/episeerr/issues" target="_blank" class="btn btn-sm btn-outline-dark">
                        <i class="fas fa-external-link-alt me-1"></i>GitHub Issues
                    </a>
                </div>
                <div class="col-md-4">
                    <h6><i class="fab fa-docker me-2"></i>Docker Hub</h6>
                    <p>Check for updates and releases</p>
                    <a href="https://hub.docker.com/r/vansmak/episeerr" target="_blank" class="btn btn-sm btn-outline-info">
                        <i class="fas fa-external-link-alt me-1"></i>Docker Hub
                    </a>
                </div>
                <div class="col-md-4">
                    <h6><i class="fas fa-book me-2"></i>README</h6>
                    <p>Full documentation on GitHub</p>
                    <a href="https://github.com/vansmak/episeerr#readme" target="_blank" class="btn btn-sm btn-outline-success">
                        <i class="fas fa-external-link-alt me-1"></i>Documentation
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* ==================== ROOT VARIABLES ==================== */
:root {
  /* Light mode (default) */
  --bg-primary: #ffffff;
  --bg-secondary: #f8f9fa;
  --bg-card: #ffffff;
  --text-primary: #212529;
  --text-secondary: #6c757d;
  --text-muted: #6c757d;
  --border-color: #dee2e6;
  --code-bg: #f8f9fa;
  --code-text: #212529;
  --pre-bg: #212529;
  --pre-text: #f8f9fa;
}

/* Dark mode */
@media (prefers-color-scheme: dark) {
  :root {
    --bg-primary: #1a1a1a;
    --bg-secondary: #2d2d2d;
    --bg-card: #252525;
    --text-primary: #e0e0e0;
    --text-secondary: #b0b0b0;
    --text-muted: #888888;
    --border-color: #404040;
    --code-bg: #2d2d2d;
    --code-text: #e0e0e0;
    --pre-bg: #1a1a1a;
    --pre-text: #e0e0e0;
  }
  
  /* Override Bootstrap colors for dark mode */
  body {
    background-color: var(--bg-primary) !important;
    color: var(--text-primary) !important;
  }
  
  .card {
    background-color: var(--bg-card) !important;
    border-color: var(--border-color) !important;
    color: var(--text-primary) !important;
  }
  
  .card-body {
    color: var(--text-primary) !important;
  }
  
  .text-muted {
    color: var(--text-muted) !important;
  }
  
  /* Tables */
  .table {
    color: var(--text-primary) !important;
    border-color: var(--border-color) !important;
  }
  
  .table thead th {
    background-color: var(--bg-secondary) !important;
    border-color: var(--border-color) !important;
  }
  
  .table tbody tr {
    border-color: var(--border-color) !important;
  }
  
  .table-bordered {
    border-color: var(--border-color) !important;
  }
  
  /* Code blocks */
  code {
    background-color: var(--code-bg) !important;
    color: var(--code-text) !important;
  }
  
  pre {
    background-color: var(--pre-bg) !important;
    color: var(--pre-text) !important;
  }
  
  /* Alerts */
  .alert {
    border-color: var(--border-color) !important;
  }
  
  .alert-info {
    background-color: #1a3a4a !important;
    color: #9dd9f3 !important;
  }
  
  .alert-warning {
    background-color: #4a3a1a !important;
    color: #f3d99d !important;
  }
  
  .alert-danger {
    background-color: #4a1a1a !important;
    color: #f39d9d !important;
  }
  
  .alert-success {
    background-color: #1a4a2a !important;
    color: #9df3b0 !important;
  }
  
  /* Light backgrounds in dark mode */
  .bg-light {
    background-color: var(--bg-secondary) !important;
    color: var(--text-primary) !important;
  }
  
  /* Accordion */
  .accordion-button {
    background-color: var(--bg-card) !important;
    color: var(--text-primary) !important;
  }
  
  .accordion-button:not(.collapsed) {
    background-color: var(--bg-secondary) !important;
    color: var(--text-primary) !important;
  }
  
  .accordion-body {
    background-color: var(--bg-card) !important;
    color: var(--text-primary) !important;
  }
  
  /* Links */
  a {
    color: #4da6ff !important;
  }
  
  a:hover {
    color: #80c0ff !important;
  }
  
  /* Buttons */
  .btn-outline-primary {
    color: #4da6ff !important;
    border-color: #4da6ff !important;
  }
  
  .btn-outline-primary:hover {
    background-color: #4da6ff !important;
    color: #ffffff !important;
  }
}

/* ==================== GENERAL STYLES ==================== */
html {
  scroll-behavior: smooth;
}

pre {
  border-radius: 5px;
  font-size: 0.85em;
  background-color: var(--pre-bg);
  color: var(--pre-text);
  padding: 1rem;
}

code {
  background-color: var(--code-bg);
  color: var(--code-text);
  padding: 0.2rem 0.4rem;
  border-radius: 3px;
}

.row .card {
  height: 100%;
}
</style>

<script>
// Initialize Bootstrap tooltips
document.addEventListener('DOMContentLoaded', function() {
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});
</script>
{% endblock %}