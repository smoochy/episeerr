{% extends "base.html" %}

{% block title %}Episeerr - Pending Items{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Instructions Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-info-circle me-2"></i>How Episeerr Works</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6><i class="fas fa-tag me-1 text-primary"></i>Episode Selection Tag</h6>
                            <p class="small mb-3">Add the <code>episeerr_select</code> tag to any series in Sonarr. When the series is added, it will appear here for season/episode selection.</p>
                            
                            <h6><i class="fas fa-cog me-1 text-success"></i>Default Rule Tag</h6>
                            <p class="small mb-0">Add the <code>episeerr_default</code> tag to automatically process series with your default rule settings.</p>
                        </div>
                        <div class="col-md-6">
                            <h6><i class="fas fa-flow-chart me-1 text-info"></i>Process Flow</h6>
                            <ol class="small mb-0">
                                <li>Add series to Sonarr with <code>episeerr_select</code> tag</li>
                                <li>Series appears in pending requests below</li>
                                <li>Click "Select Seasons" to choose which seasons</li>
                                <li>Then select specific episodes within those seasons</li>
                                <li>Episodes are monitored and searched automatically</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Pending Requests Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5><i class="fas fa-tasks me-2"></i>Pending Season/Episode Selections</h5>
                    <button class="btn btn-sm btn-outline-light" onclick="refreshRequests()">
                        <i class="fas fa-sync-alt me-1"></i>Refresh
                    </button>
                </div>
                <div class="card-body">
                    <div id="requests-container">
                        <div class="text-center py-4" id="loading-indicator">
                            <div class="spinner-border text-primary me-2" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            Loading pending requests...
                        </div>
                        
                        <div id="no-requests" style="display: none;">
                            <div class="text-center py-4 text-muted">
                                <i class="fas fa-check-circle fa-3x mb-3 text-success"></i>
                                <h6>No Pending Requests</h6>
                                <p class="small">Add the <code>episeerr_select</code> tag to a series in Sonarr to see requests here.</p>
                            </div>
                        </div>
                        
                        <div id="requests-table-container" style="display: none;">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Series</th>
                                            <th>Created</th>
                                            <th class="text-center">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="pending-requests-table">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div id="error-message" style="display: none;">
                            <div class="alert alert-danger">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                <span id="error-text"></span>
                                <button class="btn btn-sm btn-outline-danger ms-2" onclick="refreshRequests()">
                                    Try Again
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Pending Deletions Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5><i class="fas fa-trash-alt me-2"></i>Pending Deletions</h5>
                    <a href="{{ url_for('view_pending_deletions') }}" class="btn btn-sm btn-outline-light">
                        <i class="fas fa-arrow-right me-1"></i>View All
                    </a>
                </div>
                <div class="card-body">
                    {% if deletions and deletions.total_episodes > 0 %}
                        <div class="alert alert-warning">
                            <strong>{{ deletions.total_episodes }} episode(s)</strong> pending deletion approval
                            ({{ deletions.total_series }} series, {{ deletions.total_size_gb }} GB)
                        </div>
                        <a href="{{ url_for('view_pending_deletions') }}" class="btn btn-warning">
                            <i class="fas fa-eye me-1"></i>Review Pending Deletions
                        </a>
                    {% else %}
                        <div class="text-center py-3 text-muted">
                            <i class="fas fa-check-circle fa-2x mb-2 text-success"></i>
                            <p class="mb-0">No pending deletions</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Load pending requests on page load
document.addEventListener('DOMContentLoaded', function() {
    loadPendingRequests();
});

function refreshRequests() {
    loadPendingRequests();
}

function loadPendingRequests() {
    // Show loading state
    document.getElementById('loading-indicator').style.display = 'block';
    document.getElementById('no-requests').style.display = 'none';
    document.getElementById('requests-table-container').style.display = 'none';
    document.getElementById('error-message').style.display = 'none';
    
    fetch('/api/pending-requests', {
        method: 'GET'
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById('loading-indicator').style.display = 'none';
        
        if (data.success) {
            if (data.requests.length === 0) {
                document.getElementById('no-requests').style.display = 'block';
            } else {
                document.getElementById('requests-table-container').style.display = 'block';
                const tbody = document.getElementById('pending-requests-table');
                tbody.innerHTML = '';
                
                data.requests.forEach(req => {
                    const createdAt = new Date(req.created_at * 1000).toLocaleString();
                    
                    // Determine which button to show based on request state
                    let actionButton = '';
                    if (req.needs_season_selection) {
                        actionButton = `<a href="/select-seasons/${req.tmdb_id}" class="btn btn-primary btn-sm">
                                        <i class="fas fa-calendar me-1"></i>Select Seasons
                                    </a>`;
                    } else {
                        actionButton = `<a href="/select-episodes/${req.series_id}" class="btn btn-primary btn-sm">
                                        <i class="fas fa-play me-1"></i>Select Episodes
                                    </a>`;
                    }
                    
                    const row = document.createElement('tr');
                    row.setAttribute('data-request-id', req.id);
                    row.innerHTML = `
                        <td>
                            <div class="fw-bold">${req.title}</div>
                            <small class="text-muted">
                                ${req.tmdb_id ? `TMDB ID: ${req.tmdb_id}` : `Series ID: ${req.series_id}`}
                            </small>
                        </td>
                        <td>
                            <div>${createdAt}</div>
                            <small class="text-muted">${getTimeAgo(req.created_at)}</small>
                        </td>
                        <td class="text-center">
                            <div class="btn-group" role="group">
                                ${actionButton}
                                <button class="btn btn-danger btn-sm delete-request" data-request-id="${req.id}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
                
                // Bind delete button events
                document.querySelectorAll('.delete-request').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const requestId = this.getAttribute('data-request-id');
                        const seriesTitle = this.closest('tr').querySelector('.fw-bold').textContent;
                        
                        if (confirm(`Are you sure you want to delete the request for "${seriesTitle}"?`)) {
                            this.disabled = true;
                            this.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                            
                            fetch(`/api/delete-request/${requestId}`, {
                                method: 'POST'
                            })
                            .then(response => response.json())
                            .then(response => {
                                if (response.status === 'success') {
                                    const row = document.querySelector(`tr[data-request-id="${requestId}"]`);
                                    row.style.transition = 'opacity 0.3s';
                                    row.style.opacity = '0';
                                    setTimeout(() => {
                                        row.remove();
                                        // Check if table is now empty
                                        if (document.querySelectorAll('#pending-requests-table tr').length === 0) {
                                            document.getElementById('requests-table-container').style.display = 'none';
                                            document.getElementById('no-requests').style.display = 'block';
                                        }
                                    }, 300);
                                } else {
                                    showError('Error deleting request: ' + response.message);
                                    this.disabled = false;
                                    this.innerHTML = '<i class="fas fa-trash"></i>';
                                }
                            })
                            .catch(error => {
                                console.error('Delete request failed:', error);
                                showError('Error deleting request. Please try again.');
                                this.disabled = false;
                                this.innerHTML = '<i class="fas fa-trash"></i>';
                            });
                        }
                    });
                });
            }
        } else {
            showError(data.error || 'Unknown error occurred');
        }
    })
    .catch(error => {
        document.getElementById('loading-indicator').style.display = 'none';
        console.error('Failed to load pending requests:', error);
        showError('Failed to load pending requests. Please check your connection.');
    });
}

function showError(message) {
    document.getElementById('error-text').textContent = message;
    document.getElementById('error-message').style.display = 'block';
}

function getTimeAgo(timestamp) {
    const now = Math.floor(Date.now() / 1000);
    const diff = now - timestamp;
    
    if (diff < 60) return 'Just now';
    if (diff < 3600) return Math.floor(diff / 60) + ' minutes ago';
    if (diff < 86400) return Math.floor(diff / 3600) + ' hours ago';
    return Math.floor(diff / 86400) + ' days ago';
}
</script>
{% endblock %}
