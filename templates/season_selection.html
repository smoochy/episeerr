<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <title>Select - {{ show.name }}</title>
    <style>
        body {
            background-color: #343a40;
            color: #f8f9fa;
            padding-bottom: 70px; /* Space for bottom buttons */
        }
        .show-header {
            display: flex;
            margin-bottom: 15px;
        }
        .show-poster {
            width: 120px;
            border-radius: 8px;
            margin-right: 15px;
        }
        .show-info {
            flex: 1;
        }
        .season-list {
            margin-bottom: 20px;
        }
        .season-item {
            display: flex;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 5px;
            background-color: #495057;
            align-items: center;
        }
        .season-number {
            width: 100px;
            font-weight: bold;
            color: #f8f9fa;
        }
        .season-info {
            flex: 1;
            color: #f8f9fa;
        }
        .season-check {
            transform: scale(1.2);
            margin-left: 10px;
        }
        .bottom-actions {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 15px;
            background: rgba(0,0,0,0.8);
            display: flex;
            justify-content: space-between;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.3);
        }
        .container {
            max-width: 800px;
            margin-top: 20px;
        }
        .bottom-actions {
           position: fixed;
           bottom: 0;
           left: 0;
           right: 0;
           padding: 10px;
           background: rgba(0,0,0,0.9);
           display: flex;
           flex-direction: column;
           gap: 10px;
           box-shadow: 0 -2px 10px rgba(0,0,0,0.3);
        }
    
        .button-row {
            display: flex;
            gap: 8px;
            justify-content: space-between;
        }
        
        .bottom-actions .btn {
            flex: 1;
            padding: 12px 8px;
            font-size: 14px;
            min-height: 44px;
        }
        
        .bottom-actions .btn-primary {
            font-weight: bold;
        }
        
        /* Mobile specific adjustments */
        @media (max-width: 480px) {
            .bottom-actions {
                padding: 8px;
            }
            
            .bottom-actions .btn {
                padding: 10px 6px;
                font-size: 13px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="show-header">
            <img src="{{ show.posterUrl }}" alt="{{ show.name }}" class="show-poster">
            <div class="show-info">
                <h3>{{ show.name }}</h3>
                <p>{{ show.overview[:150] }}{% if show.overview|length > 150 %}...{% endif %}</p>
            </div>
        </div>
        
        <h5>Select Seasons</h5>
        
        <!-- Rule Assignment -->
        <div style="background: #495057; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
            <h6 style="margin-bottom: 10px;">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16" style="margin-right: 6px;">
                    <path d="M9.405 1.05c-.413-1.4-2.397-1.4-2.81 0l-.1.34a1.464 1.464 0 0 1-2.105.872l-.31-.17c-1.283-.698-2.686.705-1.987 1.987l.169.311c.446.82.023 1.841-.872 2.105l-.34.1c-1.4.413-1.4 2.397 0 2.81l.34.1a1.464 1.464 0 0 1 .872 2.105l-.17.31c-.698 1.283.705 2.686 1.987 1.987l.311-.169a1.464 1.464 0 0 1 2.105.872l.1.34c.413 1.4 2.397 1.4 2.81 0l.1-.34a1.464 1.464 0 0 1 2.105-.872l.31.17c1.283.698 2.686-.705 1.987-1.987l-.169-.311a1.464 1.464 0 0 1 .872-2.105l.34-.1c1.4-.413 1.4-2.397 0-2.81l-.34-.1a1.464 1.464 0 0 1-.872-2.105l.17-.31c.698-1.283-.705-2.686-1.987-1.987l-.311.169a1.464 1.464 0 0 1-2.105-.872l-.1-.34z"/>
                    <circle cx="8" cy="8" r="3"/>
                </svg>
                Assign Rule
            </h6>
            <p style="font-size: 13px; color: #adb5bd; margin-bottom: 10px;">
                Choose a rule to auto-manage this show, or pick episodes manually below.
            </p>
            <form action="/api/apply-rule-to-selection" method="POST">
                <input type="hidden" name="tmdb_id" value="{{ tmdb_id }}">
                <div style="display: flex; gap: 8px; align-items: center;">
                    <select name="rule_name" id="rule-select" class="form-control form-control-sm" style="background: #343a40; color: #f8f9fa; border-color: #6c757d; flex: 1;">
                        {% if rules %}
                            {% for rule in rules %}
                            <option value="{{ rule.name }}"
                                {% if current_rule and rule.name == current_rule %}selected
                                {% elif not current_rule and rule.is_default %}selected
                                {% endif %}>
                                {{ rule.name }}{% if rule.is_default %} (default){% endif %} — {{ rule.description }}
                            </option>
                            {% endfor %}
                        {% else %}
                            <option value="" disabled>No rules configured</option>
                        {% endif %}
                    </select>
                    <button type="submit" class="btn btn-success btn-sm" style="white-space: nowrap;" {% if not rules %}disabled{% endif %}>
                        Apply Rule
                    </button>
                </div>
            </form>
            <div style="border-top: 1px solid rgba(255,255,255,0.1); margin-top: 12px; padding-top: 10px;">
                <small style="color: #6c757d;">
                    ↓ Or select seasons/episodes below — the rule above will still be assigned for ongoing management
                </small>
            </div>
        </div>
        
        <h6 style="color: #adb5bd; margin-bottom: 15px;">Manual Episode Selection</h6>
        <div class="season-list">
            {% for season in show.seasons %}
                {% if season.seasonNumber > 0 %}  <!-- Skip specials (season 0) -->
                <div class="season-item">
                    <div class="season-number">Season {{ season.seasonNumber }}</div>
                    <div class="season-info">
                        <div>{{ season.episodeCount or '?' }} episodes</div>
                    </div>
                    <input type="checkbox" class="season-check" data-season="{{ season.seasonNumber }}">
                </div>
                {% endif %}
            {% endfor %}
        </div>
        
        <div class="bottom-actions">
    <div class="button-row">
        <button class="btn btn-secondary" onclick="cancelSelection()">Cancel</button>
        <button class="btn btn-info" onclick="selectAll()">Select All</button>
        <button class="btn btn-info" onclick="selectNone()">Clear All</button>
    </div>
    <button class="btn btn-primary" onclick="proceedToEpisodes()">Proceed to Episode Selection</button>
</div>
    </div>

    <script>
    // Select/deselect all seasons
    function selectAll() {
        document.querySelectorAll('.season-check').forEach(check => check.checked = true);
    }
    
    function selectNone() {
        document.querySelectorAll('.season-check').forEach(check => check.checked = false);
    }
    
    function proceedToEpisodes() {
        const selectedSeasons = [];
        
        // Get all checked checkboxes
        document.querySelectorAll('.season-check:checked').forEach(check => {
            selectedSeasons.push(check.dataset.season);
        });
        
        if (selectedSeasons.length === 0) {
            alert('Please select at least one season');
            return;
        }
        
        console.log('Selected seasons:', selectedSeasons);
        
        // Carry the selected rule through to episode selection
        const ruleSelect = document.getElementById('rule-select');
        const selectedRule = ruleSelect ? ruleSelect.value : '';
        
        // Navigate to episode selection with the selected seasons and rule
        const seasonsParam = selectedSeasons.join(',');
        let url = `/select-episodes/{{ tmdb_id }}?step=episode&seasons=${seasonsParam}`;
        if (selectedRule) {
            url += `&rule=${encodeURIComponent(selectedRule)}`;
        }
        window.location.href = url;
    }
    
    function cancelSelection() {
        const requestId = '{{ request_id }}';
        if (requestId) {
            fetch(`/api/delete-request/${requestId}`, { method: 'POST' })
                .finally(() => window.history.back());
        } else {
            window.history.back();
        }
    }

    // Add click handlers when page loads
    document.addEventListener('DOMContentLoaded', function() {
        // Make sure all season checkboxes have the right data attributes
        const seasonItems = document.querySelectorAll('.season-item');
        seasonItems.forEach(item => {
            const seasonText = item.querySelector('.season-number').textContent;
            const seasonNumber = seasonText.match(/\d+/)[0]; // Extract number from "Season 1"
            const checkbox = item.querySelector('.season-check');
            if (checkbox) {
                checkbox.dataset.season = seasonNumber;
            }
        });
        
        console.log('Season selection page loaded');
    });
</script>
</body>
</html>